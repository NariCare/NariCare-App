<ion-header [translucent]="true">
  <ion-toolbar>
    <ion-buttons slot="start">
      <ion-button (click)="backToGroupList()" class="back-to-groups-button">
        <ion-icon name="arrow-back" slot="start"></ion-icon>
        Back to Groups
      </ion-button>
    </ion-buttons>
    <ion-title>{{ selectedRoom?.name || 'Mom-to-Mom Chat' }}</ion-title>
    
    <!-- Connection Status -->
    <ion-buttons slot="end">
      <ion-chip [color]="getConnectionStatusColor()" size="small">
        <ion-icon [name]="isConnected ? 'wifi' : 'wifi-off'" slot="start"></ion-icon>
        {{ getConnectionStatusText() }}
      </ion-chip>
      <ion-button fill="clear" (click)="retryConnection()" *ngIf="!isConnected">
        <ion-icon name="refresh" slot="icon-only"></ion-icon>
      </ion-button>
    </ion-buttons>
  </ion-toolbar>
</ion-header>

<ion-content [fullscreen]="true">
  <div class="chat-room-main">
    <!-- WebSocket Chat Messages -->
    <div class="chat-room-container" *ngIf="isConnected && socketMessages.length > 0">
      <div class="websocket-messages-wrapper" #groupMessagesContainer (scroll)="onScrollChat($event)">
        <div class="message-list">
          <!-- WebSocket Messages -->
          <div class="message-container" *ngFor="let message of socketMessages; trackBy: trackByMessageId">
            <div class="message" 
                 [class.own-message]="isOwnMessage(message)"
                 [class.other-message]="!isOwnMessage(message)">
              <div class="message-header" *ngIf="!isOwnMessage(message)">
                <span class="sender-name">{{ message.senderName }}</span>
                <ion-chip size="small" color="primary" *ngIf="message.senderRole === 'expert'">
                  <ion-icon name="star" slot="start"></ion-icon>
                  Expert
                </ion-chip>
              </div>
              <div class="message-content">
                {{ message.message }}
              </div>
              <div class="message-time">
                {{ getSocketMessageTime(message.timestamp) }}
              </div>
            </div>
          </div>
        </div>
      </div>
      
      <!-- Sticky Typing Indicator for WebSocket Chat -->
      <div class="sticky-typing-indicator" *ngIf="typingUsers.length > 0">
        <div class="typing-indicator">
          <div class="typing-animation">
            <span></span>
            <span></span>
            <span></span>
          </div>
          <span class="typing-text">{{ getTypingUsersText() }}</span>
        </div>
      </div>
    </div>

    <!-- Empty State for WebSocket Chat -->
    <div class="chat-room-container empty-chat-container" *ngIf="isConnected && socketMessages.length === 0">
      <div class="empty-messages-wrapper">
        <div class="empty-state">
          <div class="empty-state-icon">
            <ion-icon name="chatbubbles-outline"></ion-icon>
          </div>
          <h3>Start the conversation!</h3>
          <p>Be the first to share something with the group</p>
        </div>
      </div>
    </div>

    <!-- Fallback to Legacy Chat -->
    <div class="chat-room-container" *ngIf="!isConnected && selectedRoom">
      <!-- Chat Room Header -->
      <div class="chat-room-header">
        <div class="room-info">
          <div class="room-icon">
            <ion-icon name="people"></ion-icon>
          </div>
          <div class="room-details">
            <h3>{{ selectedRoom.name }}</h3>
            <p>{{ selectedRoom.description }}</p>
            <div class="room-stats">
              <span class="participant-count">{{ selectedRoom.participants?.length || 0 }} members</span>
              <ion-chip color="success" size="small" *ngIf="selectedRoom.moderators?.length > 0">
                <ion-icon name="shield-checkmark" slot="start"></ion-icon>
                Expert Moderated
              </ion-chip>
            </div>
          </div>
        </div>
      </div>
      
      <!-- Legacy Chat Messages Component -->
      <div class="group-messages-wrapper" #groupMessagesContainer (scroll)="onScrollChat($event)">
        <app-group-chat-messages [room]="selectedRoom"></app-group-chat-messages>
      </div>
    </div>

    <!-- Loading State -->
    <div class="loading-state" *ngIf="!selectedRoom && !isConnected">
      <ion-spinner name="crescent"></ion-spinner>
      <p>Loading chat room...</p>
    </div>
  </div>
    
  <!-- Group Message Input - Fixed at bottom -->
  <div class="group-message-input-container">
    <div class="group-message-input">
      <ion-button 
        fill="clear" 
        size="small"
        (click)="openPhotoInput()"
        class="attachment-button">
        <ion-icon name="image" slot="icon-only"></ion-icon>
      </ion-button>
      <ion-button 
        fill="clear" 
        size="small"
        (click)="openVideoLinkInput()"
        class="attachment-button">
        <ion-icon name="videocam" slot="icon-only"></ion-icon>
      </ion-button>
      <ion-textarea
        [(ngModel)]="groupMessageText"
        placeholder="Type your message to the group..."
        rows="1"
        autoGrow="true"
        maxlength="500"
        (keydown)="onGroupKeyDown($event)"
        (ionInput)="onMessageInput()"
        [disabled]="!isConnected && !selectedRoom"
        class="group-message-textarea">
      </ion-textarea>
      <ion-button 
        fill="clear" 
        (click)="sendGroupMessage()"
        [disabled]="!groupMessageText?.trim()"
        class="group-send-button">
        <ion-icon name="send" slot="icon-only"></ion-icon>
      </ion-button>
    </div>
  </div>
</ion-content>