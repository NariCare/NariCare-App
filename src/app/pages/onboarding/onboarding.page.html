<ion-header [translucent]="true">
  <ion-toolbar>
    <ion-buttons slot="start">
      <ion-button (click)="goBack()">
        <ion-icon name="arrow-back"></ion-icon>
      </ion-button>
    </ion-buttons>
  </ion-toolbar>
</ion-header>

<ion-content class="onboarding-content" [fullscreen]="true">

  <div class="onboarding-container">
    
    <!-- Header with Progress -->
    <div class="header-section">
      <div class="logo-container">
        <ion-icon name="heart" class="logo-icon"></ion-icon>
        <h1 class="app-title">Complete Your Assessment</h1>
      </div>
      
      <!-- Enhanced Progress indicator -->
      <div class="progress-container">
        <div class="progress-bar">
          <div class="progress-fill" [style.width.%]="progress.percentComplete"></div>
        </div>
        <p class="progress-text">Step {{ progress.currentStep }} of {{ progress.totalSteps }}</p>
        <p class="progress-description">{{ getStepTitle(progress.currentStep) }}</p>
      </div>

      <!-- Step Navigation Dots -->
      <div class="step-dots">
        <div 
          *ngFor="let step of [1,2,3,4,5,6,7]" 
          class="step-dot"
          [class.completed]="isStepCompleted(step)"
          [class.current]="progress.currentStep === step"
          [class.accessible]="canNavigateToStep(step)"
          (click)="canNavigateToStep(step) && goToStep(step)">
          <span>{{ step }}</span>
        </div>
      </div>
    </div>

    <!-- Onboarding Form -->
    <form [formGroup]="onboardingForm" class="onboarding-form">

      <!-- Step 1: Personal Information -->
      <div class="form-step" *ngIf="progress.currentStep === 1">
        <h2 class="step-title">Personal Information</h2>
        <p class="step-description">Let's start with some basic information about you</p>
        
        <div class="form-group">
          <ion-item lines="none" class="input-item" [class.error]="isFieldInvalid('email')">
            <ion-icon name="mail-outline" slot="start" class="input-icon"></ion-icon>
            <ion-input
              formControlName="email"
              type="email"
              placeholder="Email Address"
              fill="outline">
            </ion-input>
          </ion-item>
          <div class="error-message" *ngIf="isFieldInvalid('email')">
            {{ getFieldError('email') }}
          </div>
        </div>

        <div class="form-group">
          <ion-item lines="none" class="input-item" [class.error]="isFieldInvalid('fullName')">
            <ion-icon name="person-outline" slot="start" class="input-icon"></ion-icon>
            <ion-input
              formControlName="fullName"
              placeholder="Full Name"
              fill="outline">
            </ion-input>
          </ion-item>
          <div class="error-message" *ngIf="isFieldInvalid('fullName')">
            {{ getFieldError('fullName') }}
          </div>
        </div>

        <div class="form-group">
          <ion-item lines="none" class="input-item" [class.error]="isFieldInvalid('phoneNumber')">
            <ion-icon name="call-outline" slot="start" class="input-icon"></ion-icon>
            <ion-input
              formControlName="phoneNumber"
              type="tel"
              placeholder="Phone Number"
              fill="outline">
            </ion-input>
          </ion-item>
          <div class="error-message" *ngIf="isFieldInvalid('phoneNumber')">
            {{ getFieldError('phoneNumber') }}
          </div>
        </div>

        <div class="form-group">
          <label class="input-label">Employment Status</label>
          <div class="horizontal-chip-selection">
            <ion-chip 
              *ngFor="let option of options.employmentStatus"
              [class.selected]="isValueSelected('employmentStatus', option.value)"
              (click)="selectSingleValue('employmentStatus', option.value)"
              class="selection-chip">
              <ion-icon 
                *ngIf="isValueSelected('employmentStatus', option.value)" 
                name="checkmark" 
                class="chip-selected-icon">
              </ion-icon>
              {{ option.label }}
            </ion-chip>
          </div>
        </div>

        <div class="form-group">
          <label class="input-label">Languages Spoken (Select all that apply)</label>
          <div class="chip-options">
            <ion-chip 
              *ngFor="let language of options.languages"
              [class.selected]="isValueSelected('languagesSpoken', language)"
              (click)="toggleArrayValue('languagesSpoken', language)">
              {{ language }}
            </ion-chip>
          </div>
        </div>

        <ion-button expand="block" (click)="nextStep()" class="next-button">
          Continue
        </ion-button>
      </div>

      <!-- Step 2: Pregnancy & Birth Information -->
      <div class="form-step" *ngIf="progress.currentStep === 2">
        <h2 class="step-title">Pregnancy & Birth Information</h2>
        <p class="step-description">Tell us about your pregnancy or baby</p>
        
        <div class="form-group">
          <label class="input-label">Are you currently...</label>
          <ion-radio-group formControlName="motherType" class="horizontal-radio-group">
            <ion-item lines="none" class="radio-item">
              <ion-radio slot="start" value="pregnant"></ion-radio>
              <ion-label>
                <h3>Pregnant</h3>
              </ion-label>
            </ion-item>
            <ion-item lines="none" class="radio-item">
              <ion-radio slot="start" value="new_mom"></ion-radio>
              <ion-label>
                <h3>New Mother</h3>
              </ion-label>
            </ion-item>
          </ion-radio-group>
        </div>

        <div class="form-group" *ngIf="shouldShowField('dueDate')">
          <ion-item lines="none" class="input-item">
            <ion-icon name="calendar-outline" slot="start" class="input-icon"></ion-icon>
            <ion-datetime-button datetime="dueDate"></ion-datetime-button>
          </ion-item>
          <ion-modal [keepContentsMounted]="true">
            <ng-template>
              <ion-datetime 
                id="dueDate" 
                formControlName="dueDate"
                presentation="date"
                [min]="currentDate"
                [max]="maxDate"
                showDefaultButtons="true">
              </ion-datetime>
            </ng-template>
          </ion-modal>
        </div>

        <div class="form-group">
          <label class="input-label">Is this your first child?</label>
          <ion-radio-group formControlName="isFirstChild" class="horizontal-radio-group">
            <ion-item lines="none" class="radio-item">
              <ion-radio slot="start" [value]="true"></ion-radio>
              <ion-label>Yes</ion-label>
            </ion-item>
            <ion-item lines="none" class="radio-item">
              <ion-radio slot="start" [value]="false"></ion-radio>
              <ion-label>No</ion-label>
            </ion-item>
          </ion-radio-group>
        </div>

        <!-- Baby Information for New Mothers -->
        <div class="baby-info-section" *ngIf="shouldShowField('babyInfo')">
          <div class="babies-header">
            <h3 class="subsection-title">Baby Information</h3>
            <div class="baby-action-buttons">
              <ion-button 
                fill="outline" 
                size="small" 
                (click)="addBaby()" 
                class="add-baby-button">
                <ion-icon name="add" slot="start"></ion-icon>
                Add New Baby
              </ion-button>
            </div>
          </div>

          <!-- Existing Babies Selection -->
          <div *ngIf="existingBabies.length > 0" class="existing-babies-section">
            <h4 class="existing-babies-title">Or select from your existing babies:</h4>
            <div class="existing-babies-grid">
              <div 
                *ngFor="let baby of existingBabies" 
                class="existing-baby-card"
                (click)="selectExistingBaby(baby)">
                <div class="baby-avatar">
                  <img [src]="baby.gender === 'female' ? 'assets/Baby girl.svg' : 'assets/Baby boy.svg'" 
                       [alt]="baby.gender === 'female' ? 'Baby girl' : 'Baby boy'" 
                       class="baby-icon">
                </div>
                <div class="baby-info">
                  <h5 class="baby-name">{{ baby.name }}</h5>
                  <p class="baby-age">{{ calculateBabyAge(baby.dateOfBirth || baby.date_of_birth) }}</p>
                </div>
                <ion-icon name="add-circle" class="add-icon"></ion-icon>
              </div>
            </div>
          </div>
          
          <!-- Multiple babies forms -->
          <div formArrayName="babies">
            <div 
              *ngFor="let baby of babiesFormArray.controls; let i = index" 
              [formGroupName]="i" 
              class="baby-form-container">
              
              <div class="baby-form-header">
                <h4>{{ getBabyTitle(i) }}</h4>
                <ion-button 
                  *ngIf="babiesFormArray.length > 1" 
                  fill="clear" 
                  color="danger" 
                  size="small" 
                  (click)="removeBaby(i)">
                  <ion-icon name="trash" slot="icon-only"></ion-icon>
                </ion-button>
              </div>
              
              <div class="form-group">
                <ion-item lines="none" class="input-item">
                  <ion-icon name="heart-outline" slot="start" class="input-icon"></ion-icon>
                  <ion-input
                    formControlName="name"
                    placeholder="Baby's Name"
                    fill="outline">
                  </ion-input>
                </ion-item>
              </div>

              <div class="form-group">
                <label class="input-label">Baby's Gender</label>
                <ion-radio-group formControlName="gender" class="horizontal-radio-group">
                  <ion-item lines="none" class="radio-item">
                    <ion-radio slot="start" value="male"></ion-radio>
                    <ion-label>Boy</ion-label>
                  </ion-item>
                  <ion-item lines="none" class="radio-item">
                    <ion-radio slot="start" value="female"></ion-radio>
                    <ion-label>Girl</ion-label>
                  </ion-item>
                </ion-radio-group>
              </div>

              <div class="form-group">
                <label class="input-label">Date of Birth</label>
                <ion-item lines="none" class="input-item">
                  <ion-icon name="calendar-outline" slot="start" class="input-icon"></ion-icon>
                  <ion-datetime-button [datetime]="'birthDate' + i"></ion-datetime-button>
                </ion-item>
                <ion-modal [keepContentsMounted]="true">
                  <ng-template>
                    <ion-datetime 
                      [id]="'birthDate' + i" 
                      formControlName="dateOfBirth"
                      presentation="date"
                      [max]="currentDate"
                      [min]="minBirthDate"
                      showDefaultButtons="true">
                    </ion-datetime>
                  </ng-template>
                </ion-modal>
              </div>

              <div class="form-row">
                <div class="form-group half-width">
                  <ion-item lines="none" class="input-item">
                    <ion-input
                      formControlName="birthWeight"
                      type="number"
                      placeholder="Birth Weight (kg)"
                      step="0.1"
                      min="0.5"
                      max="8"
                      fill="outline">
                    </ion-input>
                  </ion-item>
                </div>
                
                <div class="form-group half-width">
                  <ion-item lines="none" class="input-item">
                    <ion-input
                      formControlName="birthHeight"
                      type="number"
                      placeholder="Birth Height (cm)"
                      step="0.1"
                      min="30"
                      max="70"
                      fill="outline">
                    </ion-input>
                  </ion-item>
                </div>
              </div>

              <div class="form-group">
                <label class="input-label">Type of Delivery</label>
                <div class="horizontal-chip-selection">
                  <ion-chip 
                    *ngFor="let delivery of options.deliveryTypes"
                    [class.selected]="baby.get('deliveryType')?.value === delivery.value"
                    (click)="baby.get('deliveryType')?.setValue(delivery.value)"
                    class="selection-chip">
                    <ion-icon 
                      *ngIf="baby.get('deliveryType')?.value === delivery.value" 
                      name="checkmark" 
                      class="chip-selected-icon">
                    </ion-icon>
                    {{ delivery.label }}
                  </ion-chip>
                </div>
              </div>

              <div class="form-group">
                <ion-item lines="none" class="input-item">
                  <ion-label position="stacked">Gestational Age (weeks)</ion-label>
                  <ion-input
                    formControlName="gestationalAge"
                    type="number"
                    placeholder="40"
                    min="24"
                    max="45"
                    fill="outline">
                  </ion-input>
                </ion-item>
              </div>

              <div class="form-row">
                <div class="form-group half-width">
                  <ion-item lines="none" class="input-item">
                    <ion-input
                      formControlName="currentWeight"
                      type="number"
                      placeholder="Current Weight (kg)"
                      step="0.1"
                      fill="outline">
                    </ion-input>
                  </ion-item>
                </div>
                
                <div class="form-group half-width">
                  <ion-item lines="none" class="input-item">
                    <ion-datetime-button [datetime]="'weightDate' + i"></ion-datetime-button>
                  </ion-item>
                  <ion-modal [keepContentsMounted]="true">
                    <ng-template>
                      <ion-datetime 
                        [id]="'weightDate' + i" 
                        formControlName="weightCheckDate"
                        presentation="date"
                        [max]="currentDate"
                        showDefaultButtons="true">
                      </ion-datetime>
                    </ng-template>
                  </ion-modal>
                </div>
              </div>

              <!-- Baby-specific Questions -->
              <div class="baby-specific-section">
                <h4 class="subsection-title">{{ baby.get('name')?.value || getBabyTitle(i) }} - Breastfeeding Details</h4>
                
                <!-- Direct breastfeeds -->
                <div class="form-group">
                  <div class="slider-container">
                    <ion-label class="slider-label">Direct breastfeeds in 24 hours</ion-label>
                    <div class="slider-value-display">
                      <span class="slider-value">{{ baby.get('directFeedsPerDay')?.value || 0 }}{{ (baby.get('directFeedsPerDay')?.value || 0) >= 12 ? '+' : '' }}</span>
                    </div>
                    <ion-range
                      formControlName="directFeedsPerDay"
                      min="0"
                      max="12"
                      step="1"
                      snaps="true"
                      ticks="false"
                      color="primary"
                      class="breastfeed-slider">
                      <ion-label slot="start">0</ion-label>
                      <ion-label slot="end">12+</ion-label>
                    </ion-range>
                  </div>
                </div>

                <!-- Latch Quality -->
                <div class="form-group">
                  <label class="input-label">Latch Quality</label>
                  <div class="horizontal-chip-selection">
                    <ion-chip 
                      [class.selected]="baby.get('latchQuality')?.value === 'deep'"
                      (click)="baby.get('latchQuality')?.setValue('deep')"
                      class="selection-chip">
                      <ion-icon 
                        *ngIf="baby.get('latchQuality')?.value === 'deep'" 
                        name="checkmark" 
                        class="chip-selected-icon">
                      </ion-icon>
                      Deep latch, no pain
                    </ion-chip>
                    <ion-chip 
                      [class.selected]="baby.get('latchQuality')?.value === 'shallow'"
                      (click)="baby.get('latchQuality')?.setValue('shallow')"
                      class="selection-chip">
                      <ion-icon 
                        *ngIf="baby.get('latchQuality')?.value === 'shallow'" 
                        name="checkmark" 
                        class="chip-selected-icon">
                      </ion-icon>
                      Shallow latch, causes pain
                    </ion-chip>
                  </div>
                </div>

                <!-- Both breasts per feed -->
                <div class="form-group">
                  <label class="input-label">Do you offer both breasts per feeding?</label>
                  <ion-radio-group formControlName="offersBothBreasts" class="horizontal-radio-group">
                    <ion-item lines="none" class="radio-item">
                      <ion-radio slot="start" [value]="true"></ion-radio>
                      <ion-label>Yes</ion-label>
                    </ion-item>
                    <ion-item lines="none" class="radio-item">
                      <ion-radio slot="start" [value]="false"></ion-radio>
                      <ion-label>No</ion-label>
                    </ion-item>
                  </ion-radio-group>
                </div>

                <!-- Time per breast -->
                <div class="form-group">
                  <label class="input-label">Amount of time baby latches on single breast</label>
                  <div class="horizontal-chip-selection">
                    <ion-chip 
                      *ngFor="let time of options.timePerBreast"
                      [class.selected]="baby.get('timePerBreast')?.value === time.value"
                      (click)="baby.get('timePerBreast')?.setValue(time.value)"
                      class="selection-chip">
                      <ion-icon 
                        *ngIf="baby.get('timePerBreast')?.value === time.value" 
                        name="checkmark" 
                        class="chip-selected-icon">
                      </ion-icon>
                      {{ time.label }}
                    </ion-chip>
                  </div>
                </div>

                <!-- Baby's Daily Output -->
                <h4 class="subsection-title">{{ baby.get('name')?.value || getBabyTitle(i) }} - Daily Output</h4>
                
                <!-- Wet diapers -->
                <div class="form-group">
                  <div class="slider-container">
                    <ion-label class="slider-label">Wet diapers (24 hours)</ion-label>
                    <div class="slider-value-display">
                      <span class="slider-value">{{ baby.get('peeCount24h')?.value || 0 }}</span>
                    </div>
                    <ion-range
                      formControlName="peeCount24h"
                      min="0"
                      max="20"
                      step="1"
                      snaps="true"
                      ticks="false"
                      color="primary"
                      class="diaper-slider">
                      <ion-label slot="start">0</ion-label>
                      <ion-label slot="end">20</ion-label>
                    </ion-range>
                  </div>
                </div>

                <!-- Soiled diapers -->
                <div class="form-group">
                  <div class="slider-container">
                    <ion-label class="slider-label">Soiled diapers (24 hours)</ion-label>
                    <div class="slider-value-display">
                      <span class="slider-value">{{ baby.get('poopCount24h')?.value || 0 }}</span>
                    </div>
                    <ion-range
                      formControlName="poopCount24h"
                      min="0"
                      max="15"
                      step="1"
                      snaps="true"
                      ticks="false"
                      color="primary"
                      class="diaper-slider">
                      <ion-label slot="start">0</ion-label>
                      <ion-label slot="end">15</ion-label>
                    </ion-range>
                  </div>
                </div>

                <!-- Medical conditions -->
                <h4 class="subsection-title">{{ baby.get('name')?.value || getBabyTitle(i) }} - Health Information</h4>
                
                <div class="form-group">
                  <ion-item lines="none" class="input-item">
                    <ion-textarea
                      formControlName="medicalConditions"
                      placeholder="Medical conditions (jaundice, tongue ties/lip ties, etc.) or write 'None'"
                      rows="2"
                      fill="outline">
                    </ion-textarea>
                  </ion-item>
                </div>

                <!-- Hospitalization -->
                <div class="form-group">
                  <label class="input-label">Has baby been hospitalized since birth?</label>
                  <ion-radio-group formControlName="hasBeenHospitalized" class="horizontal-radio-group">
                    <ion-item lines="none" class="radio-item">
                      <ion-radio slot="start" [value]="true"></ion-radio>
                      <ion-label>Yes</ion-label>
                    </ion-item>
                    <ion-item lines="none" class="radio-item">
                      <ion-radio slot="start" [value]="false"></ion-radio>
                      <ion-label>No</ion-label>
                    </ion-item>
                  </ion-radio-group>
                </div>

                <!-- Hospitalization reason -->
                <div class="form-group" *ngIf="baby.get('hasBeenHospitalized')?.value === true">
                  <ion-item lines="none" class="input-item">
                    <ion-textarea
                      formControlName="hospitalizationReason"
                      placeholder="Please provide the reason for hospitalization"
                      rows="2"
                      fill="outline">
                    </ion-textarea>
                  </ion-item>
                </div>

                <!-- Formula feeding details (if applicable) -->
                <div *ngIf="shouldShowFormulaQuestions()">
                  <h4 class="subsection-title">{{ baby.get('name')?.value || getBabyTitle(i) }} - Formula Details</h4>
                  
                  <div class="form-group">
                    <div class="slider-container">
                      <label class="slider-label">How many times are you offering formula?</label>
                      <div class="slider-value-display">
                        <span class="slider-value">{{ baby.get('formulaTimesPerDay')?.value || 0 }}{{ (baby.get('formulaTimesPerDay')?.value || 0) >= 8 ? '+' : '' }} times</span>
                      </div>
                      <ion-range
                        formControlName="formulaTimesPerDay"
                        min="0"
                        max="8"
                        step="1"
                        snaps="true"
                        ticks="true"
                        pin="true"
                        class="formula-slider">
                        <ion-label slot="start">0</ion-label>
                        <ion-label slot="end">8+</ion-label>
                      </ion-range>
                    </div>
                  </div>

                  <div class="form-group">
                    <div class="slider-container">
                      <label class="slider-label">How much formula is offered per feed?</label>
                      <div class="slider-value-display">
                        <span class="slider-value">{{ baby.get('formulaAmountPerFeed')?.value || 10 }}{{ (baby.get('formulaAmountPerFeed')?.value || 10) >= 120 ? '+' : '' }}ml</span>
                      </div>
                      <ion-range
                        formControlName="formulaAmountPerFeed"
                        min="10"
                        max="120"
                        step="10"
                        snaps="true"
                        ticks="true"
                        pin="true"
                        class="formula-slider">
                        <ion-label slot="start">10ml</ion-label>
                        <ion-label slot="end">120ml+</ion-label>
                      </ion-range>
                    </div>
                  </div>
                </div>

                <!-- Bottle feeding details (if applicable) -->
                <div *ngIf="shouldShowBottleQuestions()">
                  <h4 class="subsection-title">{{ baby.get('name')?.value || getBabyTitle(i) }} - Bottle Details</h4>
                  
                  <div class="form-group">
                    <label class="input-label">How long does it take to finish the feed using bottle?</label>
                    <div class="horizontal-chip-selection">
                      <ion-chip 
                        *ngFor="let duration of ['5min','10min','15min','20min','25min','30min+','other']"
                        [class.selected]="baby.get('bottleFeedDuration')?.value === duration"
                        (click)="updateBabyFormControl(i, 'bottleFeedDuration', duration)"
                        class="selection-chip">
                        <ion-icon name="checkmark-circle" *ngIf="baby.get('bottleFeedDuration')?.value === duration" class="chip-selected-icon"></ion-icon>
                        {{ duration === '30min+' ? '30min+' : duration === 'other' ? 'Other' : duration }}
                      </ion-chip>
                    </div>
                  </div>

                  <div class="form-group">
                    <ion-item lines="none" class="input-item">
                      <ion-input
                        formControlName="bottleBrand"
                        placeholder="Which bottle brand are you using?"
                        fill="outline">
                      </ion-input>
                    </ion-item>
                  </div>

                  <div class="form-group">
                    <label class="input-label">Are you using paced bottle feeding?</label>
                    <ion-radio-group formControlName="pacedBottleFeeding" class="horizontal-radio-group">
                      <ion-item lines="none" class="radio-item">
                        <ion-radio slot="start" [value]="true"></ion-radio>
                        <ion-label>Yes</ion-label>
                      </ion-item>
                      <ion-item lines="none" class="radio-item">
                        <ion-radio slot="start" [value]="false"></ion-radio>
                        <ion-label>No</ion-label>
                      </ion-item>
                    </ion-radio-group>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <div class="button-row">
          <ion-button fill="outline" (click)="previousStep()" class="back-button">
            Back
          </ion-button>
          <ion-button (click)="nextStep()" class="next-button">
            Continue
          </ion-button>
        </div>
      </div>

      <!-- Step 3: Breastfeeding Details - Only for New Mothers -->
      <div class="form-step" *ngIf="progress.currentStep === 3 && onboardingForm.get('motherType')?.value === 'new_mom'">
        <h2 class="step-title">Breastfeeding Assessment</h2>
        <p class="step-description">Help us understand your breastfeeding experience and current situation</p>
        
        <!-- Form content here -->
        <div class="breastfeeding-form-content">        
        <div class="form-group">
          <label class="input-label">Breastfeeding Experience Level</label>
          <ion-radio-group formControlName="experienceLevel">
            <ion-item *ngFor="let exp of options.experienceLevels" lines="none" class="radio-item">
              <ion-radio slot="start" [value]="exp.value"></ion-radio>
              <ion-label>{{ exp.label }}</ion-label>
            </ion-item>
          </ion-radio-group>
        </div>

        <div class="form-group">
          <label class="input-label">Are you currently breastfeeding?</label>
          <ion-radio-group formControlName="currentlyBreastfeeding" class="horizontal-radio-group">
            <ion-item lines="none" class="radio-item">
              <ion-radio slot="start" [value]="true"></ion-radio>
              <ion-label>Yes</ion-label>
            </ion-item>
            <ion-item lines="none" class="radio-item">
              <ion-radio slot="start" [value]="false"></ion-radio>
              <ion-label>No</ion-label>
            </ion-item>
          </ion-radio-group>
        </div>


        <div class="button-row">
          <ion-button fill="outline" (click)="previousStep()" class="back-button">
            Back
          </ion-button>
          <ion-button (click)="nextStep()" class="next-button">
            Continue
          </ion-button>
        </div>
        </div>
      </div>
      
      <!-- Step 3: Placeholder for Pregnant Mothers -->
      <div class="form-step" *ngIf="progress.currentStep === 3 && onboardingForm.get('motherType')?.value === 'pregnant'">
        <h2 class="step-title">Almost There!</h2>
        <p class="step-description">Since you're expecting, we'll skip the breastfeeding questions for now. You can complete this assessment after your baby arrives.</p>
        
        <div class="pregnancy-info">
          <ion-card class="info-card">
            <ion-card-content>
              <div class="info-content">
                <ion-icon name="heart" color="primary" size="large"></ion-icon>
                <h3>Preparing for Breastfeeding</h3>
                <p>After your baby arrives, NariCare will help you with:</p>
                <ul>
                  <li>Initial latch guidance</li>
                  <li>Milk supply establishment</li>
                  <li>24/7 expert support</li>
                  <li>Growth tracking</li>
                </ul>
              </div>
            </ion-card-content>
          </ion-card>
        </div>
        
        <div class="button-row">
          <ion-button fill="outline" (click)="previousStep()" class="back-button">
            Back
          </ion-button>
          <ion-button (click)="nextStep()" class="next-button">
            Continue
          </ion-button>
        </div>
      </div>

      <!-- Step 4: Medical & Health Information -->
      <div class="form-step" *ngIf="progress.currentStep === 4">
        <h2 class="step-title">Medical & Health History</h2>
        <p class="step-description">This information helps us provide personalized care recommendations</p>
        
        <div class="form-group">
          <label class="input-label">Mother's Medical Conditions (Select all that apply)</label>
          <div class="chip-options">
            <ion-chip 
              *ngFor="let condition of options.motherMedicalConditions"
              [class.selected]="isValueSelected('motherMedicalConditions', condition)"
              (click)="toggleArrayValue('motherMedicalConditions', condition)">
              {{ condition }}
            </ion-chip>
          </div>
        </div>

        <div class="form-group" *ngIf="shouldShowField('motherMedicalConditionsOther')">
          <ion-item lines="none" class="input-item">
            <ion-textarea
              formControlName="motherMedicalConditionsOther"
              placeholder="Please specify other medical conditions"
              rows="2"
              fill="outline">
            </ion-textarea>
          </ion-item>
        </div>

        <div class="form-group">
          <ion-item lines="none" class="input-item">
            <ion-textarea
              formControlName="allergies"
              placeholder="Allergies (or write 'None')"
              rows="2"
              fill="outline">
            </ion-textarea>
          </ion-item>
        </div>

        <div class="form-group">
          <label class="input-label">Do you have any nipple anatomical issues?</label>
          <ion-radio-group formControlName="nippleAnatomicalIssues" class="horizontal-radio-group">
            <ion-item lines="none" class="radio-item">
              <ion-radio slot="start" [value]="true"></ion-radio>
              <ion-label>Yes</ion-label>
            </ion-item>
            <ion-item lines="none" class="radio-item">
              <ion-radio slot="start" [value]="false"></ion-radio>
              <ion-label>No</ion-label>
            </ion-item>
          </ion-radio-group>
        </div>

        <div class="form-group" *ngIf="shouldShowField('nippleIssuesDescription')">
          <ion-item lines="none" class="input-item">
            <ion-textarea
              formControlName="nippleIssuesDescription"
              placeholder="Please describe the nipple anatomical issues"
              rows="2"
              fill="outline">
            </ion-textarea>
          </ion-item>
        </div>

        <!-- Baby Medical Information -->
        <div class="baby-medical-section">
          <h3 class="subsection-title">Baby's Medical Information</h3>
          
          <div class="form-group">
            <ion-item lines="none" class="input-item">
              <ion-textarea
                formControlName="babyMedicalConditions"
                placeholder="Baby's medical conditions (or write 'None')"
                rows="2"
                fill="outline">
              </ion-textarea>
            </ion-item>
          </div>

          <div class="form-group">
            <label class="input-label">Has your baby been hospitalized since birth?</label>
            <ion-radio-group formControlName="babyHospitalized" class="horizontal-radio-group">
              <ion-item lines="none" class="radio-item">
                <ion-radio slot="start" [value]="true"></ion-radio>
                <ion-label>Yes</ion-label>
              </ion-item>
              <ion-item lines="none" class="radio-item">
                <ion-radio slot="start" [value]="false"></ion-radio>
                <ion-label>No</ion-label>
              </ion-item>
            </ion-radio-group>
          </div>

          <div class="form-group" *ngIf="shouldShowField('babyHospitalizationReason')">
            <ion-item lines="none" class="input-item">
              <ion-textarea
                formControlName="babyHospitalizationReason"
                placeholder="Please provide the reason for hospitalization"
                rows="2"
                fill="outline">
              </ion-textarea>
            </ion-item>
          </div>
        </div>

        <div class="button-row">
          <ion-button fill="outline" (click)="previousStep()" class="back-button">
            Back
          </ion-button>
          <ion-button (click)="nextStep()" class="next-button">
            Continue
          </ion-button>
        </div>
      </div>

      <!-- Step 5: Feeding & Pumping -->
      <div class="form-step" *ngIf="progress.currentStep === 5">
        <h2 class="step-title">Feeding Methods</h2>
        <p class="step-description">Tell us about all the feeding methods you use</p>
        
        <!-- Formula Feeding Section -->
        <div class="feeding-section">
          <h3 class="subsection-title">Formula Feeding</h3>
          
          <div class="form-group">
            <label class="input-label">Do you use formula?</label>
            <ion-radio-group formControlName="usesFormula" class="horizontal-radio-group">
              <ion-item lines="none" class="radio-item">
                <ion-radio slot="start" [value]="true"></ion-radio>
                <ion-label>Yes</ion-label>
              </ion-item>
              <ion-item lines="none" class="radio-item">
                <ion-radio slot="start" [value]="false"></ion-radio>
                <ion-label>No</ion-label>
              </ion-item>
            </ion-radio-group>
          </div>

          <div class="conditional-section" *ngIf="shouldShowField('formulaDetails')">
            <div class="form-group">
              <ion-item lines="none" class="input-item">
                <ion-input
                  formControlName="formulaType"
                  placeholder="Formula brand/type"
                  fill="outline">
                </ion-input>
              </ion-item>
            </div>

            <div class="form-row">
              <div class="form-group half-width">
                <ion-item lines="none" class="input-item">
                  <ion-input
                    formControlName="formulaAmountPerFeed"
                    type="number"
                    placeholder="Amount per feed (ml)"
                    fill="outline">
                  </ion-input>
                </ion-item>
              </div>
              
              <div class="form-group half-width">
                <ion-item lines="none" class="input-item">
                  <ion-input
                    formControlName="formulaFeedsPerDay"
                    type="number"
                    placeholder="Feeds per day"
                    min="1"
                    max="12"
                    fill="outline">
                  </ion-input>
                </ion-item>
              </div>
            </div>

            <div class="form-group">
              <ion-item lines="none" class="input-item">
                <ion-textarea
                  formControlName="formulaReason"
                  placeholder="Reason for using formula"
                  rows="2"
                  fill="outline">
                </ion-textarea>
              </ion-item>
            </div>
          </div>
        </div>

        <!-- Bottle Feeding Section -->
        <div class="feeding-section">
          <h3 class="subsection-title">Bottle Feeding</h3>
          
          <div class="form-group">
            <label class="input-label">Do you use bottles?</label>
            <ion-radio-group formControlName="usesBottle" class="horizontal-radio-group">
              <ion-item lines="none" class="radio-item">
                <ion-radio slot="start" [value]="true"></ion-radio>
                <ion-label>Yes</ion-label>
              </ion-item>
              <ion-item lines="none" class="radio-item">
                <ion-radio slot="start" [value]="false"></ion-radio>
                <ion-label>No</ion-label>
              </ion-item>
            </ion-radio-group>
          </div>

          <div class="conditional-section" *ngIf="shouldShowField('bottleDetails')">
            <div class="form-group">
              <ion-item lines="none" class="input-item">
                <ion-input
                  formControlName="bottleType"
                  placeholder="Bottle brand/type"
                  fill="outline">
                </ion-input>
              </ion-item>
            </div>

            <div class="form-row">
              <div class="form-group half-width">
                <ion-item lines="none" class="input-item">
                  <ion-input
                    formControlName="bottleAmountPerFeed"
                    type="number"
                    placeholder="Amount per feed (ml)"
                    fill="outline">
                  </ion-input>
                </ion-item>
              </div>
              
              <div class="form-group half-width">
                <ion-item lines="none" class="input-item">
                  <ion-input
                    formControlName="bottleFeedsPerDay"
                    type="number"
                    placeholder="Feeds per day"
                    min="1"
                    max="12"
                    fill="outline">
                  </ion-input>
                </ion-item>
              </div>
            </div>

            <div class="form-group">
              <label class="input-label">What do you put in bottles?</label>
              <ion-radio-group formControlName="bottleContentType">
                <ion-item lines="none" class="radio-item">
                  <ion-radio slot="start" value="breast_milk"></ion-radio>
                  <ion-label>Expressed breast milk</ion-label>
                </ion-item>
                <ion-item lines="none" class="radio-item">
                  <ion-radio slot="start" value="formula"></ion-radio>
                  <ion-label>Formula</ion-label>
                </ion-item>
                <ion-item lines="none" class="radio-item">
                  <ion-radio slot="start" value="both"></ion-radio>
                  <ion-label>Both breast milk and formula</ion-label>
                </ion-item>
              </ion-radio-group>
            </div>
          </div>
        </div>

        <!-- Pumping Section -->
        <div class="feeding-section">
          <h3 class="subsection-title">Breast Pumping</h3>
          
          <div class="form-group">
            <label class="input-label">Do you own a breast pump?</label>
            <ion-radio-group formControlName="ownsPump" class="horizontal-radio-group">
              <ion-item lines="none" class="radio-item">
                <ion-radio slot="start" [value]="true"></ion-radio>
                <ion-label>Yes</ion-label>
              </ion-item>
              <ion-item lines="none" class="radio-item">
                <ion-radio slot="start" [value]="false"></ion-radio>
                <ion-label>No</ion-label>
              </ion-item>
            </ion-radio-group>
          </div>

          <div class="conditional-section" *ngIf="shouldShowField('pumpingDetails')">
            <div class="form-group">
              <label class="input-label">Type of pump</label>
              <ion-radio-group formControlName="pumpType">
                <ion-item *ngFor="let pump of options.pumpTypes" lines="none" class="radio-item">
                  <ion-radio slot="start" [value]="pump.value"></ion-radio>
                  <ion-label>{{ pump.label }}</ion-label>
                </ion-item>
              </ion-radio-group>
            </div>

            <div class="form-row">
              <div class="form-group half-width">
                <ion-item lines="none" class="input-item">
                  <ion-input
                    formControlName="pumpSessionsPerDay"
                    type="number"
                    placeholder="Sessions per day"
                    min="0"
                    max="10"
                    fill="outline">
                  </ion-input>
                </ion-item>
              </div>
              
              <div class="form-group half-width">
                <ion-item lines="none" class="input-item">
                  <ion-input
                    formControlName="pumpAverageOutput"
                    type="number"
                    placeholder="Average output (ml)"
                    fill="outline">
                  </ion-input>
                </ion-item>
              </div>
            </div>

            <div class="form-group">
              <ion-item lines="none" class="input-item">
                <ion-input
                  formControlName="pumpSessionDuration"
                  type="number"
                  placeholder="Minutes per session"
                  min="5"
                  max="60"
                  fill="outline">
                </ion-input>
              </ion-item>
            </div>

            <div class="form-group">
              <label class="input-label">Storage methods (Select all that apply)</label>
              <div class="chip-options">
                <ion-chip 
                  *ngFor="let method of options.storageMethod"
                  [class.selected]="isValueSelected('storageMethod', method)"
                  (click)="toggleArrayValue('storageMethod', method)">
                  {{ method }}
                </ion-chip>
              </div>
            </div>
          </div>
        </div>

        <!-- Supplements Section -->
        <div class="feeding-section">
          <h3 class="subsection-title">Breastmilk Supplements</h3>
          
          <div class="form-group">
            <label class="input-label">Do you use any breastmilk supplements/additives?</label>
            <ion-radio-group formControlName="usesBreastmilkSupplements" class="horizontal-radio-group">
              <ion-item lines="none" class="radio-item">
                <ion-radio slot="start" [value]="true"></ion-radio>
                <ion-label>Yes</ion-label>
              </ion-item>
              <ion-item lines="none" class="radio-item">
                <ion-radio slot="start" [value]="false"></ion-radio>
                <ion-label>No</ion-label>
              </ion-item>
            </ion-radio-group>
          </div>

          <div class="form-group" *ngIf="shouldShowField('supplementsDetails')">
            <ion-item lines="none" class="input-item">
              <ion-textarea
                formControlName="supplementsDetails"
                placeholder="Please describe the supplements/additives used"
                rows="2"
                fill="outline">
              </ion-textarea>
            </ion-item>
          </div>
        </div>

        <div class="button-row">
          <ion-button fill="outline" (click)="previousStep()" class="back-button">
            Back
          </ion-button>
          <ion-button (click)="nextStep()" class="next-button">
            Continue
          </ion-button>
        </div>
      </div>

      <!-- Step 6: Support System & Demographics -->
      <div class="form-step" *ngIf="progress.currentStep === 6">
        <h2 class="step-title">Support System & Background</h2>
        <p class="step-description">This helps us understand your support network and background</p>
        
        <div class="form-group">
          <ion-item lines="none" class="input-item" [class.error]="isFieldInvalid('currentSupportSystem')">
            <ion-textarea
              formControlName="currentSupportSystem"
              placeholder="Describe your current support system (family, friends, partners, etc.)"
              rows="3"
              fill="outline">
            </ion-textarea>
          </ion-item>
          <div class="error-message" *ngIf="isFieldInvalid('currentSupportSystem')">
            {{ getFieldError('currentSupportSystem') }}
          </div>
        </div>

        <div class="form-group">
          <label class="input-label">Family Structure</label>
          <div class="horizontal-chip-selection">
            <ion-chip 
              *ngFor="let structure of options.familyStructure"
              [class.selected]="isValueSelected('familyStructure', structure.value)"
              (click)="selectSingleValue('familyStructure', structure.value)"
              class="selection-chip">
              <ion-icon name="checkmark-circle" class="chip-selected-icon" *ngIf="isValueSelected('familyStructure', structure.value)"></ion-icon>
              {{ structure.label }}
            </ion-chip>
          </div>
        </div>

        <div class="form-group">
          <label class="input-label">Education Level</label>
          <div class="horizontal-chip-selection">
            <ion-chip 
              *ngFor="let education of options.educationLevels"
              [class.selected]="isValueSelected('educationLevel', education.value)"
              (click)="selectSingleValue('educationLevel', education.value)"
              class="selection-chip">
              <ion-icon name="checkmark-circle" class="chip-selected-icon" *ngIf="isValueSelected('educationLevel', education.value)"></ion-icon>
              {{ education.label }}
            </ion-chip>
          </div>
        </div>

        <div class="form-group">
          <label class="input-label">Household Income (Optional)</label>
          <div class="horizontal-chip-selection">
            <ion-chip 
              *ngFor="let income of options.householdIncomes"
              [class.selected]="isValueSelected('householdIncome', income.value)"
              (click)="selectSingleValue('householdIncome', income.value)"
              class="selection-chip">
              <ion-icon 
                *ngIf="isValueSelected('householdIncome', income.value)" 
                name="checkmark" 
                class="chip-selected-icon">
              </ion-icon>
              {{ income.label }}
            </ion-chip>
          </div>
        </div>

        <div class="button-row">
          <ion-button fill="outline" (click)="previousStep()" class="back-button">
            Back
          </ion-button>
          <ion-button (click)="nextStep()" class="next-button">
            Continue
          </ion-button>
        </div>
      </div>

      <!-- Step 7: Preferences & Goals -->
      <div class="form-step" *ngIf="progress.currentStep === 7">
        <h2 class="step-title">Goals & Preferences</h2>
        <p class="step-description">Finally, tell us about your goals and preferences</p>
        
        <div class="form-group">
          <label class="input-label">Current Challenges (Select all that apply)</label>
          <div class="chip-options">
            <ion-chip 
              *ngFor="let challenge of options.currentChallenges"
              [class.selected]="isValueSelected('currentChallenges', challenge)"
              (click)="toggleArrayValue('currentChallenges', challenge)">
              {{ challenge }}
            </ion-chip>
          </div>
        </div>

        <div class="form-group">
          <ion-item lines="none" class="input-item" [class.error]="isFieldInvalid('expectationsFromProgram')">
            <ion-textarea
              formControlName="expectationsFromProgram"
              placeholder="What are your expectations from the NariCare program? What do you hope to achieve?"
              rows="4"
              fill="outline">
            </ion-textarea>
          </ion-item>
          <div class="error-message" *ngIf="isFieldInvalid('expectationsFromProgram')">
            {{ getFieldError('expectationsFromProgram') }}
          </div>
        </div>

        <div class="form-group">
          <ion-item lines="none" class="input-item">
            <ion-textarea
              formControlName="milkSupplyGoals"
              placeholder="Any specific goals for milk supply? (Optional)"
              rows="2"
              fill="outline">
            </ion-textarea>
          </ion-item>
        </div>


        <div class="form-group">
          <label class="input-label">Topics of Interest (Optional)</label>
          <div class="chip-options">
            <ion-chip 
              *ngFor="let topic of options.topicsOfInterest"
              [class.selected]="isValueSelected('topicsOfInterest', topic)"
              (click)="toggleArrayValue('topicsOfInterest', topic)">
              {{ topic }}
            </ion-chip>
          </div>
        </div>

        <div class="button-row">
          <ion-button fill="outline" (click)="previousStep()" class="back-button">
            Back
          </ion-button>
          <ion-button (click)="completeOnboarding()" class="complete-button" [disabled]="!progress.canProceed">
            <ion-icon name="checkmark-circle" slot="start"></ion-icon>
            Complete Assessment
          </ion-button>
        </div>
      </div>
    </form>

    <!-- Progress Summary Footer -->
    <div class="progress-footer" *ngIf="progress.completedSteps > 0">
      <p class="progress-summary">
        {{ progress.completedSteps }} of {{ progress.totalSteps }} sections completed
      </p>
    </div>

  </div>
</ion-content>