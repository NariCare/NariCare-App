<ion-header [translucent]="true">
  <ion-toolbar>
    <ion-buttons slot="start">
      <ion-button (click)="goBack()">
        <ion-icon name="arrow-back"></ion-icon>
      </ion-button>
    </ion-buttons>
  </ion-toolbar>
</ion-header>

<ion-content class="onboarding-content" [fullscreen]="true">

  <div class="onboarding-container">
    
    <!-- Header with Progress -->
    <div class="header-section">
      <div class="logo-container">
        <ion-icon name="heart" class="logo-icon"></ion-icon>
        <h1 class="app-title">Complete Your Assessment</h1>
      </div>
      
      <!-- Enhanced Progress indicator -->
      <div class="progress-container">
        <div class="progress-bar">
          <div class="progress-fill" [style.width.%]="progress.percentComplete"></div>
        </div>
        <p class="progress-text">Step {{ progress.currentStep }} of {{ progress.totalSteps }}</p>
        <p class="progress-description">{{ getStepTitle(progress.currentStep) }}</p>
      </div>

      <!-- Step Navigation Dots -->
      <div class="step-dots">
        <div 
          *ngFor="let step of [1,2,3,4,5]" 
          class="step-dot"
          [class.completed]="isStepCompleted(step)"
          [class.current]="progress.currentStep === step"
          [class.accessible]="canNavigateToStep(step)"
          (click)="canNavigateToStep(step) && goToStep(step)">
          <span>{{ step }}</span>
        </div>
      </div>
    </div>

    <!-- Onboarding Form -->
    <form [formGroup]="onboardingForm" class="onboarding-form">

      <!-- Step 1: Mother's Profile -->
      <div class="form-step" *ngIf="progress.currentStep === 1">
        <h2 class="step-title">{{ (currentUser?.firstName || 'Your') }}'s Info</h2>
        <p class="step-description">Let's start with some basic information about you</p>
        
        <!-- Mother's Age -->
        <div class="form-group">
          <ion-item lines="none" class="input-item" [class.error]="isFieldInvalid('motherAge')">
            <ion-icon name="calendar-outline" slot="start" class="input-icon"></ion-icon>
            <ion-input
              formControlName="motherAge"
              type="number"
              placeholder="Mother's Age"
              min="15"
              max="50"
              fill="outline">
            </ion-input>
          </ion-item>
          <div class="error-message" *ngIf="isFieldInvalid('motherAge')">
            {{ getFieldError('motherAge') }}
          </div>
        </div>

        <!-- City -->
        <div class="form-group">
          <ion-item lines="none" class="input-item" [class.error]="isFieldInvalid('city')">
            <ion-icon name="location-outline" slot="start" class="input-icon"></ion-icon>
            <ion-input
              formControlName="city"
              placeholder="City"
              fill="outline">
            </ion-input>
          </ion-item>
          <div class="error-message" *ngIf="isFieldInvalid('city')">
            {{ getFieldError('city') }}
          </div>
        </div>

        <!-- State -->
        <div class="form-group">
          <label class="input-label">State</label>
          <ion-item lines="none" class="input-item" [class.error]="isFieldInvalid('state')">
            <ion-select formControlName="state" placeholder="Select State" fill="outline">
              <ion-select-option 
                *ngFor="let state of options.indianStates" 
                [value]="state">
                {{ state }}
              </ion-select-option>
            </ion-select>
          </ion-item>
          <div class="error-message" *ngIf="isFieldInvalid('state')">
            {{ getFieldError('state') }}
          </div>
        </div>

        <div class="form-group">
          <label class="input-label">Employment Status</label>
          <div class="horizontal-chip-selection">
            <ion-chip 
              *ngFor="let option of options.employmentStatus"
              [class.selected]="isValueSelected('employmentStatus', option.value)"
              (click)="selectSingleValue('employmentStatus', option.value)"
              class="selection-chip">
              <ion-icon 
                *ngIf="isValueSelected('employmentStatus', option.value)" 
                name="checkmark" 
                class="chip-selected-icon">
              </ion-icon>
              {{ option.label }}
            </ion-chip>
          </div>
        </div>

        <div class="form-group">
          <label class="input-label">Languages Spoken (Select all that apply)</label>
          <div class="chip-options">
            <ion-chip 
              *ngFor="let language of options.languages"
              [class.selected]="isValueSelected('languagesSpoken', language)"
              (click)="toggleArrayValue('languagesSpoken', language)">
              {{ language }}
            </ion-chip>
          </div>
        </div>

        <!-- Mother's Medical Conditions -->
        <div class="form-group">
          <label class="input-label">Mother's Medical Conditions (Select all that apply)</label>
          <div class="chip-options">
            <ion-chip 
              *ngFor="let condition of options.motherMedicalConditions"
              [class.selected]="isValueSelected('motherMedicalConditions', condition)"
              (click)="toggleArrayValue('motherMedicalConditions', condition)">
              {{ condition }}
            </ion-chip>
          </div>
          <div class="form-group" *ngIf="shouldShowField('motherMedicalConditionsOther')">
            <ion-item lines="none" class="input-item">
              <ion-input
                formControlName="motherMedicalConditionsOther"
                placeholder="Please specify other conditions"
                fill="outline">
              </ion-input>
            </ion-item>
          </div>
        </div>

        <!-- Allergies -->
        <div class="form-group">
          <ion-item lines="none" class="input-item" [class.error]="isFieldInvalid('allergies')">
            <ion-icon name="warning-outline" slot="start" class="input-icon"></ion-icon>
            <ion-input
              formControlName="allergies"
              placeholder="Allergies (if any)"
              fill="outline">
            </ion-input>
          </ion-item>
          <div class="error-message" *ngIf="isFieldInvalid('allergies')">
            {{ getFieldError('allergies') }}
          </div>
        </div>

        <!-- Nipple Issues -->
        <div class="form-group">
          <label class="input-label">Do you have flat or inverted nipples or any other anatomical condition related to your breasts?</label>
          <ion-radio-group formControlName="hasNippleIssues" class="horizontal-radio-group">
            <ion-item lines="none" class="radio-item">
              <ion-radio slot="start" [value]="true"></ion-radio>
              <ion-label>Yes</ion-label>
            </ion-item>
            <ion-item lines="none" class="radio-item">
              <ion-radio slot="start" [value]="false"></ion-radio>
              <ion-label>No</ion-label>
            </ion-item>
          </ion-radio-group>
          
          <div class="form-group" *ngIf="shouldShowField('nippleIssuesDescription')">
            <ion-item lines="none" class="input-item">
              <ion-textarea
                formControlName="nippleIssuesDescription"
                placeholder="Please describe the anatomical condition"
                rows="3"
                fill="outline">
              </ion-textarea>
            </ion-item>
          </div>
        </div>

        <!-- Is First Child -->
        <div class="form-group">
          <label class="input-label">Is this your first child?</label>
          <ion-radio-group formControlName="isFirstChild" class="horizontal-radio-group">
            <ion-item lines="none" class="radio-item">
              <ion-radio slot="start" [value]="true"></ion-radio>
              <ion-label>Yes</ion-label>
            </ion-item>
            <ion-item lines="none" class="radio-item">
              <ion-radio slot="start" [value]="false"></ion-radio>
              <ion-label>No</ion-label>
            </ion-item>
          </ion-radio-group>
        </div>

        <!-- Breastfeeding Duration -->
        <div class="form-group">
          <label class="input-label">For how long do you want to breastfeed your child?</label>
          <div class="horizontal-chip-selection">
            <ion-chip 
              *ngFor="let option of options.breastfeedingDuration"
              [class.selected]="isValueSelected('breastfeedingDuration', option.value)"
              (click)="selectSingleValue('breastfeedingDuration', option.value)"
              class="selection-chip">
              <ion-icon 
                *ngIf="isValueSelected('breastfeedingDuration', option.value)" 
                name="checkmark" 
                class="chip-selected-icon">
              </ion-icon>
              {{ option.label }}
            </ion-chip>
          </div>
        </div>

        <ion-button expand="block" (click)="nextStep()" class="next-button">
          Continue
        </ion-button>
      </div>

      <!-- Step 2: Pregnancy & Birth Information -->
      <div class="form-step" *ngIf="progress.currentStep === 2">
        <h2 class="step-title">Pregnancy & Birth Information</h2>
        <p class="step-description">Tell us about your pregnancy or baby</p>
        
        <div class="form-group">
          <label class="input-label">Are you currently...</label>
          <ion-radio-group formControlName="motherType" class="horizontal-radio-group">
            <ion-item lines="none" class="radio-item">
              <ion-radio slot="start" value="pregnant"></ion-radio>
              <ion-label>
                <h3>Pregnant</h3>
              </ion-label>
            </ion-item>
            <ion-item lines="none" class="radio-item">
              <ion-radio slot="start" value="new_mom"></ion-radio>
              <ion-label>
                <h3>New Mother</h3>
              </ion-label>
            </ion-item>
          </ion-radio-group>
        </div>

        <div class="form-group" *ngIf="shouldShowField('expectedDueDate')">
          <label class="input-label">Expected Due Date</label>
          <ion-item lines="none" class="input-item">
            <ion-icon name="calendar-outline" slot="start" class="input-icon"></ion-icon>
            <ion-input
              formControlName="expectedDueDate"
              type="date"
              placeholder="Select expected due date">
            </ion-input>
          </ion-item>
        </div>

        <!-- Baby Information for New Mothers -->
        <div class="baby-info-section" *ngIf="shouldShowField('babyInfo')">
          <div class="babies-header">
            <h3 class="subsection-title">Baby Information</h3>
            <p class="twins-helper-text">Add other babies also, if you had twins or triplets</p>
            <div class="baby-action-buttons">
              <ion-button 
                fill="outline" 
                size="small" 
                (click)="addBaby()" 
                class="add-baby-button">
                <ion-icon name="add" slot="start"></ion-icon>
                Add New Baby
              </ion-button>
            </div>
          </div>

          <!-- Existing Babies Selection -->
          <div *ngIf="existingBabies.length > 0" class="existing-babies-section">
            <h4 class="existing-babies-title">Or select from your existing babies:</h4>
            <div class="existing-babies-grid">
              <div 
                *ngFor="let baby of existingBabies" 
                class="existing-baby-card"
                (click)="selectExistingBaby(baby)">
                <div class="baby-avatar">
                  <img [src]="baby.gender === 'female' ? 'assets/Baby girl.svg' : 'assets/Baby boy.svg'" 
                       [alt]="baby.gender === 'female' ? 'Baby girl' : 'Baby boy'" 
                       class="baby-icon">
                </div>
                <div class="baby-info">
                  <h5 class="baby-name">{{ baby.name }}</h5>
                  <p class="baby-age">{{ calculateBabyAge(baby.dateOfBirth || baby.date_of_birth) }}</p>
                </div>
                <ion-icon name="add-circle" class="add-icon"></ion-icon>
              </div>
            </div>
          </div>
          
          <!-- Multiple babies forms -->
          <div formArrayName="babies">
            <div 
              *ngFor="let baby of babiesFormArray.controls; let i = index" 
              [formGroupName]="i" 
              class="baby-form-container">
              
              <div class="baby-form-header">
                <h4>{{ getBabyTitle(i) }}</h4>
                <ion-button 
                  *ngIf="babiesFormArray.length > 1" 
                  fill="clear" 
                  color="danger" 
                  size="small" 
                  (click)="removeBaby(i)">
                  <ion-icon name="trash" slot="icon-only"></ion-icon>
                </ion-button>
              </div>
              
              <div class="form-group">
                <ion-item lines="none" class="input-item">
                  <ion-icon name="heart-outline" slot="start" class="input-icon"></ion-icon>
                  <ion-input
                    formControlName="name"
                    placeholder="Baby's Name"
                    fill="outline">
                  </ion-input>
                </ion-item>
              </div>

              <div class="form-group">
                <label class="input-label">Baby's Gender</label>
                <ion-radio-group formControlName="gender" class="horizontal-radio-group">
                  <ion-item lines="none" class="radio-item">
                    <ion-radio slot="start" value="male"></ion-radio>
                    <ion-label>Boy</ion-label>
                  </ion-item>
                  <ion-item lines="none" class="radio-item">
                    <ion-radio slot="start" value="female"></ion-radio>
                    <ion-label>Girl</ion-label>
                  </ion-item>
                </ion-radio-group>
              </div>

              <div class="form-group">
                <label class="input-label">Date of Birth</label>
                <ion-item lines="none" class="input-item">
                  <ion-icon name="calendar-outline" slot="start" class="input-icon"></ion-icon>
                  <ion-input
                    formControlName="dateOfBirth"
                    type="date"
                    placeholder="Select date of birth">
                  </ion-input>
                </ion-item>
              </div>

              <div class="form-row">
                <div class="form-group half-width">
                  <ion-item lines="none" class="input-item weight-input">
                    <ion-input
                      formControlName="birthWeight"
                      type="number"
                      placeholder="Birth Weight"
                      step="0.1"
                      min="0.5"
                      max="8"
                      fill="outline">
                    </ion-input>
                    <span class="unit-suffix">kg</span>
                  </ion-item>
                </div>
                
                <div class="form-group half-width">
                  <ion-item lines="none" class="input-item height-input">
                    <ion-input
                      formControlName="birthHeight"
                      type="number"
                      placeholder="Birth Height"
                      step="0.1"
                      min="30"
                      max="70"
                      fill="outline">
                    </ion-input>
                    <span class="unit-suffix">cm</span>
                  </ion-item>
                </div>
              </div>

              <div class="form-group">
                <label class="input-label">Type of Delivery</label>
                <div class="horizontal-chip-selection">
                  <ion-chip 
                    *ngFor="let delivery of options.deliveryTypes"
                    [class.selected]="baby.get('deliveryType')?.value === delivery.value"
                    (click)="baby.get('deliveryType')?.setValue(delivery.value)"
                    class="selection-chip">
                    <ion-icon 
                      *ngIf="baby.get('deliveryType')?.value === delivery.value" 
                      name="checkmark" 
                      class="chip-selected-icon">
                    </ion-icon>
                    {{ delivery.label }}
                  </ion-chip>
                </div>
              </div>

              <div class="form-group">
                <ion-item lines="none" class="input-item">
                  <ion-label position="stacked">Gestational Age (weeks)</ion-label>
                  <ion-input
                    formControlName="gestationalAge"
                    type="number"
                    placeholder="40"
                    min="24"
                    max="45"
                    fill="outline">
                  </ion-input>
                </ion-item>
              </div>

              <div class="form-row">
                <div class="form-group half-width">
                  <label class="input-label">Current Weight</label>
                  <ion-item lines="none" class="input-item weight-input">
                    <ion-input
                      formControlName="mostRecentWeight"
                      type="number"
                      step="0.1"
                      fill="outline">
                    </ion-input>
                    <span class="unit-suffix">kg</span>
                  </ion-item>
                </div>
                
                <div class="form-group half-width">
                  <label class="input-label">Date of Weight Check</label>
                  <ion-item lines="none" class="input-item">
                    <ion-icon name="calendar-outline" slot="start" class="input-icon"></ion-icon>
                    <ion-input
                      formControlName="dateOfMostRecentWeightCheck"
                      type="date"
                      placeholder="Select weight check date">
                    </ion-input>
                  </ion-item>
                </div>
              </div>

              <!-- Baby-specific Questions -->
              <div class="baby-specific-section">
                <h4 class="subsection-title">{{ baby.get('name')?.value || getBabyTitle(i) }} - Breastfeeding Details</h4>
                
                <!-- Direct breastfeeds -->
                <div class="form-group">
                  <div class="slider-container">
                    <ion-label class="slider-label">Direct breastfeeds in 24 hours</ion-label>
                    <div class="slider-value-display">
                      <span class="slider-value">{{ baby.get('directBreastfeedsIn24h')?.value || 0 }}{{ (baby.get('directBreastfeedsIn24h')?.value || 0) >= 12 ? '+' : '' }}</span>
                    </div>
                    <ion-range
                      formControlName="directBreastfeedsIn24h"
                      min="0"
                      max="12"
                      step="1"
                      snaps="true"
                      ticks="false"
                      color="primary"
                      class="breastfeed-slider">
                      <ion-label slot="start">0</ion-label>
                      <ion-label slot="end">12+</ion-label>
                    </ion-range>
                  </div>
                </div>

                <!-- Latch Quality -->
                <div class="form-group">
                  <label class="input-label">Latch Quality</label>
                  <div class="horizontal-chip-selection">
                    <ion-chip 
                      [class.selected]="baby.get('latchQuality')?.value === 'deep'"
                      (click)="baby.get('latchQuality')?.setValue('deep')"
                      class="selection-chip">
                      <ion-icon 
                        *ngIf="baby.get('latchQuality')?.value === 'deep'" 
                        name="checkmark" 
                        class="chip-selected-icon">
                      </ion-icon>
                      Deep latch, no pain
                    </ion-chip>
                    <ion-chip 
                      [class.selected]="baby.get('latchQuality')?.value === 'shallow'"
                      (click)="baby.get('latchQuality')?.setValue('shallow')"
                      class="selection-chip">
                      <ion-icon 
                        *ngIf="baby.get('latchQuality')?.value === 'shallow'" 
                        name="checkmark" 
                        class="chip-selected-icon">
                      </ion-icon>
                      Shallow latch, causes pain
                    </ion-chip>
                  </div>
                </div>

                <!-- Both breasts per feed -->
                <div class="form-group">
                  <label class="input-label">Do you offer both breasts per feeding?</label>
                  <ion-radio-group formControlName="offersBothBreastsPerFeeding" class="horizontal-radio-group">
                    <ion-item lines="none" class="radio-item">
                      <ion-radio slot="start" [value]="true"></ion-radio>
                      <ion-label>Yes</ion-label>
                    </ion-item>
                    <ion-item lines="none" class="radio-item">
                      <ion-radio slot="start" [value]="false"></ion-radio>
                      <ion-label>No</ion-label>
                    </ion-item>
                  </ion-radio-group>
                </div>

                <!-- Time per breast -->
                <div class="form-group">
                  <label class="input-label">Amount of time baby latches on single breast</label>
                  <div class="horizontal-chip-selection">
                    <ion-chip 
                      *ngFor="let time of options.timePerBreast"
                      [class.selected]="baby.get('timePerBreast')?.value === time.value"
                      (click)="baby.get('timePerBreast')?.setValue(time.value)"
                      class="selection-chip">
                      <ion-icon 
                        *ngIf="baby.get('timePerBreast')?.value === time.value" 
                        name="checkmark" 
                        class="chip-selected-icon">
                      </ion-icon>
                      {{ time.label }}
                    </ion-chip>
                  </div>
                </div>

                <!-- Baby's Daily Output -->
                <h4 class="subsection-title">{{ baby.get('name')?.value || getBabyTitle(i) }} - Daily Output</h4>
                
                <!-- Wet diapers -->
                <div class="form-group">
                  <div class="slider-container">
                    <ion-label class="slider-label">Wet diapers (24 hours)</ion-label>
                    <div class="slider-value-display">
                      <span class="slider-value">{{ baby.get('wetDiapersIn24h')?.value || 0 }}</span>
                    </div>
                    <ion-range
                      formControlName="wetDiapersIn24h"
                      min="0"
                      max="20"
                      step="1"
                      snaps="true"
                      ticks="false"
                      color="primary"
                      class="diaper-slider">
                      <ion-label slot="start">0</ion-label>
                      <ion-label slot="end">20</ion-label>
                    </ion-range>
                  </div>
                </div>

                <!-- Soiled diapers -->
                <div class="form-group">
                  <div class="slider-container">
                    <ion-label class="slider-label">Dirty diapers (24 hours)</ion-label>
                    <div class="slider-value-display">
                      <span class="slider-value">{{ baby.get('dirtyDiapersIn24h')?.value || 0 }}</span>
                    </div>
                    <ion-range
                      formControlName="dirtyDiapersIn24h"
                      min="0"
                      max="15"
                      step="1"
                      snaps="true"
                      ticks="false"
                      color="primary"
                      class="diaper-slider">
                      <ion-label slot="start">0</ion-label>
                      <ion-label slot="end">15</ion-label>
                    </ion-range>
                  </div>
                </div>

                <!-- Medical conditions -->
                <h4 class="subsection-title">{{ baby.get('name')?.value || getBabyTitle(i) }} - Health Information</h4>
                
                <div class="form-group">
                  <label class="input-label">Medical conditions (select all that apply)</label>
                  <div class="chip-options">
                    <ion-chip 
                      *ngFor="let condition of options.babyMedicalConditions"
                      [class.selected]="isBabyValueSelected(i, 'medicalConditions', condition)"
                      (click)="toggleBabyArrayValue(i, 'medicalConditions', condition)">
                      {{ condition }}
                    </ion-chip>
                  </div>
                  <div class="form-group" *ngIf="isBabyValueSelected(i, 'medicalConditions', 'Other')">
                    <ion-item lines="none" class="input-item">
                      <ion-input
                        formControlName="medicalConditionsOther"
                        placeholder="Please specify other medical conditions"
                        fill="outline">
                      </ion-input>
                    </ion-item>
                  </div>
                </div>

                <!-- Hospitalization -->
                <div class="form-group">
                  <label class="input-label">Has baby been hospitalized since birth?</label>
                  <ion-radio-group formControlName="hasBeenHospitalized" class="horizontal-radio-group">
                    <ion-item lines="none" class="radio-item">
                      <ion-radio slot="start" [value]="true"></ion-radio>
                      <ion-label>Yes</ion-label>
                    </ion-item>
                    <ion-item lines="none" class="radio-item">
                      <ion-radio slot="start" [value]="false"></ion-radio>
                      <ion-label>No</ion-label>
                    </ion-item>
                  </ion-radio-group>
                </div>

                <!-- Hospitalization reason -->
                <div class="form-group" *ngIf="baby.get('hasBeenHospitalized')?.value === true">
                  <ion-item lines="none" class="input-item">
                    <ion-textarea
                      formControlName="hospitalizationReason"
                      placeholder="Please provide the reason for hospitalization"
                      rows="2"
                      fill="outline">
                    </ion-textarea>
                  </ion-item>
                </div>

              </div>
            </div>
          </div>
        </div>

        <div class="button-row">
          <ion-button fill="outline" (click)="previousStep()" class="back-button">
            Back
          </ion-button>
          <ion-button (click)="nextStep()" class="next-button">
            Continue
          </ion-button>
        </div>
      </div>

      <!-- Step 3: Feeding Methods - Only for New Mothers -->
      <div class="form-step" *ngIf="progress.currentStep === 3 && onboardingForm.get('motherType')?.value === 'new_mom'">
        <h2 class="step-title">Feeding Methods</h2>
        <p class="step-description">Tell us about your current feeding practices for each baby</p>
        
        <!-- Formula Feeding Section -->
        <div class="feeding-section">
          <h3 class="subsection-title">Formula Feeding</h3>
          
          <div class="form-group">
            <label class="input-label">Do you use formula?</label>
            <ion-radio-group formControlName="usesFormula" class="horizontal-radio-group">
              <ion-item lines="none" class="radio-item">
                <ion-radio slot="start" [value]="true"></ion-radio>
                <ion-label>Yes</ion-label>
              </ion-item>
              <ion-item lines="none" class="radio-item">
                <ion-radio slot="start" [value]="false"></ion-radio>
                <ion-label>No</ion-label>
              </ion-item>
            </ion-radio-group>
          </div>

          <!-- Per-baby Formula Details - Show only if using formula -->
          <div formArrayName="babies" *ngIf="shouldShowFormulaQuestions()">
            <div 
              *ngFor="let baby of babiesFormArray.controls; let i = index" 
              [formGroupName]="i" 
              class="baby-form-container">
              
              <div class="baby-form-header">
                <h4>{{ baby.get('name')?.value || getBabyTitle(i) }} - Formula Details</h4>
              </div>

              <div class="form-group">
                <label class="input-label">Formula Brand/Type</label>
                <div class="horizontal-chip-selection">
                  <ion-chip 
                    *ngFor="let brand of options.commonFormulaBrands"
                    [class.selected]="baby.get('formulaBrand')?.value === brand"
                    (click)="updateBabyFormControl(i, 'formulaBrand', brand)"
                    class="selection-chip">
                    <ion-icon 
                      *ngIf="baby.get('formulaBrand')?.value === brand" 
                      name="checkmark" 
                      class="chip-selected-icon">
                    </ion-icon>
                    {{ brand }}
                  </ion-chip>
                </div>
                
                <!-- Other Formula Brand Input -->
                <div class="form-group" *ngIf="baby.get('formulaBrand')?.value === 'Other'">
                  <ion-item lines="none" class="input-item">
                    <ion-input
                      formControlName="formulaBrandOther"
                      placeholder="Please specify other formula brand"
                      fill="outline">
                    </ion-input>
                  </ion-item>
                </div>
              </div>

              <div class="form-group">
                <div class="slider-container">
                  <label class="slider-label">How many times are you offering formula?</label>
                  <div class="slider-value-display">
                    <span class="slider-value">{{ baby.get('formulaTimesPerDay')?.value || 0 }}{{ (baby.get('formulaTimesPerDay')?.value || 0) >= 8 ? '+' : '' }} times</span>
                  </div>
                  <ion-range
                    formControlName="formulaTimesPerDay"
                    min="0"
                    max="8"
                    step="1"
                    snaps="true"
                    ticks="true"
                    pin="true"
                    class="formula-slider">
                    <ion-label slot="start">0</ion-label>
                    <ion-label slot="end">8+</ion-label>
                  </ion-range>
                </div>
              </div>

              <div class="form-group">
                <div class="slider-container">
                  <label class="slider-label">How much formula is offered per feed?</label>
                  <div class="slider-value-display">
                    <span class="slider-value">{{ baby.get('formulaAmountPerFeed')?.value || 10 }}{{ (baby.get('formulaAmountPerFeed')?.value || 10) >= 120 ? '+' : '' }}ml</span>
                  </div>
                  <ion-range
                    formControlName="formulaAmountPerFeed"
                    min="10"
                    max="120"
                    step="10"
                    snaps="true"
                    ticks="true"
                    pin="true"
                    class="formula-slider">
                    <ion-label slot="start">10ml</ion-label>
                    <ion-label slot="end">120ml+</ion-label>
                  </ion-range>
                </div>
              </div>

              <div class="form-group">
                <label class="input-label">Reason for using formula</label>
                <div class="horizontal-chip-selection">
                  <ion-chip 
                    *ngFor="let reason of options.formulaReasons"
                    [class.selected]="baby.get('formulaReason')?.value === reason"
                    (click)="updateBabyFormControl(i, 'formulaReason', reason)"
                    class="selection-chip">
                    <ion-icon 
                      *ngIf="baby.get('formulaReason')?.value === reason" 
                      name="checkmark" 
                      class="chip-selected-icon">
                    </ion-icon>
                    {{ reason }}
                  </ion-chip>
                </div>
                
                <!-- Other Formula Reason Input -->
                <div class="form-group" *ngIf="baby.get('formulaReason')?.value === 'Other'">
                  <ion-item lines="none" class="input-item">
                    <ion-input
                      formControlName="formulaReasonOther"
                      placeholder="Please specify other reason for formula"
                      fill="outline">
                    </ion-input>
                  </ion-item>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Bottle Feeding Section -->
        <div class="feeding-section">
          <h3 class="subsection-title">Bottle Feeding</h3>
          
          <div class="form-group">
            <label class="input-label">Do you use bottles?</label>
            <ion-radio-group formControlName="usesBottles" class="horizontal-radio-group">
              <ion-item lines="none" class="radio-item">
                <ion-radio slot="start" [value]="true"></ion-radio>
                <ion-label>Yes</ion-label>
              </ion-item>
              <ion-item lines="none" class="radio-item">
                <ion-radio slot="start" [value]="false"></ion-radio>
                <ion-label>No</ion-label>
              </ion-item>
            </ion-radio-group>
          </div>

          <!-- General Bottle Details - Show only if using bottles -->
          <div class="conditional-section" *ngIf="shouldShowBottleQuestions()">
            <div class="form-group">
              <label class="input-label">Bottle Brand/Type</label>
              <div class="horizontal-chip-selection">
                <ion-chip 
                  *ngFor="let brand of options.commonBottleBrands"
                  [class.selected]="onboardingForm.get('bottleBrand')?.value === brand"
                  (click)="selectSingleValue('bottleBrand', brand)"
                  class="selection-chip">
                  <ion-icon 
                    *ngIf="onboardingForm.get('bottleBrand')?.value === brand" 
                    name="checkmark" 
                    class="chip-selected-icon">
                  </ion-icon>
                  {{ brand }}
                </ion-chip>
              </div>
              
              <!-- Other Bottle Brand Input -->
              <div class="form-group" *ngIf="onboardingForm.get('bottleBrand')?.value === 'Other'">
                <ion-item lines="none" class="input-item">
                  <ion-input
                    formControlName="bottleBrandOther"
                    placeholder="Please specify other bottle brand"
                    fill="outline">
                  </ion-input>
                </ion-item>
              </div>
            </div>

            <div class="form-group">
              <label class="input-label">How long does it take to finish the feed using bottle?</label>
              <div class="horizontal-chip-selection">
                <ion-chip 
                  *ngFor="let duration of options.bottleFeedDuration"
                  [class.selected]="onboardingForm.get('bottleFeedDuration')?.value === duration.value"
                  (click)="selectSingleValue('bottleFeedDuration', duration.value)"
                  class="selection-chip">
                  <ion-icon 
                    *ngIf="onboardingForm.get('bottleFeedDuration')?.value === duration.value" 
                    name="checkmark" 
                    class="chip-selected-icon">
                  </ion-icon>
                  {{ duration.label }}
                </ion-chip>
              </div>
            </div>

            <div class="form-group">
              <label class="input-label">Are you using paced bottle feeding?</label>
              <ion-radio-group formControlName="usesPacedBottleFeeding" class="horizontal-radio-group">
                <ion-item lines="none" class="radio-item">
                  <ion-radio slot="start" [value]="true"></ion-radio>
                  <ion-label>Yes</ion-label>
                </ion-item>
                <ion-item lines="none" class="radio-item">
                  <ion-radio slot="start" [value]="false"></ion-radio>
                  <ion-label>No</ion-label>
                </ion-item>
              </ion-radio-group>
            </div>

            <div class="form-group">
              <label class="input-label">What do you put in bottles?</label>
              <div class="horizontal-chip-selection">
                <ion-chip 
                  *ngFor="let content of options.bottleContents"
                  [class.selected]="onboardingForm.get('bottleContents')?.value === content.value"
                  (click)="selectSingleValue('bottleContents', content.value)"
                  class="selection-chip">
                  <ion-icon 
                    *ngIf="onboardingForm.get('bottleContents')?.value === content.value" 
                    name="checkmark" 
                    class="chip-selected-icon">
                  </ion-icon>
                  {{ content.label }}
                </ion-chip>
              </div>
            </div>
          </div>
        </div>

        <!-- Pumping Section -->
        <div class="feeding-section">
          <h3 class="subsection-title">Breast Pumping</h3>
          
          <div class="form-group">
            <label class="input-label">Do you use a breast pump?</label>
            <ion-radio-group formControlName="usesPump" class="horizontal-radio-group">
              <ion-item lines="none" class="radio-item">
                <ion-radio slot="start" [value]="true"></ion-radio>
                <ion-label>Yes</ion-label>
              </ion-item>
              <ion-item lines="none" class="radio-item">
                <ion-radio slot="start" [value]="false"></ion-radio>
                <ion-label>No</ion-label>
              </ion-item>
            </ion-radio-group>
          </div>

          <!-- General Pumping Details - Show only if using pump -->
          <div class="conditional-section" *ngIf="shouldShowPumpingQuestions()">
            <div class="form-group">
              <label class="input-label">Which pump brand do you use?</label>
              <div class="horizontal-chip-selection">
                <ion-chip 
                  *ngFor="let brand of options.commonPumpBrands"
                  [class.selected]="onboardingForm.get('pumpBrand')?.value === brand"
                  (click)="selectSingleValue('pumpBrand', brand)"
                  class="selection-chip">
                  <ion-icon 
                    *ngIf="onboardingForm.get('pumpBrand')?.value === brand" 
                    name="checkmark" 
                    class="chip-selected-icon">
                  </ion-icon>
                  {{ brand }}
                </ion-chip>
              </div>
              
              <!-- Other Pump Brand Input -->
              <div class="form-group" *ngIf="onboardingForm.get('pumpBrand')?.value === 'Other'">
                <ion-item lines="none" class="input-item">
                  <ion-input
                    formControlName="pumpBrandOther"
                    placeholder="Please specify other pump brand"
                    fill="outline">
                  </ion-input>
                </ion-item>
              </div>
            </div>

            <div class="form-group">
              <label class="input-label">Type of pump</label>
              <div class="horizontal-chip-selection">
                <ion-chip 
                  *ngFor="let type of options.pumpTypes"
                  [class.selected]="onboardingForm.get('pumpType')?.value === type.value"
                  (click)="selectSingleValue('pumpType', type.value)"
                  class="selection-chip">
                  <ion-icon 
                    *ngIf="onboardingForm.get('pumpType')?.value === type.value" 
                    name="checkmark" 
                    class="chip-selected-icon">
                  </ion-icon>
                  {{ type.label }}
                </ion-chip>
              </div>
            </div>

            <div class="form-group">
              <label class="input-label">Do you pump both breasts?</label>
              <ion-radio-group formControlName="pumpsBothBreasts" class="horizontal-radio-group">
                <ion-item lines="none" class="radio-item">
                  <ion-radio slot="start" [value]="true"></ion-radio>
                  <ion-label>Yes</ion-label>
                </ion-item>
                <ion-item lines="none" class="radio-item">
                  <ion-radio slot="start" [value]="false"></ion-radio>
                  <ion-label>No</ion-label>
                </ion-item>
              </ion-radio-group>
            </div>

            <div class="form-group">
              <label class="input-label">Sessions per 24 hours</label>
              <div class="slider-container">
                <ion-range
                  formControlName="pumpSessionsPerDay"
                  min="1"
                  max="12"
                  step="1"
                  pin="true"
                  snaps="true"
                  color="primary">
                  <ion-label slot="start">1</ion-label>
                  <ion-label slot="end">12</ion-label>
                </ion-range>
                <div class="slider-value">
                  {{ onboardingForm.get('pumpSessionsPerDay')?.value || 1 }} sessions
                </div>
              </div>
            </div>
            
            <div class="form-group">
              <label class="input-label">Minutes per session</label>
              <div class="slider-container">
                <ion-range
                  formControlName="pumpMinutesPerSession"
                  min="5"
                  max="60"
                  step="5"
                  pin="true"
                  snaps="true"
                  color="primary">
                  <ion-label slot="start">5</ion-label>
                  <ion-label slot="end">60</ion-label>
                </ion-range>
                <div class="slider-value">
                  {{ onboardingForm.get('pumpMinutesPerSession')?.value || 15 }} minutes
                </div>
              </div>
            </div>

            <div class="form-group">
              <label class="input-label">Average output per session</label>
              <div class="slider-container">
                <ion-range
                  formControlName="pumpAverageOutput"
                  min="10"
                  max="300"
                  step="10"
                  pin="true"
                  snaps="true"
                  color="primary">
                  <ion-label slot="start">10ml</ion-label>
                  <ion-label slot="end">300ml</ion-label>
                </ion-range>
                <div class="slider-value">
                  {{ onboardingForm.get('pumpAverageOutput')?.value || 50 }} ml
                </div>
              </div>
            </div>
            
            <div class="form-group">
              <label class="input-label">Total daily output</label>
              <div class="slider-container">
                <ion-range
                  formControlName="pumpTotalDailyOutput"
                  min="50"
                  max="1500"
                  step="25"
                  pin="true"
                  snaps="true"
                  color="primary">
                  <ion-label slot="start">50ml</ion-label>
                  <ion-label slot="end">1500ml</ion-label>
                </ion-range>
                <div class="slider-value">
                  {{ onboardingForm.get('pumpTotalDailyOutput')?.value || 200 }} ml
                </div>
              </div>
            </div>
          </div>
        </div>

        <div class="button-row">
          <ion-button fill="outline" (click)="previousStep()" class="back-button">
            Back
          </ion-button>
          <ion-button (click)="nextStep()" class="next-button">
            Continue
          </ion-button>
        </div>
      </div>
      
      <!-- Step 3: Placeholder for Pregnant Mothers -->
      <div class="form-step" *ngIf="progress.currentStep === 3 && onboardingForm.get('motherType')?.value === 'pregnant'">
        <h2 class="step-title">Almost There!</h2>
        <p class="step-description">Since you're expecting, we'll skip the breastfeeding questions for now. You can complete this assessment after your baby arrives.</p>
        
        <div class="pregnancy-info">
          <ion-card class="info-card">
            <ion-card-content>
              <div class="info-content">
                <ion-icon name="heart" color="primary" size="large"></ion-icon>
                <h3>Preparing for Breastfeeding</h3>
                <p>After your baby arrives, NariCare will help you with:</p>
                <ul>
                  <li>Initial latch guidance</li>
                  <li>Milk supply establishment</li>
                  <li>24/7 expert support</li>
                  <li>Growth tracking</li>
                </ul>
              </div>
            </ion-card-content>
          </ion-card>
        </div>
        
        <div class="button-row">
          <ion-button fill="outline" (click)="previousStep()" class="back-button">
            Back
          </ion-button>
          <ion-button (click)="nextStep()" class="next-button">
            Continue
          </ion-button>
        </div>
      </div>

      <!-- Step 4: Support System & Demographics -->
      <div class="form-step" *ngIf="progress.currentStep === 4">
        <h2 class="step-title">Support & Demographics</h2>
        <p class="step-description">This helps us understand your support network and background</p>
        
        <div class="form-group">
          <label class="input-label">Describe your current support system</label>
          <ion-item lines="none" class="input-item" [class.error]="isFieldInvalid('currentSupportSystem')">
            <ion-textarea
              formControlName="currentSupportSystem"
              placeholder="Family, friends, partners, etc."
              rows="3"
              fill="outline">
            </ion-textarea>
          </ion-item>
          <div class="error-message" *ngIf="isFieldInvalid('currentSupportSystem')">
            {{ getFieldError('currentSupportSystem') }}
          </div>
        </div>

        <div class="form-group">
          <label class="input-label">Family Structure</label>
          <div class="horizontal-chip-selection">
            <ion-chip 
              *ngFor="let structure of options.familyStructure"
              [class.selected]="isValueSelected('familyStructure', structure.value)"
              (click)="selectSingleValue('familyStructure', structure.value)"
              class="selection-chip">
              <ion-icon name="checkmark-circle" class="chip-selected-icon" *ngIf="isValueSelected('familyStructure', structure.value)"></ion-icon>
              {{ structure.label }}
            </ion-chip>
          </div>
        </div>

        <div class="form-group">
          <label class="input-label">Education Level</label>
          <div class="horizontal-chip-selection">
            <ion-chip 
              *ngFor="let education of options.educationLevels"
              [class.selected]="isValueSelected('educationLevel', education.value)"
              (click)="selectSingleValue('educationLevel', education.value)"
              class="selection-chip">
              <ion-icon name="checkmark-circle" class="chip-selected-icon" *ngIf="isValueSelected('educationLevel', education.value)"></ion-icon>
              {{ education.label }}
            </ion-chip>
          </div>
        </div>

        <div class="form-group">
          <label class="input-label">Household Income (Optional)</label>
          <div class="horizontal-chip-selection">
            <ion-chip 
              *ngFor="let income of options.householdIncomes"
              [class.selected]="isValueSelected('householdIncome', income.value)"
              (click)="selectSingleValue('householdIncome', income.value)"
              class="selection-chip">
              <ion-icon 
                *ngIf="isValueSelected('householdIncome', income.value)" 
                name="checkmark" 
                class="chip-selected-icon">
              </ion-icon>
              {{ income.label }}
            </ion-chip>
          </div>
        </div>

        <div class="button-row">
          <ion-button fill="outline" (click)="previousStep()" class="back-button">
            Back
          </ion-button>
          <ion-button (click)="nextStep()" class="next-button">
            Continue
          </ion-button>
        </div>
      </div>

      <!-- Step 5: Challenges & Expectations -->
      <div class="form-step" *ngIf="progress.currentStep === 5">
        <h2 class="step-title">Challenges & Expectations</h2>
        <p class="step-description">Tell us about your current challenges and goals</p>
        
        <div class="form-group">
          <label class="input-label">Current Challenges (Select all that apply)</label>
          <div class="chip-options">
            <ion-chip 
              *ngFor="let challenge of options.currentChallenges"
              [class.selected]="isValueSelected('currentChallenges', challenge)"
              (click)="toggleArrayValue('currentChallenges', challenge)">
              {{ challenge }}
            </ion-chip>
          </div>
        </div>

        <div class="form-group">
          <label class="input-label">What are your expectations from the NariCare program?</label>
          <ion-item lines="none" class="input-item" [class.error]="isFieldInvalid('expectationsFromProgram')">
            <ion-textarea
              formControlName="expectationsFromProgram"
              placeholder="What do you hope to achieve?"
              rows="4"
              fill="outline">
            </ion-textarea>
          </ion-item>
          <div class="error-message" *ngIf="isFieldInvalid('expectationsFromProgram')">
            {{ getFieldError('expectationsFromProgram') }}
          </div>
        </div>

        <div class="button-row">
          <ion-button fill="outline" (click)="previousStep()" class="back-button">
            Back
          </ion-button>
          <ion-button (click)="completeOnboarding()" class="complete-button" [disabled]="!progress.canProceed">
            <ion-icon name="checkmark-circle" slot="start"></ion-icon>
            Complete Assessment
          </ion-button>
        </div>
      </div>

    </form>

    <!-- Progress Summary Footer -->
    <div class="progress-footer" *ngIf="progress.completedSteps > 0">
      <p class="progress-summary">
        {{ progress.completedSteps }} of {{ progress.totalSteps }} sections completed
      </p>
    </div>

  </div>
</ion-content>
