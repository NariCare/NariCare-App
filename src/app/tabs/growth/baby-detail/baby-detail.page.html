<!-- Baby Detail Header -->
<ion-header [translucent]="true" class="baby-detail-header">
  <ion-toolbar>
    <ion-buttons slot="start">
      <ion-button (click)="goBack()" class="header-button">
        <ion-icon name="arrow-back" slot="icon-only"></ion-icon>
      </ion-button>
    </ion-buttons>
    <ion-title>
      <div class="header-title">
        <h1>{{ baby?.name || 'Baby' }}</h1>
        <p class="birth-date">DOB - {{ formatBirthDate() }}</p>
        <p class="baby-age">Age - {{ calculateBabyAge() }}</p>
      </div>
    </ion-title>
    <ion-buttons slot="end">
      <ion-button (click)="onEditClick()" class="header-button edit-button">
        <ion-icon name="create" slot="icon-only"></ion-icon>
      </ion-button>
    </ion-buttons>
  </ion-toolbar>
</ion-header>

<ion-content [fullscreen]="true" class="baby-detail-content">
  <div class="content-container">

    <!-- Baby Avatar Section -->
    <div class="baby-avatar-section">
      <div class="baby-avatar-large">
        <app-custom-icon [babyGender]="baby?.gender || 'male'" size="60px"></app-custom-icon>
      </div>
    </div>

    <!-- Sub-tabs -->
    <div class="sub-tabs-container">
      <ion-segment [(ngModel)]="selectedSubTab" (ionChange)="onSubTabChange($event)" class="sub-tabs-segment">
        <ion-segment-button value="weight-size">
          <ion-label>Weight and size</ion-label>
        </ion-segment-button>
        <ion-segment-button value="feed-tracks">
          <ion-label>Feed Tracks</ion-label>
        </ion-segment-button>
        <ion-segment-button value="diaper-change">
          <ion-label>Diaper Change</ion-label>
        </ion-segment-button>
        <!-- <ion-segment-button value="pumping-tracks">
          <ion-label>Pumping</ion-label>
        </ion-segment-button> -->
      </ion-segment>
    </div>

    <!-- Weight and Size Tab -->
    <div class="tab-content" *ngIf="selectedSubTab === 'weight-size'">

      <!-- Tab Actions -->
      <div class="tab-actions-section">
        <ion-button expand="block" fill="solid" class="see-charts-button" (click)='openWeightChartModal()'>
          <ion-icon name="stats-chart" slot="start"></ion-icon>
          {{ baby?.name || 'Baby' }}' Growth Chart
        </ion-button>
        <ion-button expand="block" fill="outline" class="add-record-button" (click)='onAddRecordClick()'>
          <ion-icon name="add" slot="start"></ion-icon>
          ADD WEIGHT RECORD
        </ion-button>
      </div>

      <!-- Current Stats -->
      <div class="current-stats">
        <div class="stat-card weight-card">
          <div class="stat-icon">
            <ion-icon name="scale"></ion-icon>
          </div>
          <div class="stat-content">
            <div class="stat-value">{{ getCurrentWeight() }}</div>
          </div>
        </div>

        <div class="stat-card height-card">
          <div class="stat-icon">
            <ion-icon name="resize"></ion-icon>
          </div>
          <div class="stat-content">
            <div class="stat-value">{{ getCurrentHeight() }}</div>
          </div>
        </div>
      </div>

      <!-- WHO Weight Chart -->
      <!-- <div class="chart-section" *ngIf="baby && weightRecords$">
        <app-weight-chart 
          [weightRecords]="weightRecords$ | async"
          [babyGender]="baby.gender"
          [babyBirthDate]="baby.dateOfBirth">
        </app-weight-chart>
      </div> -->

      <!-- Weight Records List -->
      <div class="records-section">
        <h3 class="section-title">Recent Weight Records</h3>
        <div class="records-list" *ngIf="weightRecords$ | async as weightRecords; else noWeightRecords">
          <div *ngFor="let record of weightRecords | slice:0:5" class="record-item weight-record">
            <div class="record-date">
              <div class="date-day">{{ record.date | date:'dd' }}</div>
              <div class="date-month">{{ record.date | date:'MMM' }}</div>
              <div class="date-year">{{ record.date | date:'yyyy' }}</div>
            </div>
            <div class="record-details">
              <div class="weight-value">{{ record.weight }}kg</div>
              <div class="height-value" *ngIf="record.height">{{ record.height }}cm</div>
            </div>
            <div class="record-notes" *ngIf="record.notes">
              <p>{{ record.notes }}</p>
            </div>
          </div>
        </div>

        <ng-template #noWeightRecords>
          <div class="empty-records">
            <ion-icon name="scale"></ion-icon>
            <h4>No weight records yet</h4>
            <p>Start tracking by clicking the "Add Weight Record" button above</p>
          </div>
        </ng-template>
      </div>
    </div>

    <!-- Feed Tracks Tab -->
    <div class="tab-content" *ngIf="selectedSubTab === 'feed-tracks'">
      <!-- Tab Actions -->
      <div class="tab-actions-section">
        <ion-button expand="block" fill="outline" class="add-record-button" (click)='onAddRecordClick()'>
          <ion-icon name="add" slot="start"></ion-icon>
          ADD FEED RECORD
        </ion-button>
      </div>
      
      <div class="records-section">
        <h3 class="section-title">Recent Feed Records</h3>
        <div class="recent-feeds-list" *ngIf="growthRecords$ | async as growthRecords; else noFeedRecords">
          <ng-container *ngFor="let record of growthRecords | slice:0:10">
            
            <!-- Direct Feed (if exists) -->
            <div *ngIf="getFeedTypes(record).includes('direct')" class="feed-record-wrapper">
              <div class="feed-record direct-feed">
                <div class="feed-time-container">
                  <div class="feed-time">{{ getRecordTime(record) }}</div>
                </div>
                <div class="feed-content">
                  <div class="feed-main-info">
                    <div class="feed-icon-label">
                      <img src="assets/Fed directly.svg" alt="Direct Feed" class="feed-svg-icon">
                      <span class="feed-type">{{ getBreastSide(record) | titlecase }}</span>
                    </div>
                    <div class="feed-metric" *ngIf="getFeedPainLevel(record) !== null">
                      <span class="pain-value">{{ getFeedPainLevel(record) }}/10</span>
                    </div>
                  </div>
                  <div class="feed-date">{{ getRecordDate(record) }}</div>
                </div>
              </div>
            </div>

            <!-- Expressed Milk Feed (if exists) -->
            <div *ngIf="getFeedTypes(record).includes('expressed')" class="feed-record-wrapper">
              <div class="feed-record expressed-feed">
                <div class="feed-time-container">
                  <div class="feed-time">{{ getRecordTime(record) }}</div>
                </div>
                <div class="feed-content">
                  <div class="feed-main-info">
                    <div class="feed-icon-label">
                      <img src="assets/Pump.svg" alt="Expressed Milk" class="feed-svg-icon">
                      <span class="feed-type">Expressed Milk</span>
                    </div>
                    <div class="feed-metric">
                      <span class="volume-value">{{ getExpressedVolume(record) || 0 }}ml</span>
                    </div>
                  </div>
                  <div class="feed-date">{{ getRecordDate(record) }}</div>
                </div>
              </div>
            </div>

            <!-- Formula Feed (if exists) -->
            <div *ngIf="getFeedTypes(record).includes('formula')" class="feed-record-wrapper">
              <div class="feed-record formula-feed">
                <div class="feed-time-container">
                  <div class="feed-time">{{ getRecordTime(record) }}</div>
                </div>
                <div class="feed-content">
                  <div class="feed-main-info">
                    <div class="feed-icon-label">
                      <img src="assets/Formula.svg" alt="Formula" class="feed-svg-icon">
                      <span class="feed-type">Formula</span>
                    </div>
                    <div class="feed-metric">
                      <span class="volume-value">{{ getFormulaVolume(record) || 0 }}ml</span>
                    </div>
                  </div>
                  <div class="feed-date">{{ getRecordDate(record) }}</div>
                </div>
              </div>
            </div>

          </ng-container>
        </div>

        <ng-template #noFeedRecords>
          <div class="empty-records">
            <h4>No feed records yet</h4>
            <p>Start tracking by clicking the "Add Feed Record" button above</p>
          </div>
        </ng-template>
      </div>
    </div>

    <!-- Diaper Change Tab -->
    <div class="tab-content" *ngIf="selectedSubTab === 'diaper-change'">
      <!-- Tab Actions -->
      <div class="tab-actions-section">
        <ion-button expand="block" fill="outline" class="add-record-button" (click)='onAddRecordClick()'>
          <ion-icon name="add" slot="start"></ion-icon>
          ADD DIAPER CHANGE
        </ion-button>
      </div>
      
      <div class="records-section">
        <h3 class="section-title">Recent Diaper Changes</h3>
        <div class="records-list" *ngIf="diaperChangeRecords$ | async as diaperRecords; else noDiaperRecords">
          <div *ngFor="let record of diaperRecords | slice:0:10" class="record-item diaper-record">
            <div class="record-time">{{ getDiaperChangeTime(record) }}</div>
            <div class="record-date">{{ getDiaperChangeDate(record) }}</div>
            <div class="record-details">
              <div class="diaper-type-indicator">
                <span class="type-emoji">{{ getChangeTypeEmoji(record.change_type || record.type || record.changeType) }}</span>
                <span class="type-label">{{ getDiaperChangeType(record) }}</span>
              </div>
              <div class="wetness-indicator" *ngIf="record.wetness_level || record.wetness || record.wetnessLevel">
                <ion-icon name="water"></ion-icon>
                <span class="wetness-level">{{ (record.wetness_level || record.wetness || record.wetnessLevel) | titlecase }}</span>
              </div>
            </div>
            <div class="record-notes" *ngIf="record.notes">
              <span class="notes-emoji">📝</span>
              <span class="notes-label">Notes</span>
            </div>
          </div>
        </div>

        <ng-template #noDiaperRecords>
          <div class="empty-records">
            <ion-icon name="medical"></ion-icon>
            <h4>No diaper changes yet</h4>
            <p>Start tracking by clicking the "Add Diaper Change" button above</p>
          </div>
        </ng-template>
      </div>
    </div>

    <!-- Pumping Tracks Tab - Hidden for now (baby-independent feature moved to main growth page) -->
    <!-- <div class="tab-content" *ngIf="selectedSubTab === 'pumping-tracks'">
      <div class="records-section">
        <h3 class="section-title">Recent Pumping Sessions</h3>
        <div class="records-list" *ngIf="pumpingRecords$ | async as pumpingRecords; else noPumpingRecords">
          <div *ngFor="let record of pumpingRecords | slice:0:10" class="record-item pumping-record">
            <div class="record-time">{{ getPumpingTime(record) }}</div>
            <div class="record-date">{{ getPumpingDate(record) }}</div>
            <div class="record-details">
              <div class="pumping-side-indicator">
                <ion-icon name="ellipse" *ngIf="getPumpingSide(record) === 'both'"></ion-icon>
                <ion-icon name="radio-button-on" *ngIf="getPumpingSide(record) !== 'both'"></ion-icon>
                <span>{{ getPumpingSide(record) | titlecase }} Side</span>
              </div>
              
              <div class="output-indicator" *ngIf="getPumpingOutput(record)">
                <ion-icon name="water"></ion-icon>
                <span>{{ getPumpingOutput(record) }}ml</span>
              </div>
              
              <div class="duration-indicator" *ngIf="getPumpingDuration(record)">
                <ion-icon name="time"></ion-icon>
                <span>{{ getPumpingDuration(record) }}min</span>
              </div>
            </div>
            <div class="record-notes" *ngIf="record.notes">
              <span class="notes-emoji">📝</span>
              <span class="notes-label">Notes</span>
            </div>
          </div>
        </div>

        <ng-template #noPumpingRecords>
          <div class="empty-records">
            <ion-icon name="nutrition"></ion-icon>
            <h4>No pumping sessions yet</h4>
            <p>Start tracking by clicking the edit button above</p>
          </div>
        </ng-template>
      </div>
    </div> -->

    <!-- Keep original Stool Tracks Tab for backward compatibility -->
    <div class="tab-content" *ngIf="selectedSubTab === 'stool-tracks'">
      <div class="records-section">
        <h3 class="section-title">Recent Stool Records</h3>
        <div class="records-list" *ngIf="stoolRecords$ | async as stoolRecords; else noStoolRecords">
          <div *ngFor="let record of stoolRecords | slice:0:10" class="record-item stool-record">
            <div class="record-time">{{ getStoolTime(record) }}</div>
            <div class="record-date">{{ getStoolDate(record) }}</div>
            <div class="record-details">
              <!-- <div class="stool-color">
                <div class="color-dot" [style.background-color]="record.color.color"></div>
                <span>{{ getStoolColorDisplay(record.color) }}</span>
              </div> -->
              <!-- <div class="stool-texture">
                <ion-icon [name]="record.texture.icon"></ion-icon>
                <span>{{ getStoolTextureDisplay(record.texture) }}</span>
              </div>
              <div class="stool-size">
                <ion-icon [name]="record.size.icon"></ion-icon>
                <span>{{ getStoolSizeDisplay(record.size) }}</span>
              </div> -->
            </div>
            <div class="diaper-counts" *ngIf="record.peeCount || record.poopCount">
              <span *ngIf="record.peeCount">{{ record.peeCount }} wet</span>
              <span *ngIf="record.poopCount">{{ record.poopCount }} dirty</span>
            </div>
          </div>
        </div>

        <ng-template #noStoolRecords>
          <div class="empty-records">
            <ion-icon name="medical"></ion-icon>
            <h4>No stool records yet</h4>
            <p>Start tracking by clicking the edit button above</p>
          </div>
        </ng-template>
      </div>
    </div>

  </div>

  <!-- Daily Record Modal -->
  <ion-modal [isOpen]="showAddRecordModal" (didDismiss)="closeAddRecordModal()">
    <ng-template>
      <ion-header>
        <ion-toolbar>
          <ion-title>Add Daily Record</ion-title>
          <ion-buttons slot="end">
            <ion-button (click)="closeAddRecordModal()">
              <ion-icon name="close" slot="icon-only"></ion-icon>
            </ion-button>
          </ion-buttons>
        </ion-toolbar>
      </ion-header>

      <ion-content>
        <form [formGroup]="addRecordForm" class="add-record-form">

          <!-- Baby Info Header -->
          <div class="baby-info-header" *ngIf="baby">
            <div class="baby-avatar">
              <app-custom-icon [babyGender]="baby?.gender || 'male'" size="32px"></app-custom-icon>
            </div>
            <div class="baby-details">
              <h3>{{ baby.name }}</h3>
              <p>{{ calculateBabyAge() }}</p>
            </div>
          </div>

          <!-- Smart Voice Input Section -->
          <div class="smart-voice-section" *ngIf="isVoiceSupported()">
            <div class="voice-input-header">
              <h5>🎤 Smart Voice Input</h5>
              <p>Say something like: "Baby fed 8 times today, feeling great"</p>
            </div>

            <ion-button expand="block" fill="outline" (click)="startSmartVoiceInput()"
              [disabled]="isRecording || isProcessingVoice" class="smart-voice-button">
              <ion-icon [name]="isRecording ? 'stop' : 'mic'" slot="start"></ion-icon>
              <span *ngIf="!isRecording && !isProcessingVoice">Start Voice Input</span>
              <span *ngIf="isRecording">Listening...</span>
              <span *ngIf="isProcessingVoice">Processing...</span>
            </ion-button>

            <div class="voice-status" *ngIf="voiceTranscript || isProcessingVoice">
              <div class="voice-transcript" *ngIf="voiceTranscript">
                <h6>Voice Input:</h6>
                <p>"{{ voiceTranscript }}"</p>
              </div>

              <div class="voice-summary">
                <p class="summary-text">{{ getVoiceInputSummary() }}</p>
                <ion-button fill="clear" size="small" (click)="clearVoiceInput()">
                  <ion-icon name="close" slot="icon-only"></ion-icon>
                </ion-button>
              </div>
            </div>
          </div>

          <!-- Breastfeeding Time -->
          <div class="form-section">
            <h4>Breastfeeding time</h4>

            <div class="form-row">
              <div class="form-group half-width">
                <label class="field-label">Start</label>
                <ion-item lines="none" class="input-item time-input">
                  <ion-input formControlName="startTime" type="time"
                    [class.error]="addRecordForm.get('startTime')?.invalid && addRecordForm.get('startTime')?.touched">
                  </ion-input>
                </ion-item>
              </div>

              <div class="form-group half-width">
                <label class="field-label">End</label>
                <ion-item lines="none" class="input-item time-input">
                  <ion-input formControlName="endTime" type="time"
                    [class.error]="addRecordForm.get('endTime')?.invalid && addRecordForm.get('endTime')?.touched">
                  </ion-input>
                </ion-item>
              </div>
            </div>
          </div>

          <!-- Breast Side Selection -->
          <div class="form-section">
            <h4>Breast side</h4>
            <div class="selection-grid breast-side-grid">
              <div *ngFor="let side of breastSideOptions" class="selection-option breast-side-option"
                [class.selected]="selectedBreastSide?.value === side.value" (click)="selectBreastSide(side)">
                <div class="breast-side-icon">
                  <ion-icon [name]="side.icon"></ion-icon>
                </div>
                <span class="option-label">{{ side.label }}</span>
              </div>
            </div>
          </div>

          <!-- Pain Level -->
          <div class="form-section">
            <h4>Pain</h4>
            <p class="section-note">Consider 0 is no pain and 10 is a lot of pain</p>

            <div class="pain-level-container">
              <div class="pain-level-display">{{ painLevel }}</div>
              <ion-range min="0" max="10" step="1" [(ngModel)]="painLevel"
                (ionInput)="setPainLevel($event.detail.value)" color="secondary" class="pain-slider">
                <ion-label slot="start">0</ion-label>
                <ion-label slot="end">10</ion-label>
              </ion-range>
            </div>
          </div>

          <!-- How do you feel -->
          <div class="form-section">
            <h4>How do you feel?</h4>
            <div class="selection-grid mood-grid">
              <div *ngFor="let mood of motherMoodOptions" class="selection-option mood-option"
                [class.selected]="selectedMotherMood?.value === mood.value" (click)="selectMotherMood(mood)">
                <div class="mood-emoji-circle">{{ mood.emoji }}</div>
                <span class="option-label">{{ mood.label }}</span>
              </div>
            </div>
          </div>

          <!-- Notes -->
          <div class="form-section">
            <h4>Your notes</h4>
            <div class="form-group">
              <ion-item lines="none" class="input-item">
                <ion-textarea formControlName="notes" placeholder="Write here more about your feed" rows="3"
                  autoGrow="true">
                </ion-textarea>
              </ion-item>
            </div>
          </div>

          <!-- Form Actions -->
          <div class="form-actions">
            <ion-button expand="block" (click)="saveGrowthRecord()"
              [disabled]="!addRecordForm.valid || !selectedBreastSide || !selectedMotherMood" class="save-button">
              Accept
            </ion-button>
          </div>
        </form>
      </ion-content>
    </ng-template>
  </ion-modal>


  <!-- Pumping Log Modal -->
  <ion-modal [isOpen]="showAddPumpingModal" (didDismiss)="closeAddPumpingModal()">
    <ng-template>
      <app-pumping-log-modal (ionModalDidDismiss)="closeAddPumpingModal()">
      </app-pumping-log-modal>
    </ng-template>
  </ion-modal>
</ion-content>