<ion-header [translucent]="true">
  <ion-toolbar>
    <ion-title>Trackers</ion-title>
  </ion-toolbar>
</ion-header>

<ion-content [fullscreen]="true">
  <div class="content-container">
    
    <!-- Tracker Cards Grid -->
    <div class="tracker-cards-container">
      <!-- Top Row - 2x2 Grid -->
      <div class="tracker-cards-grid">
        <div class="tracker-card feed-card" (click)="onFeed()">
          <div class="tracker-icon">
            <app-custom-icon trackerType="feed" size="50px"></app-custom-icon>
          </div>
          <span class="tracker-label">Feed</span>
        </div>

        <div class="tracker-card diaper-card" (click)="openDiaperLogModal()">
          <div class="tracker-icon">
            <img src="assets/Diaper change.svg" alt="Diaper change" class="tracker-svg-icon">
          </div>
          <span class="tracker-label">Diaper change</span>
        </div>
        
        <div class="tracker-card weight-card" (click)="onWeightSize()">
          <div class="tracker-icon">
            <app-custom-icon trackerType="weight" size="50px"></app-custom-icon>
          </div>
          <span class="tracker-label">Weight</span>
        </div>

        <div class="tracker-card pump-card" (click)="openPumpLogModal()">
          <div class="tracker-icon">
            <img src="assets/Pump.svg" alt="Pump" class="tracker-svg-icon">
          </div>
          <span class="tracker-label">Pump</span>
        </div>
      </div>

      <!-- Full-width Emotional Check-in Card -->
      <div class="tracker-card emotional-card" (click)="onEmotionCheckin()">
        <div class="emotional-content">
          <div class="tracker-icon">
            <app-custom-icon trackerType="emotional" size="100px"></app-custom-icon>
          </div>
          <span class="tracker-label">Emotional check-in</span>
        </div>
      </div>
    </div>

    <!-- Main Tab Selector -->
    <div class="main-tab-selector">
      <ion-segment [(ngModel)]="selectedMainTab" (ionChange)="onMainTabChange($event)" class="main-tabs-segment">
        <ion-segment-button value="my-babies">
          <ion-label>My Babies</ion-label>
        </ion-segment-button>
        <ion-segment-button value="mothers-journey">
          <ion-label>Mother's Journey</ion-label>
        </ion-segment-button>
      </ion-segment>
    </div>

    <!-- My Babies Tab Content -->
    <div class="tab-content" *ngIf="selectedMainTab === 'my-babies'">
      <div class="baby-cards-list" *ngIf="user && user.babies && user.babies.length > 0">
        <div 
          *ngFor="let baby of user.babies"
          class="baby-card"
          [class.selected]="selectedBaby?.id === baby.id"
          (click)="selectBaby(baby)">
          <div class="baby-avatar">
            <img [src]="getBabyIconUrl(baby.gender)" alt="Baby" style="width: 32px; height: 32px;">
          </div>
          <div class="baby-info">
            <h3>{{ baby.name }}</h3>
            <p class="baby-age">{{ calculateBabyAgeForBaby(baby.dateOfBirth) }}</p>
            <p class="baby-weight">{{ baby.currentWeight || baby.birthWeight }}kg</p>
          </div>
          <ion-icon name="chevron-forward" class="baby-arrow"></ion-icon>
        </div>
      </div>
      
      <div class="empty-babies" *ngIf="!user || !user.babies || user.babies.length === 0">
        <app-custom-icon name="Baby boy" size="48px"></app-custom-icon>
        <h3>No babies added yet</h3>
        <p>Add your baby's information to start tracking growth and feeding</p>
        <!-- <ion-button 
          expand="block"
          (click)="openAddBabyModal()"
          class="add-first-baby-button">
          <ion-icon name="add-outline" slot="start"></ion-icon>
          Add Your First Baby
        </ion-button> -->
      </div>

      <!-- Floating Add Baby Button - Inside My Babies Tab -->
      <div class="fab-wrapper">
        <ion-fab-button 
          (click)="openAddBabyModal()"
          class="add-baby-fab">
          <ion-icon name="add"></ion-icon>
        </ion-fab-button>
      </div>
    </div>

    <!-- Mother's Journey Tab Content -->
    <div class="tab-content" *ngIf="selectedMainTab === 'mothers-journey'">
      
      <!-- Mother's Journey Header -->
      <div class="mothers-journey-header">
        <div class="journey-title">
          <h2>Your Wellness Journey</h2>
          <p>Track your breastfeeding, pumping, and emotional wellness</p>
        </div>
      </div>

      <!-- Quick Stats Overview -->
      <div class="mothers-stats-grid">
        <div class="stat-card breastfeeding-stat">
          <div class="stat-icon">
            <img src="assets/Breastfeeding journey.svg" alt="Breastfeeding" class="stat-svg-icon">
          </div>
          <div class="stat-content">
            <div class="stat-value">{{ getDailySummaryTracks() }}</div>
            <div class="stat-label">Today's Feeds</div>
          </div>
        </div>

        <div class="stat-card pumping-stat">
          <div class="stat-icon">
            <img src="assets/Pumping journey.svg" alt="Pumping" class="stat-svg-icon">
          </div>
          <div class="stat-content">
            <div class="stat-value">{{ getPumpDailySessions() }}</div>
            <div class="stat-label">Pump Sessions</div>
          </div>
        </div>

        <div class="stat-card emotion-stat">
          <div class="stat-icon">
            <img src="assets/Emotional wellness.svg" alt="Emotional wellness" class="stat-svg-icon">
          </div>
          <div class="stat-content">
            <div class="stat-value">{{ getEmotionCheckinsCount() }}</div>
            <div class="stat-label">Emotion Check-ins</div>
          </div>
        </div>
      </div>

      <!-- Journey Sections -->
      <div class="journey-sections">
        
        <!-- Breastfeeding Section -->
        <div class="journey-section breastfeeding-section">
          <div class="section-header">
            <div class="section-title-icon">
              <img src="assets/Breastfeeding journey.svg" alt="Breastfeeding Journey" class="section-svg-icon">
              <h3>Breastfeeding Journey</h3>
            </div>
            <div class="section-summary" *ngIf="selectedBaby">
              <span class="last-feed-time">Last: {{ getLastTrackTime() }}</span>
            </div>
          </div>
          
          <div class="section-content">
            <!-- Last Feed Summary -->
            <div class="last-activity-card" *ngIf="selectedBaby">
              <div class="activity-header">
                <div class="activity-icon breastfeeding">
                  <ion-icon name="ellipse" *ngIf="getLastTrackBreastSide() === 'both'"></ion-icon>
                  <ion-icon name="radio-button-on" *ngIf="getLastTrackBreastSide() !== 'both'"></ion-icon>
                </div>
                <div class="activity-details">
                  <span class="activity-title">{{ getLastTrackBreastSide() | titlecase }} Breast</span>
                  <span class="activity-time">{{ getLastTrackDate() }}</span>
                </div>
                <div class="activity-metric">
                  <span class="metric-value">{{ getDailySummaryPain() }}</span>
                  <span class="metric-label">Pain Level</span>
                </div>
              </div>
            </div>
            
            <!-- Recent Feeds -->
            <div class="recent-activities" *ngIf="recentRecords$ | async as recentRecords; else noRecentFeeds">
              <h4 class="activities-title">Recent Feeds</h4>
              <div class="recent-feeds-list">
                <div *ngFor="let record of recentRecords | slice:0:3" class="feed-record-wrapper">
                  
                  <!-- Direct Feed -->
                  <div *ngIf="record.directFeedDetails" class="feed-record direct-feed">
                    <div class="feed-time-container">
                      <div class="feed-time">{{ record.directFeedDetails.startTime || '--' }}</div>
                    </div>
                    <div class="feed-content">
                      <div class="feed-main-info">
                        <div class="feed-icon-label">
                          <ion-icon name="ellipse" *ngIf="record.directFeedDetails.breastSide === 'both'"></ion-icon>
                          <ion-icon name="radio-button-on" *ngIf="record.directFeedDetails.breastSide !== 'both'"></ion-icon>
                          <span class="feed-type">{{ record.directFeedDetails.breastSide | titlecase }}</span>
                        </div>
                        <div class="feed-metric">
                          <span class="pain-value">{{ record.directFeedDetails.painLevel || 0 }}/10</span>
                        </div>
                      </div>
                      <div class="feed-date">{{ formatDate(record.date) }}</div>
                    </div>
                  </div>

                  <!-- Expressed Milk Feed -->
                  <div *ngIf="record.expressedMilkDetails" class="feed-record expressed-feed">
                    <div class="feed-time-container">
                      <div class="feed-time">{{ formatTime(record.date) }}</div>
                    </div>
                    <div class="feed-content">
                      <div class="feed-main-info">
                        <div class="feed-icon-label">
                          <ion-icon name="water"></ion-icon>
                          <span class="feed-type">Expressed Milk</span>
                        </div>
                        <div class="feed-metric">
                          <span class="volume-value">{{ record.expressedMilkDetails.quantity || 0 }}ml</span>
                        </div>
                      </div>
                      <div class="feed-date">{{ formatDate(record.date) }}</div>
                    </div>
                  </div>

                  <!-- Formula Feed -->
                  <div *ngIf="record.formulaDetails" class="feed-record formula-feed">
                    <div class="feed-time-container">
                      <div class="feed-time">{{ formatTime(record.date) }}</div>
                    </div>
                    <div class="feed-content">
                      <div class="feed-main-info">
                        <div class="feed-icon-label">
                          <ion-icon name="nutrition"></ion-icon>
                          <span class="feed-type">Formula</span>
                        </div>
                        <div class="feed-metric">
                          <span class="volume-value">{{ record.formulaDetails.quantity || 0 }}ml</span>
                        </div>
                      </div>
                      <div class="feed-date">{{ formatDate(record.date) }}</div>
                    </div>
                  </div>

                </div>
              </div>
            </div>
            
            <ng-template #noRecentFeeds>
              <div class="empty-activities">
                <ion-icon name="body"></ion-icon>
                <p>No recent feeds tracked</p>
              </div>
            </ng-template>
          </div>
        </div>

        <!-- Pumping Section -->
        <div class="journey-section pumping-section">
          <div class="section-header">
            <div class="section-title-icon">
              <img src="assets/Pumping journey.svg" alt="Pumping Journey" class="section-svg-icon">
              <h3>Pumping Journey</h3>
            </div>
            <div class="section-summary">
              <span class="last-pump-time">Last: {{ getLastPumpTime() }}</span>
            </div>
          </div>
          
          <div class="section-content">
            <!-- Last Pump Summary -->
            <div class="last-activity-card">
              <div class="activity-header">
                <div class="activity-icon pumping">
                  <ion-icon name="ellipse" *ngIf="getLastPumpSide() === 'both'"></ion-icon>
                  <ion-icon name="radio-button-on" *ngIf="getLastPumpSide() !== 'both'"></ion-icon>
                </div>
                <div class="activity-details">
                  <span class="activity-title">{{ getLastPumpSide() | titlecase }} Pump</span>
                  <span class="activity-time">Latest session</span>
                </div>
                <div class="activity-metric">
                  <span class="metric-value">{{ getLastPumpOutput() }}</span>
                  <span class="metric-label">ml output</span>
                </div>
              </div>
            </div>
            
            <!-- Recent Pumping Sessions -->
            <div class="recent-activities" *ngIf="pumpingRecords$ | async as pumpingRecords; else noRecentPumps">
              <h4 class="activities-title">Recent Sessions</h4>
              <div class="activities-list">
                <div *ngFor="let record of pumpingRecords | slice:0:3" class="activity-item pump-item">
                  <div class="pump-session-header">
                    <div class="session-time">{{ getPumpingTime(record) }}</div>
                    <div class="session-date">{{ getPumpingDate(record) }}</div>
                  </div>
                  
                  <div class="session-details">
                    <div class="pump-info">
                      <ion-icon name="ellipse" *ngIf="getPumpingSide(record) === 'both'"></ion-icon>
                      <ion-icon name="radio-button-on" *ngIf="getPumpingSide(record) !== 'both'"></ion-icon>
                      <span class="pump-side">{{ getPumpingSide(record) | titlecase }} breast</span>
                      <div class="pump-output">
                        <ion-icon name="water"></ion-icon>
                        <span>{{ getPumpingOutput(record) }}ml</span>
                      </div>
                    </div>
                  </div>
                  
                  <div class="pump-notes" *ngIf="getPumpingNotes(record)">
                    <ion-icon name="document-text-outline"></ion-icon>
                    <span>{{ getPumpingNotes(record) }}</span>
                  </div>
                </div>
              </div>
            </div>
            
            <ng-template #noRecentPumps>
              <div class="empty-activities">
                <ion-icon name="medical"></ion-icon>
                <p>No recent pump sessions</p>
              </div>
            </ng-template>
          </div>
        </div>

        <!-- Emotional Wellness Section -->
        <div class="journey-section emotion-section">
          <div class="section-header">
            <div class="section-title-icon">
              <img src="assets/Emotional wellness.svg" alt="Emotional Wellness" class="section-svg-icon">
              <h3>Emotional Wellness</h3>
            </div>
            <div class="section-summary">
              <span class="last-checkin-time">Last: {{ getLastEmotionCheckinDate() }}</span>
            </div>
          </div>
          
          <div class="section-content">
            <!-- Emotional Wellness Card -->
            <div class="last-activity-card">
              <div class="activity-header">
                <div class="activity-icon emotion">
                  <ion-icon name="heart"></ion-icon>
                </div>
                <div class="activity-details">
                  <span class="activity-title">Emotional Check-in</span>
                  <span class="activity-time">Track your feelings daily</span>
                </div>
                <div class="activity-metric">
                  <span class="metric-value">{{ getEmotionCheckinsCount() }}</span>
                  <span class="metric-label">This week</span>
                </div>
              </div>
            </div>
            
            <!-- Recent Emotion Check-ins -->
            <div class="recent-activities" *ngIf="getRecentEmotionCheckins().length > 0; else noRecentEmotions">
              <h4 class="activities-title">Recent Check-ins</h4>
              <div class="activities-list">
                <div *ngFor="let record of getRecentEmotionCheckins()" class="activity-item emotion-item">
                  <div class="activity-time-badge">{{ getEmotionCheckinTime(record) }}</div>
                  <div class="activity-info">
                    <div class="activity-details">
                      <ion-icon name="heart"></ion-icon>
                      <span>{{ getEmotionCheckinMood(record) }}</span>
                    </div>
                    <div class="emotion-indicator" *ngIf="record.struggles && record.struggles.length > 0">
                      <span class="struggle-count">{{ record.struggles.length }} concern(s)</span>
                    </div>
                  </div>
                  <div class="activity-date">{{ getEmotionCheckinDate(record) }}</div>
                </div>
              </div>
            </div>
            
            <ng-template #noRecentEmotions>
              <!-- Wellness Tips (shown when no check-ins) -->
              <div class="wellness-tips">
                <h4 class="tips-title">üí° Wellness Tips</h4>
                <div class="tips-list">
                  <div class="tip-item">
                    <span class="tip-emoji">üßò‚Äç‚ôÄÔ∏è</span>
                    <span class="tip-text">Take 5 minutes daily for yourself</span>
                  </div>
                  <div class="tip-item">
                    <span class="tip-emoji">üí™</span>
                    <span class="tip-text">Celebrate small victories in your journey</span>
                  </div>
                  <div class="tip-item">
                    <span class="tip-emoji">ü§ù</span>
                    <span class="tip-text">Connect with other mothers for support</span>
                  </div>
                </div>
              </div>
            </ng-template>
          </div>
        </div>
      </div>
    </div>

  </div>

  <!-- Baby Selector Modal (preserved) -->
  <ion-modal [isOpen]="showBabySelector" (didDismiss)="closeBabySelector()">
    <ng-template>
      <ion-header>
        <ion-toolbar>
          <ion-title>Select Baby</ion-title>
          <ion-buttons slot="end">
            <ion-button (click)="closeBabySelector()">
              <ion-icon name="close" slot="icon-only"></ion-icon>
            </ion-button>
          </ion-buttons>
        </ion-toolbar>
      </ion-header>
      
      <ion-content>
        <div class="baby-selector-content">
          <div class="baby-selector-header">
            <h3>Choose which baby to track</h3>
            <p>Select the baby you want to add data for</p>
          </div>
          
          <div class="babies-list">
            <div 
              *ngFor="let baby of user?.babies"
              class="baby-option"
              [class.selected]="selectedBaby?.id === baby.id"
              (click)="selectBaby(baby)">
              <div class="baby-option-avatar">
                <img [src]="getBabyIconUrl(baby.gender)" alt="Baby" style="width: 32px; height: 32px;">
              </div>
              <div class="baby-option-info">
                <h4>{{ baby.name }}</h4>
                <p>{{ baby.gender | titlecase }}</p>
                <p class="baby-age">{{ calculateBabyAge() }}</p>
              </div>
              <ion-icon name="checkmark-circle" class="selected-icon" *ngIf="selectedBaby?.id === baby.id"></ion-icon>
            </div>
          </div>
        </div>
      </ion-content>
    </ng-template>
  </ion-modal>

  <!-- Daily Record Modal (preserved) -->
  <ion-modal [isOpen]="showAddRecordModal" (didDismiss)="closeAddRecordModal()">
    <ng-template>
      <ion-header>
        <ion-toolbar>
          <ion-title>Add Daily Record</ion-title>
          <ion-buttons slot="end">
            <ion-button (click)="closeAddRecordModal()">
              <ion-icon name="close" slot="icon-only"></ion-icon>
            </ion-button>
          </ion-buttons>
        </ion-toolbar>
      </ion-header>
      
      <ion-content>
        <form [formGroup]="addRecordForm" class="add-record-form">
          
          <!-- Baby Info Header -->
          <div class="baby-info-header" *ngIf="selectedBaby">
            <div class="baby-avatar">
              <img [src]="getBabyIconUrl(selectedBaby.gender)" alt="Baby" style="width: 32px; height: 32px;">
            </div>
            <div class="baby-details">
              <h3>{{ selectedBaby.name }}</h3>
              <p>{{ calculateBabyAge() }}</p>
            </div>
          </div>

          <!-- Smart Voice Input Section -->
          <div class="smart-voice-section" *ngIf="isVoiceSupported()">
            <div class="voice-input-header">
              <h5>üé§ Smart Voice Input</h5>
              <p>Say something like: "Baby fed 8 times today, each session lasted 20 minutes, pumped 3 times and got 150ml total"</p>
            </div>
            
            <ion-button 
              expand="block" 
              fill="outline" 
              (click)="startSmartVoiceInput()"
              [disabled]="isRecording || isProcessingVoice"
              class="smart-voice-button">
              <ion-icon [name]="isRecording ? 'stop' : 'mic'" slot="start"></ion-icon>
              <span *ngIf="!isRecording && !isProcessingVoice">Start Voice Input</span>
              <span *ngIf="isRecording">Listening...</span>
              <span *ngIf="isProcessingVoice">Processing...</span>
            </ion-button>
            
            <div class="voice-status" *ngIf="voiceTranscript || isProcessingVoice">
              <div class="voice-transcript" *ngIf="voiceTranscript">
                <h6>Voice Input:</h6>
                <p>"{{ voiceTranscript }}"</p>
              </div>
              
              <div class="voice-summary">
                <p class="summary-text">{{ getVoiceInputSummary() }}</p>
                <ion-button fill="clear" size="small" (click)="clearVoiceInput()">
                  <ion-icon name="close" slot="icon-only"></ion-icon>
                </ion-button>
              </div>
            </div>
            
            <div class="voice-examples">
              <h6>Example phrases:</h6>
              <ul>
                <li>"Baby fed 6 times today, feeling great"</li>
                <li>"Pumped 4 times and got 200ml, baby seems happy"</li>
                <li>"Had 8 wet diapers and 3 dirty ones, feeling tired"</li>
              </ul>
            </div>
          </div>

          <!-- Breastfeeding Time -->
          <div class="form-section">
            <h4>Breastfeeding time ?</h4>
            
            <div class="form-row">
              <div class="form-group half-width">
                <label class="field-label">Start</label>
                <ion-item lines="none" class="input-item time-input">
                  <ion-input
                    formControlName="startTime"
                    type="time"
                    [class.error]="addRecordForm.get('startTime')?.invalid && addRecordForm.get('startTime')?.touched">
                  </ion-input>
                </ion-item>
                <div class="error-message" *ngIf="addRecordForm.get('startTime')?.invalid && addRecordForm.get('startTime')?.touched">
                  {{ getErrorMessage('startTime') }}
                </div>
              </div>
              
              <div class="form-group half-width">
                <label class="field-label">End</label>
                <ion-item lines="none" class="input-item time-input">
                  <ion-input
                    formControlName="endTime"
                    type="time"
                    [class.error]="addRecordForm.get('endTime')?.invalid && addRecordForm.get('endTime')?.touched">
                  </ion-input>
                </ion-item>
                <div class="error-message" *ngIf="addRecordForm.get('endTime')?.invalid && addRecordForm.get('endTime')?.touched">
                  {{ getErrorMessage('endTime') }}
                </div>
              </div>
            </div>
          </div>

          <!-- Breast Side Selection -->
          <div class="form-section">
            <h4>Breast side ?</h4>
            <div class="selection-grid breast-side-grid">
              <div 
                *ngFor="let side of breastSideOptions"
                class="selection-option breast-side-option"
                [class.selected]="selectedBreastSide?.value === side.value"
                (click)="selectBreastSide(side)">
                <div class="breast-side-icon">
                  <ion-icon [name]="side.icon"></ion-icon>
                </div>
                <span class="option-label">{{ side.label }}</span>
              </div>
            </div>
          </div>

          <!-- Supplement Selection -->

          <!-- Pain Level -->
          <div class="form-section">
            <h4>Pain ?</h4>
            <p class="section-note">Consider 0 is no pain and 10 is a lot of pain</p>
            
            <div class="pain-level-container">
              <div class="pain-level-display">{{ painLevel }}</div>
              <ion-range
                min="0"
                max="10"
                step="1"
                [(ngModel)]="painLevel"
                (ionInput)="setPainLevel($event.detail.value)"
                color="secondary"
                class="pain-slider">
                <ion-label slot="start">0</ion-label>
                <ion-label slot="end">10</ion-label>
              </ion-range>
            </div>
          </div>

          <!-- Lipstick Shape -->
          <div class="form-section">
            <h4>Lipstick ?</h4>
            <p class="section-note">It can change after the feed</p>
            <div class="selection-grid lipstick-grid">
              <div 
                *ngFor="let shape of lipstickShapeOptions"
                class="selection-option lipstick-option"
                [class.selected]="selectedLipstickShape?.value === shape.value"
                (click)="selectLipstickShape(shape)">
                <div class="lipstick-icon">
                  <ion-icon [name]="shape.icon"></ion-icon>
                </div>
                <span class="option-label">{{ shape.label }}</span>
              </div>
            </div>
          </div>

          <!-- How do you feel -->
          <div class="form-section">
            <h4>How do you feel? ?</h4>
            <div class="selection-grid mood-grid">
              <div 
                *ngFor="let mood of motherMoodOptions"
                class="selection-option mood-option"
                [class.selected]="selectedMotherMood?.value === mood.value"
                (click)="selectMotherMood(mood)">
                <div class="mood-emoji-circle">{{ mood.emoji }}</div>
                <span class="option-label">{{ mood.label }}</span>
              </div>
            </div>
          </div>

          <!-- Notes -->
          <div class="form-section">
            <h4>Your notes ?</h4>
            <div class="form-group">
              <ion-item lines="none" class="input-item">
                <ion-textarea
                  formControlName="notes"
                  placeholder="Write here more about your feed"
                  rows="3"
                  autoGrow="true">
                </ion-textarea>
              </ion-item>
            </div>
          </div>

          <!-- Form Actions -->
          <div class="form-actions">
            <ion-button 
              expand="block" 
              (click)="saveGrowthRecord()"
              [disabled]="!addRecordForm.valid || !selectedBreastSide || !selectedMotherMood"
              class="save-button">
              Accept
            </ion-button>
          </div>
        </form>
      </ion-content>
    </ng-template>
  </ion-modal>


  <!-- Stool Track Modal (preserved) -->

  <!-- Diaper Log Modal -->
  <!-- <ion-modal [isOpen]="showDiaperLogModal" (didDismiss)="closeDiaperLogModal()">
    <ng-template>
      <app-diaper-log-modal (ionModalDidDismiss)="closeDiaperLogModal()">
      </app-diaper-log-modal>
    </ng-template>
  </ion-modal> -->

  <!-- Pumping Log Modal -->
  <!-- <ion-modal [isOpen]="showAddPumpingModal" (didDismiss)="closeAddPumpingModal()">
    <ng-template>
      <app-pumping-log-modal (ionModalDidDismiss)="closeAddPumpingModal()">
      </app-pumping-log-modal>
    </ng-template>
  </ion-modal> -->
</ion-content>