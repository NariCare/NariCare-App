<ion-header [translucent]="true">
  <ion-toolbar>
    <ion-title>Breastfeeding Progress</ion-title>
    <ion-buttons slot="end">
      <ion-button (click)="selectedTab === 'daily' ? openAddDailyRecordModal() : openAddWeightModal()">
        <ion-icon name="add" slot="icon-only"></ion-icon>
      </ion-button>
    </ion-buttons>
  </ion-toolbar>
</ion-header>

<ion-content [fullscreen]="true">
  <div class="content-container">
    
    <!-- Baby Info Header -->
    <div class="baby-info-card" *ngIf="user && user.babies && user.babies.length > 0">
      <div class="baby-avatar">
        <ion-icon name="baby"></ion-icon>
      </div>
      <div class="baby-details">
        <h2>{{ user.babies[0].name }}</h2>
        <p>{{ calculateBabyAge() }}</p>
        <p class="birth-info">Born {{ formatDate(user.babies[0].dateOfBirth) }}</p>
      </div>
    </div>

    <!-- Tab Selector -->
    <div class="tab-selector">
      <ion-segment [(ngModel)]="selectedTab" (ionChange)="onTabChange($event)">
        <ion-segment-button value="daily">
          <ion-label>Daily Tracking</ion-label>
        </ion-segment-button>
        <ion-segment-button value="weight">
          <ion-label>Weekly Weight</ion-label>
        </ion-segment-button>
      </ion-segment>
    </div>

    <!-- Daily Tracking Tab -->
    <div class="tab-content" *ngIf="selectedTab === 'daily'">
      <!-- Recent Daily Records -->
      <div class="section">
        <h3 class="section-title">Recent Daily Records</h3>
        <div class="records-list" *ngIf="growthRecords$ | async as records; else noDailyRecords">
          <div *ngFor="let record of records | slice:0:7" class="daily-record-card">
            <div class="record-header">
              <span class="record-date">{{ formatDate(record.date) }}</span>
              <div class="mood-indicator" *ngIf="record.emotionalState">
                <span class="mood-emoji">{{ record.emotionalState.emoji }}</span>
                <span class="mood-label">{{ getMoodLabel(record.emotionalState.mood) }}</span>
              </div>
            </div>
            <div class="feeding-metrics">
              <div class="metric-row">
                <div class="metric">
                  <span class="metric-label">Direct Feeding</span>
                  <span class="metric-value">{{ record.directFeedingSessions }} sessions</span>
                </div>
                <div class="metric">
                  <span class="metric-label">Avg Duration</span>
                  <span class="metric-value">{{ record.avgFeedingDuration }} min</span>
                </div>
              </div>
              <div class="metric-row">
                <div class="metric">
                  <span class="metric-label">Pumping</span>
                  <span class="metric-value">{{ record.pumpingSessions }} sessions</span>
                </div>
                <div class="metric">
                  <span class="metric-label">Output</span>
                  <span class="metric-value">{{ record.totalPumpingOutput }} ml</span>
                </div>
              </div>
              <div class="metric-row">
                <div class="metric">
                  <span class="metric-label">Formula</span>
                  <span class="metric-value">{{ record.formulaIntake }} ml</span>
                </div>
                <div class="metric">
                  <span class="metric-label">Diapers</span>
                  <span class="metric-value">{{ record.peeCount }}ðŸ’§ {{ record.poopCount }}ðŸ’©</span>
                </div>
              </div>
            </div>
            <div class="record-notes" *ngIf="record.notes">
              <p>{{ record.notes }}</p>
            </div>
          </div>
        </div>
        
        <ng-template #noDailyRecords>
          <div class="empty-state">
            <ion-icon name="calendar"></ion-icon>
            <h4>No daily records yet</h4>
            <p>Start tracking your breastfeeding journey by adding your first daily record</p>
            <ion-button fill="outline" (click)="openAddDailyRecordModal()">
              Add Daily Record
            </ion-button>
          </div>
        </ng-template>
      </div>
    </div>

    <!-- Weight Tracking Tab -->
    <div class="tab-content" *ngIf="selectedTab === 'weight'">
      <!-- Chart Placeholder -->
      <div class="chart-container">
        <div class="chart-header">
          <h3>Weight Progress Chart</h3>
          <span class="chart-unit">kg</span>
        </div>
        <div class="chart-placeholder">
          <ion-icon name="analytics"></ion-icon>
          <p>Weight chart visualization will appear here</p>
          <p class="chart-note">Add weekly weight records to see growth trends</p>
        </div>
      </div>

      <!-- Recent Weight Records -->
      <div class="section">
        <h3 class="section-title">Recent Weight Records</h3>
        <div class="records-list" *ngIf="weightRecords$ | async as records; else noWeightRecords">
          <div *ngFor="let record of records | slice:0:10" class="weight-record-card">
            <div class="record-date">
              <span class="date">{{ formatDate(record.date) }}</span>
            </div>
            <div class="weight-info">
              <span class="weight-value">{{ record.weight }} kg</span>
              <span class="weight-change" *ngIf="records.indexOf(record) < records.length - 1">
                <!-- Weight change calculation would go here -->
              </span>
            </div>
            <div class="record-notes" *ngIf="record.notes">
              <p>{{ record.notes }}</p>
            </div>
          </div>
        </div>
        
        <ng-template #noWeightRecords>
          <div class="empty-state">
            <ion-icon name="scale"></ion-icon>
            <h4>No weight records yet</h4>
            <p>Start tracking your baby's weight weekly to monitor healthy growth</p>
            <ion-button fill="outline" (click)="openAddWeightModal()">
              Add Weight Record
            </ion-button>
          </div>
        </ng-template>
      </div>
    </div>

  </div>

  <!-- Add Daily Record Modal -->
  <ion-modal [isOpen]="showAddDailyRecordModal" (didDismiss)="closeAddDailyRecordModal()">
    <ng-template>
      <ion-header>
        <ion-toolbar>
          <ion-title>Add Daily Record</ion-title>
          <ion-buttons slot="end">
            <ion-button (click)="closeAddDailyRecordModal()">
              <ion-icon name="close" slot="icon-only"></ion-icon>
            </ion-button>
          </ion-buttons>
        </ion-toolbar>
      </ion-header>
      
      <ion-content>
        <form [formGroup]="addRecordForm" class="add-daily-record-form">
          <div class="form-section">
            <h4>Date</h4>
            
            <div class="form-group">
              <ion-item lines="none" class="input-item">
                <ion-icon name="calendar-outline" slot="start" class="input-icon"></ion-icon>
                <ion-datetime-button datetime="dailyRecordDate">
                  <ion-label>Date</ion-label>
                </ion-datetime-button>
              </ion-item>
              <ion-modal [keepContentsMounted]="true">
                <ng-template>
                  <ion-datetime 
                    id="dailyRecordDate" 
                    formControlName="date"
                    presentation="date"
                    max="2025-12-31"
                    min="2020-01-01">
                  </ion-datetime>
                </ng-template>
              </ion-modal>
            </div>
          </div>

          <div class="form-section">
            <h4>Direct Breastfeeding</h4>
            
            <div class="form-row">
              <div class="form-group half-width">
                <ion-item lines="none" class="input-item">
                  <ion-input
                    formControlName="directFeedingSessions"
                    type="number"
                    placeholder="Sessions in 24h"
                    [class.error]="addRecordForm.get('directFeedingSessions')?.invalid && addRecordForm.get('directFeedingSessions')?.touched">
                  </ion-input>
                </ion-item>
                <div class="error-message" *ngIf="addRecordForm.get('directFeedingSessions')?.invalid && addRecordForm.get('directFeedingSessions')?.touched">
                  {{ getErrorMessage('directFeedingSessions') }}
                </div>
              </div>
              
              <div class="form-group half-width">
                <ion-item lines="none" class="input-item">
                  <ion-input
                    formControlName="avgFeedingDuration"
                    type="number"
                    placeholder="Avg duration (min)"
                    [class.error]="addRecordForm.get('avgFeedingDuration')?.invalid && addRecordForm.get('avgFeedingDuration')?.touched">
                  </ion-input>
                </ion-item>
                <div class="error-message" *ngIf="addRecordForm.get('avgFeedingDuration')?.invalid && addRecordForm.get('avgFeedingDuration')?.touched">
                  {{ getErrorMessage('avgFeedingDuration') }}
                </div>
              </div>
            </div>
          </div>

          <div class="form-section">
            <h4>Pumping</h4>
            
            <div class="form-row">
              <div class="form-group half-width">
                <ion-item lines="none" class="input-item">
                  <ion-input
                    formControlName="pumpingSessions"
                    type="number"
                    placeholder="Sessions in 24h"
                    [class.error]="addRecordForm.get('pumpingSessions')?.invalid && addRecordForm.get('pumpingSessions')?.touched">
                  </ion-input>
                </ion-item>
                <div class="error-message" *ngIf="addRecordForm.get('pumpingSessions')?.invalid && addRecordForm.get('pumpingSessions')?.touched">
                  {{ getErrorMessage('pumpingSessions') }}
                </div>
              </div>
              
              <div class="form-group half-width">
                <ion-item lines="none" class="input-item">
                  <ion-input
                    formControlName="totalPumpingOutput"
                    type="number"
                    placeholder="Total output (ml)"
                    [class.error]="addRecordForm.get('totalPumpingOutput')?.invalid && addRecordForm.get('totalPumpingOutput')?.touched">
                  </ion-input>
                </ion-item>
                <div class="error-message" *ngIf="addRecordForm.get('totalPumpingOutput')?.invalid && addRecordForm.get('totalPumpingOutput')?.touched">
                  {{ getErrorMessage('totalPumpingOutput') }}
                </div>
              </div>
            </div>
          </div>

          <div class="form-section">
            <h4>Formula & Diapers</h4>
            
            <div class="form-row">
              <div class="form-group half-width">
                <ion-item lines="none" class="input-item">
                  <ion-input
                    formControlName="formulaIntake"
                    type="number"
                    placeholder="Formula (ml)"
                    [class.error]="addRecordForm.get('formulaIntake')?.invalid && addRecordForm.get('formulaIntake')?.touched">
                  </ion-input>
                </ion-item>
                <div class="error-message" *ngIf="addRecordForm.get('formulaIntake')?.invalid && addRecordForm.get('formulaIntake')?.touched">
                  {{ getErrorMessage('formulaIntake') }}
                </div>
              </div>
              
              <div class="form-group half-width">
                <ion-item lines="none" class="input-item">
                  <ion-input
                    formControlName="peeCount"
                    type="number"
                    placeholder="Pee count"
                    [class.error]="addRecordForm.get('peeCount')?.invalid && addRecordForm.get('peeCount')?.touched">
                  </ion-input>
                </ion-item>
                <div class="error-message" *ngIf="addRecordForm.get('peeCount')?.invalid && addRecordForm.get('peeCount')?.touched">
                  {{ getErrorMessage('peeCount') }}
                </div>
              </div>
            </div>

            <div class="form-group">
              <ion-item lines="none" class="input-item">
                <ion-input
                  formControlName="poopCount"
                  type="number"
                  placeholder="Poop count"
                  [class.error]="addRecordForm.get('poopCount')?.invalid && addRecordForm.get('poopCount')?.touched">
                </ion-input>
              </ion-item>
              <div class="error-message" *ngIf="addRecordForm.get('poopCount')?.invalid && addRecordForm.get('poopCount')?.touched">
                {{ getErrorMessage('poopCount') }}
              </div>
            </div>
          </div>

          <div class="form-section">
            <h4>How are you feeling today? (Optional)</h4>
            <div class="mood-selector">
              <div 
                *ngFor="let mood of moodOptions"
                class="mood-option"
                [class.selected]="isMoodSelected(mood.value)"
                (click)="selectMood(mood.value)">
                <span class="mood-emoji">{{ mood.emoji }}</span>
                <span class="mood-label">{{ mood.label }}</span>
              </div>
            </div>
            <div class="form-group" *ngIf="addRecordForm.get('mood')?.value">
              <ion-item lines="none" class="input-item">
                <ion-textarea
                  formControlName="moodDescription"
                  placeholder="Tell us more about how you're feeling... (optional)"
                  rows="2"
                  maxlength="200">
                </ion-textarea>
              </ion-item>
            </div>
          </div>

          <div class="form-section">
            <h4>Notes</h4>
            <div class="form-group">
              <ion-item lines="none" class="input-item">
                <ion-textarea
                  formControlName="notes"
                  placeholder="Any observations or notes..."
                  rows="3"
                  maxlength="500">
                </ion-textarea>
              </ion-item>
            </div>
          </div>

          <div class="form-actions">
            <ion-button 
              expand="block" 
              (click)="saveGrowthRecord()"
              [disabled]="!addRecordForm.valid"
              class="save-daily-button">
              Save Daily Record
            </ion-button>
          </div>
        </form>
      </ion-content>
    </ng-template>
  </ion-modal>

  <!-- Add Weight Record Modal -->
  <ion-modal [isOpen]="showAddWeightModal" (didDismiss)="closeAddWeightModal()">
    <ng-template>
      <ion-header>
        <ion-toolbar>
          <ion-title>Add Weight Record</ion-title>
          <ion-buttons slot="end">
            <ion-button (click)="closeAddWeightModal()">
              <ion-icon name="close" slot="icon-only"></ion-icon>
            </ion-button>
          </ion-buttons>
        </ion-toolbar>
      </ion-header>
      
      <ion-content>
        <form [formGroup]="addWeightForm" class="add-weight-form">
          <div class="form-section">
            <h4>Weight Measurement</h4>
            
            <div class="form-group">
              <ion-item lines="none" class="input-item">
                <ion-icon name="calendar-outline" slot="start" class="input-icon"></ion-icon>
                <ion-datetime-button datetime="weightRecordDate">
                  <ion-label>Date</ion-label>
                </ion-datetime-button>
              </ion-item>
              <ion-modal [keepContentsMounted]="true">
                <ng-template>
                  <ion-datetime 
                    id="weightRecordDate" 
                    formControlName="date"
                    presentation="date"
                    max="2025-12-31"
                    min="2020-01-01">
                  </ion-datetime>
                </ng-template>
            <div class="form-group">
              <ion-item lines="none" class="input-item">
                <ion-input
                  formControlName="weight"
                  type="number"
                  placeholder="Weight (kg)"
                  step="0.1"
                  [class.error]="addWeightForm.get('weight')?.invalid && addWeightForm.get('weight')?.touched">
                </ion-input>
              </ion-item>
              <div class="error-message" *ngIf="addWeightForm.get('weight')?.invalid && addWeightForm.get('weight')?.touched">
                Weight is required and must be between 0.5kg and 50kg
              </div>
            </div>
          </div>
              </ion-modal>
          <div class="form-section">
            <h4>Notes (Optional)</h4>
            <div class="form-group">
              <ion-item lines="none" class="input-item">
                <ion-textarea
                  formControlName="notes"
                  placeholder="Any observations about baby's weight..."
                  rows="3"
                  maxlength="300">
                </ion-textarea>
              </ion-item>
            </div>
          </div>
            </div>
          <div class="form-actions">
            <ion-button 
              expand="block" 
              (click)="saveWeightRecord()"
              [disabled]="!addWeightForm.valid"
              class="save-weight-button">
              Save Weight Record
            </ion-button>
          </div>
        </form>
      </ion-content>
    </ng-template>
  </ion-modal>
</ion-content>