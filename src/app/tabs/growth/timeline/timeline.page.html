<ion-header [translucent]="true">
  <ion-toolbar>
    <ion-buttons slot="start">
      <ion-button (click)="goBack()" class="header-button">
        <ion-icon name="arrow-back" slot="icon-only"></ion-icon>
      </ion-button>
    </ion-buttons>
    <ion-title (click)="openBabySelector()" class="baby-title-selector">
      <div class="title-content">
        <span>{{ selectedBaby?.name || 'Baby' }}'s Timeline</span>
        <ion-icon name="chevron-down" class="dropdown-icon" *ngIf="user && user.babies && user.babies.length > 1"></ion-icon>
      </div>
    </ion-title>
  </ion-toolbar>
</ion-header>

<ion-content [fullscreen]="true">
  <div class="timeline-page-container" *ngIf="timelineData$ | async as timelineData">
    
    <!-- Baby Selector Card -->
    <div class="baby-selector-card" *ngIf="user && user.babies && user.babies.length > 1">
      <div class="baby-info">
        <div class="baby-avatar">
          <ion-icon name="baby"></ion-icon>
        </div>
        <div class="baby-details">
          <h3>{{ selectedBaby?.name || 'Baby' }}</h3>
          <p>{{ calculateBabyAge() }}</p>
          <p class="birth-date">Born {{ formatDate(selectedBaby?.dateOfBirth) }}</p>
        </div>
      </div>
      <ion-button fill="clear" (click)="openBabySelector()" class="switch-baby-button">
        <ion-icon name="swap-horizontal" slot="start"></ion-icon>
        Switch Baby
      </ion-button>
    </div>
    
    <!-- Current Week Header -->
    <!-- <div class="timeline-header">
      <div class="week-indicator">
        <div class="week-marker">
          <ion-icon name="location"></ion-icon>
        </div>
        <div class="week-info">
          <h2>Week {{ timelineData.currentWeek }}</h2>
          <p>{{ calculateBabyAge() }}</p>
        </div>
      </div>
    </div> -->

    <!-- Timeline Progress Bar -->
    <div class="timeline-progress-section">
      <div class="progress-bar">
        <div class="progress-fill" [style.width.%]="(timelineData.currentWeek / 52) * 100"></div>
        <div class="progress-marker" [style.left.%]="(timelineData.currentWeek / 52) * 100">
          <div class="marker-dot"></div>
        </div>
      </div>
      <div class="progress-labels">
        <span>Birth</span>
        <span>1 Year</span>
      </div>
    </div>

    <!-- Weekly Timeline Cards -->
    <div class="weekly-timeline">
      <div *ngFor="let item of timelineData.allWeeks; let i = index" 
           class="week-card"
           [class.current-week]="timelineData.currentWeek >= item.weekStart && timelineData.currentWeek <= item.weekEnd"
           [class.completed-week]="timelineData.currentWeek > item.weekEnd"
           [class.upcoming-week]="timelineData.currentWeek < item.weekStart"
           (click)="openSpecificWeek(item)">
        
        <!-- Week Number Badge -->
        <div class="week-badge" [style.background-color]="item.color">
          <span class="week-number">{{ item.weekStart }}</span>
          <span class="week-label">WEEK</span>
        </div>
        
        <!-- Card Content -->
        <div class="card-content">
          <div class="card-header">
            <div class="card-icon" [style.background-color]="item.color">
              <ion-icon [name]="item.icon"></ion-icon>
            </div>
            <div class="card-title-section">
              <h3>{{ item.title }}</h3>
              <ion-chip [color]="getCategoryColor(item.category)" size="small">
                {{ getCategoryLabel(item.category) }}
              </ion-chip>
            </div>
          </div>
          
          <p class="card-description">{{ item.description }}</p>
          
          <!-- Preview Content -->
          <div class="preview-content">
            
            <!-- What to Expect Preview -->
            <div class="content-preview" *ngIf="item.whatToExpected && item.whatToExpected.length > 0">
              <h4>ðŸ’• What to Expect:</h4>
              <p>{{ item.whatToExpected[0] }}</p>
              <span class="more-indicator" *ngIf="item.whatToExpected.length > 1">
                +{{ item.whatToExpected.length - 1 }} more
              </span>
            </div>
            
            <!-- Tips Preview -->
            <div class="content-preview" *ngIf="item.tips && item.tips.length > 0">
              <h4>âœ¨ Helpful Tips:</h4>
              <p>{{ item.tips[0] }}</p>
              <span class="more-indicator" *ngIf="item.tips.length > 1">
                +{{ item.tips.length - 1 }} more
              </span>
            </div>
            
            <!-- Video Links Preview -->
            <div class="content-preview video-preview" *ngIf="item.videoLinks && item.videoLinks.length > 0">
              <h4>ðŸŽ¥ Watch Milestones:</h4>
              <div class="video-thumbnails">
                <div 
                  *ngFor="let video of item.videoLinks | slice:0:2" 
                  class="video-thumbnail"
                  (click)="openVideo(video.url, video.title); $event.stopPropagation()">
                  <div class="thumbnail-image">
                    <img [src]="video.thumbnail" [alt]="video.title" *ngIf="video.thumbnail">
                    <div class="video-placeholder" *ngIf="!video.thumbnail">
                      <ion-icon name="play-circle"></ion-icon>
                    </div>
                    <div class="play-overlay">
                      <ion-icon name="play"></ion-icon>
                    </div>
                  </div>
                  <span class="video-title">{{ video.title }}</span>
                </div>
              </div>
              <span class="more-indicator" *ngIf="item.videoLinks.length > 2">
                +{{ item.videoLinks.length - 2 }} more videos
              </span>
            </div>
            
          </div>
          
        </div>
      </div>
    </div>
    
  </div>

  <!-- Baby Selector Modal -->
  <ion-modal [isOpen]="showBabySelector" (didDismiss)="closeBabySelector()">
    <ng-template>
      <ion-header>
        <ion-toolbar>
          <ion-title>Select Baby</ion-title>
          <ion-buttons slot="end">
            <ion-button (click)="closeBabySelector()">
              <ion-icon name="close" slot="icon-only"></ion-icon>
            </ion-button>
          </ion-buttons>
        </ion-toolbar>
      </ion-header>
      
      <ion-content>
        <div class="baby-selector-content">
          <div class="baby-selector-header">
            <h3>Choose which baby's timeline to view</h3>
            <p>Select the baby whose development timeline you want to explore</p>
          </div>
          
          <div class="babies-list">
            <div 
              *ngFor="let baby of user?.babies"
              class="baby-option"
              [class.selected]="selectedBaby?.id === baby.id"
              (click)="selectBaby(baby)">
              <div class="baby-option-avatar">
                <ion-icon name="baby"></ion-icon>
              </div>
              <div class="baby-option-info">
                <h4>{{ baby.name }}</h4>
                <p>{{ baby.gender | titlecase }}</p>
                <p class="baby-age">{{ calculateBabyAgeForBaby(baby.dateOfBirth) }}</p>
                <p class="birth-info">Born {{ formatDate(baby.dateOfBirth) }}</p>
              </div>
              <ion-icon name="checkmark-circle" class="selected-icon" *ngIf="selectedBaby?.id === baby.id"></ion-icon>
            </div>
          </div>
        </div>
      </ion-content>
    </ng-template>
  </ion-modal>
</ion-content>