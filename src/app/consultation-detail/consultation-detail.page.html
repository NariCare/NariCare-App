<ion-header [translucent]="true">
  <ion-toolbar>
    <ion-buttons slot="start">
      <ion-button (click)="goBack()">
        <ion-icon name="arrow-back"></ion-icon>
      </ion-button>
    </ion-buttons>
    <ion-title>Consultation Details</ion-title>
  </ion-toolbar>
</ion-header>

<ion-content [fullscreen]="true">
  <ion-header collapse="condense">
    <ion-toolbar>
      <ion-title size="large">Consultation Details</ion-title>
    </ion-toolbar>
  </ion-header>

  <div class="consultation-content" *ngIf="consultation">
    <!-- Consultation Summary Header -->
    <div class="consultation-header">
      <div class="consultation-info">
        <h2>{{ consultation.topic }}</h2>
        <div class="consultation-meta">
          <ion-chip [color]="getConsultationStatusColor()">
            <ion-label>{{ getConsultationStatusText() }}</ion-label>
          </ion-chip>
          <p class="consultation-date">{{ formatDate(consultation.scheduled_at) }}</p>
        </div>
        
        <div class="participants">
          <div class="participant">
            <ion-icon name="person-circle" color="primary"></ion-icon>
            <span>{{ currentUser?.role === 'expert' ? getUserName() : 'You' }}</span>
          </div>
          <div class="participant">
            <ion-icon name="medical" color="secondary"></ion-icon>
            <span>{{ currentUser?.role === 'expert' ? 'You' : getExpertName() }}</span>
            <span class="credentials" *ngIf="consultation.expert_credentials">
              {{ consultation.expert_credentials }}
            </span>
          </div>
        </div>
      </div>
    </div>

    <!-- Tab Navigation -->
    <div class="tab-navigation">
      <ion-segment [(ngModel)]="selectedTab" (ionChange)="onSegmentChange($event)">
        <ion-segment-button value="onboarding">
          <ion-label>Patient Information</ion-label>
          <ion-icon name="document-text"></ion-icon>
        </ion-segment-button>
        <ion-segment-button value="report">
          <ion-label>Consultation Report</ion-label>
          <ion-icon name="clipboard"></ion-icon>
        </ion-segment-button>
      </ion-segment>
    </div>

    <!-- Onboarding Data Tab -->
    <div class="tab-content" *ngIf="selectedTab === 'onboarding'">
      <div class="onboarding-data" *ngIf="onboardingData; else noOnboardingData">
        
        <!-- Personal Information -->
        <ion-card>
          <ion-card-header>
            <ion-card-title>
              <ion-icon name="person"></ion-icon>
              Personal Information
            </ion-card-title>
          </ion-card-header>
          <ion-card-content>
            <div class="info-grid">
              <div class="info-item">
                <strong>Name:</strong>
                <span>{{ getPersonalInfo().fullName }}</span>
              </div>
              <div class="info-item">
                <strong>Employment:</strong>
                <span>{{ formatValue(getPersonalInfo().employmentStatus, 'work_status') }}</span>
              </div>
              <div class="info-item" *ngIf="getPersonalInfo().languagesSpoken?.length">
                <strong>Languages:</strong>
                <span>{{ formatValue(getPersonalInfo().languagesSpoken) }}</span>
              </div>
            </div>
          </ion-card-content>
        </ion-card>

        <!-- Pregnancy & Baby Information -->
        <ion-card>
          <ion-card-header>
            <ion-card-title>
              <ion-icon name="heart"></ion-icon>
              Birth Information
            </ion-card-title>
          </ion-card-header>
          <ion-card-content>
            <div class="info-grid">
              <div class="info-item">
                <strong>Mother Type:</strong>
                <span>{{ formatValue(getPregnancyInfo().motherType) }}</span>
              </div>
              <div class="info-item" *ngIf="getPregnancyInfo().dueDate">
                <strong>Due Date:</strong>
                <span>{{ formatDate(getPregnancyInfo().dueDate) }}</span>
              </div>
              <div class="info-item">
                <strong>First Child:</strong>
                <span>{{ formatBoolean(getPregnancyInfo().isFirstChild) }}</span>
              </div>
              
              <!-- Babies Information -->
              <div class="babies-info-section" *ngIf="getPregnancyInfo().babies && getPregnancyInfo().babies.length > 0">
                <h4>{{ getPregnancyInfo().babies?.length > 1 ? 'Babies Information' : 'Baby Information' }}</h4>
                
                <!-- Loop through all babies -->
                <div class="baby-item" *ngFor="let baby of getPregnancyInfo().babies; let i = index">
                  <h5 *ngIf="getPregnancyInfo().babies?.length > 1">{{ baby.name || 'Baby ' + (i + 1) }}</h5>
                  
                  <div class="info-item">
                    <strong>Name:</strong>
                    <span>{{ baby.name || 'Not specified' }}</span>
                  </div>
                  <div class="info-item">
                    <strong>Date of Birth:</strong>
                    <span>{{ formatDate(baby.dateOfBirth) }}</span>
                  </div>
                  <div class="info-item">
                    <strong>Gender:</strong>
                    <span>{{ formatValue(baby.gender) }}</span>
                  </div>
                  <div class="info-item">
                    <strong>Birth Weight:</strong>
                    <span>{{ baby.birthWeight }} kg</span>
                  </div>
                  <div class="info-item">
                    <strong>Birth Height:</strong>
                    <span>{{ baby.birthHeight }} cm</span>
                  </div>
                  <div class="info-item">
                    <strong>Delivery Type:</strong>
                    <span>{{ formatValue(baby.deliveryType, 'birth_type') }}</span>
                  </div>
                  <div class="info-item">
                    <strong>Gestational Age:</strong>
                    <span>{{ baby.gestationalAge }} weeks</span>
                  </div>
                  <div class="info-item">
                    <strong>Current Weight:</strong>
                    <span>{{ baby.mostRecentWeight ? (baby.mostRecentWeight + ' kg') : 'Not specified' }}</span>
                  </div>
                  <div class="info-item">
                    <strong>Weight Check Date:</strong>
                    <span>{{ baby.dateOfMostRecentWeightCheck ? formatDate(baby.dateOfMostRecentWeightCheck) : 'Not specified' }}</span>
                  </div>
                  
                  <!-- Baby-specific feeding details -->
                  <div class="baby-feeding-section">
                    <h5>Feeding Details for {{ baby.name || ('Baby ' + (i + 1)) }}</h5>
                    
                    <div class="info-item">
                      <strong>Direct Breastfeeds per Day:</strong>
                      <span>{{ baby.directBreastfeedsIn24h || 0 }}</span>
                    </div>
                    <div class="info-item">
                      <strong>Latch Quality:</strong>
                      <span>{{ formatValue(baby.latchQuality) }}</span>
                    </div>
                    <div class="info-item">
                      <strong>Offers Both Breasts:</strong>
                      <span>{{ formatBoolean(baby.offersBothBreastsPerFeeding) }}</span>
                    </div>
                    <div class="info-item">
                      <strong>Time per Breast:</strong>
                      <span>{{ formatValue(baby.timePerBreast) }}</span>
                    </div>
                    
                    <!-- Baby Output -->
                    <div class="info-item">
                      <strong>Wet Diapers (24h):</strong>
                      <span>{{ baby.wetDiapersIn24h || 0 }}</span>
                    </div>
                    <div class="info-item">
                      <strong>Soiled Diapers (24h):</strong>
                      <span>{{ baby.dirtyDiapersIn24h || 0 }}</span>
                    </div>
                    
                    <!-- Formula feeding details -->
                    <div class="formula-details" *ngIf="baby.formulaTimesPerDay || baby.formulaAmountPerFeed || baby.formulaBrand">
                      <h6>Formula Details</h6>
                      <div class="info-item" *ngIf="baby.formulaBrand">
                        <strong>Formula Brand:</strong>
                        <span>{{ baby.formulaBrand }}{{ baby.formulaBrandOther ? (' - ' + baby.formulaBrandOther) : '' }}</span>
                      </div>
                      <div class="info-item" *ngIf="baby.formulaTimesPerDay">
                        <strong>Formula Times per Day:</strong>
                        <span>{{ baby.formulaTimesPerDay }}{{ baby.formulaTimesPerDay >= 8 ? '+' : '' }}</span>
                      </div>
                      <div class="info-item" *ngIf="baby.formulaAmountPerFeed">
                        <strong>Formula Amount per Feed:</strong>
                        <span>{{ baby.formulaAmountPerFeed }}{{ baby.formulaAmountPerFeed >= 120 ? '+' : '' }}ml</span>
                      </div>
                      <div class="info-item" *ngIf="baby.formulaReason">
                        <strong>Reason for Formula:</strong>
                        <span>{{ formatValue(baby.formulaReason) }}{{ baby.formulaReasonOther ? (' - ' + baby.formulaReasonOther) : '' }}</span>
                      </div>
                    </div>
                    
                    <!-- Baby-specific medical info -->
                    <div class="baby-medical" *ngIf="baby.medicalConditions || baby.hasBeenHospitalized !== undefined">
                      <h6>Medical Information</h6>
                      <div class="info-item" *ngIf="baby.medicalConditions">
                        <strong>Medical Conditions:</strong>
                        <span>{{ baby.medicalConditions }}</span>
                      </div>
                      <div class="info-item" *ngIf="baby.hasBeenHospitalized !== undefined">
                        <strong>Has Been Hospitalized:</strong>
                        <span>{{ formatBoolean(baby.hasBeenHospitalized) }}</span>
                      </div>
                      <div class="info-item" *ngIf="baby.hospitalizationReason">
                        <strong>Hospitalization Reason:</strong>
                        <span>{{ baby.hospitalizationReason }}</span>
                      </div>
                    </div>
                  </div>
                  
                  <!-- Separator for multiple babies -->
                  <hr *ngIf="i < getPregnancyInfo().babies?.length - 1" class="baby-separator">
                </div>
              </div>
            </div>
          </ion-card-content>
        </ion-card>

        <!-- Breastfeeding Information -->
        <ion-card>
          <ion-card-header>
            <ion-card-title>
              <ion-icon name="nutrition"></ion-icon>
              Breastfeeding Information
            </ion-card-title>
          </ion-card-header>
          <ion-card-content>
            <div class="info-grid">
              <div class="info-item">
                <strong>Experience Level:</strong>
                <span>{{ formatValue(getBreastfeedingInfo().experienceLevel) }}</span>
              </div>
              <div class="info-item">
                <strong>Currently Breastfeeding:</strong>
                <span>{{ formatBoolean(getBreastfeedingInfo().currentlyBreastfeeding) }}</span>
              </div>
              
              <!-- Breastfeeding details from main form -->
              <div class="breastfeeding-details" *ngIf="getBreastfeedingInfo().breastfeedingDetails">
                <h4>Breastfeeding Details</h4>
                <div class="info-item">
                  <strong>Direct Feeds per Day (main form):</strong>
                  <span>{{ getBreastfeedingInfo().breastfeedingDetails.directFeedsPerDay }}</span>
                </div>
                <div class="info-item">
                  <strong>Latch Quality (main form):</strong>
                  <span>{{ formatValue(getBreastfeedingInfo().breastfeedingDetails.latchQuality) }}</span>
                </div>
                <div class="info-item">
                  <strong>Offers Both Breasts (main form):</strong>
                  <span>{{ formatBoolean(getBreastfeedingInfo().breastfeedingDetails.offersBothBreasts) }}</span>
                </div>
                <div class="info-item">
                  <strong>Time per Breast (main form):</strong>
                  <span>{{ formatValue(getBreastfeedingInfo().breastfeedingDetails.timePerBreast) }}</span>
                </div>
                <div class="info-item">
                  <strong>Breastfeeding Duration Goal:</strong>
                  <span>{{ getBreastfeedingInfo().breastfeedingDetails.breastfeedingDuration || 'Not specified' }}</span>
                </div>
              </div>
              
              <!-- Baby Output -->
              <div class="baby-output" *ngIf="getBreastfeedingInfo().babyOutput">
                <h4>Baby Output (24h)</h4>
                <div class="info-item">
                  <strong>Pee Count:</strong>
                  <span>{{ getBreastfeedingInfo().babyOutput.peeCount24h }}</span>
                </div>
                <div class="info-item">
                  <strong>Poop Count:</strong>
                  <span>{{ getBreastfeedingInfo().babyOutput.poopCount24h }}</span>
                </div>
              </div>
            </div>
          </ion-card-content>
        </ion-card>

        <!-- Medical Information -->
        <ion-card>
          <ion-card-header>
            <ion-card-title>
              <ion-icon name="medical"></ion-icon>
              Medical Information
            </ion-card-title>
          </ion-card-header>
          <ion-card-content>
            <div class="info-grid">
              <div class="info-item" *ngIf="getMedicalInfo().motherMedicalConditions?.length">
                <strong>Mother's Medical Conditions:</strong>
                <span>{{ formatValue(getMedicalInfo().motherMedicalConditions) }}</span>
              </div>
              <div class="info-item" *ngIf="getMedicalInfo().allergies">
                <strong>Allergies:</strong>
                <span>{{ getMedicalInfo().allergies }}</span>
              </div>
              <div class="info-item" *ngIf="getMedicalInfo().motherMedicalConditionsOther">
                <strong>Other Medical Conditions:</strong>
                <span>{{ getMedicalInfo().motherMedicalConditionsOther }}</span>
              </div>
              <div class="info-item">
                <strong>Nipple Anatomical Issues:</strong>
                <span>{{ formatBoolean(getMedicalInfo().nippleAnatomicalIssues) }}</span>
              </div>
              <div class="info-item" *ngIf="getMedicalInfo().nippleIssuesDescription">
                <strong>Nipple Issues Description:</strong>
                <span>{{ getMedicalInfo().nippleIssuesDescription }}</span>
              </div>
              <div class="info-item" *ngIf="getMedicalInfo().babyMedicalConditions">
                <strong>Baby's Medical Conditions:</strong>
                <span>{{ getMedicalInfo().babyMedicalConditions }}</span>
              </div>
              <div class="info-item">
                <strong>Baby Hospitalized:</strong>
                <span>{{ formatBoolean(getMedicalInfo().babyHospitalized) }}</span>
              </div>
              <div class="info-item" *ngIf="getMedicalInfo().babyHospitalizationReason">
                <strong>Hospitalization Reason:</strong>
                <span>{{ getMedicalInfo().babyHospitalizationReason }}</span>
              </div>
            </div>
          </ion-card-content>
        </ion-card>

        <!-- Feeding Information -->
        <ion-card>
          <ion-card-header>
            <ion-card-title>
              <ion-icon name="restaurant"></ion-icon>
              Current Feeding Information
            </ion-card-title>
          </ion-card-header>
          <ion-card-content>
            <div class="info-grid">
              <div class="info-item">
                <strong>Uses Formula:</strong>
                <span>{{ formatBoolean(getFormulaInfo().usesFormula) }}</span>
              </div>
              <div class="info-item">
                <strong>Uses Bottles:</strong>
                <span>{{ formatBoolean(getBottleInfo().usesBottles) }}</span>
              </div>
              <div class="info-item">
                <strong>Uses Pump:</strong>
                <span>{{ formatBoolean(getPumpInfo().usesPump) }}</span>
              </div>
              
              <!-- Formula Details -->
              <div class="formula-details" *ngIf="getFormulaInfo().formulaDetails && getFormulaInfo().usesFormula">
                <h4>Formula Details</h4>
                <div class="info-item" *ngIf="getFormulaInfo().formulaDetails.formulaBrand">
                  <strong>Formula Brand:</strong>
                  <span>{{ getFormulaInfo().formulaDetails.formulaBrand }}{{ getFormulaInfo().formulaDetails.formulaBrandOther ? (' - ' + getFormulaInfo().formulaDetails.formulaBrandOther) : '' }}</span>
                </div>
                <div class="info-item" *ngIf="getFormulaInfo().formulaDetails.timesOfferedPerDay">
                  <strong>Times Offered Per Day:</strong>
                  <span>{{ getFormulaInfo().formulaDetails.timesOfferedPerDay }}</span>
                </div>
                <div class="info-item" *ngIf="getFormulaInfo().formulaDetails.amountPerFeed">
                  <strong>Amount Per Feed:</strong>
                  <span>{{ getFormulaInfo().formulaDetails.amountPerFeed }} ml</span>
                </div>
                <div class="info-item" *ngIf="getFormulaInfo().formulaDetails.reasonForFormula">
                  <strong>Reason for Formula:</strong>
                  <span>{{ getFormulaInfo().formulaDetails.reasonForFormula }}{{ getFormulaInfo().formulaDetails.reasonForFormulaOther ? (' - ' + getFormulaInfo().formulaDetails.reasonForFormulaOther) : '' }}</span>
                </div>
              </div>
              
              <!-- Bottle Details -->
              <div class="bottle-details" *ngIf="getBottleInfo().bottleDetails && getBottleInfo().usesBottles">
                <h4>Bottle Details</h4>
                <div class="info-item" *ngIf="getBottleInfo().bottleDetails.bottleBrand">
                  <strong>Bottle Brand:</strong>
                  <span>{{ getBottleInfo().bottleDetails.bottleBrand }}{{ getBottleInfo().bottleDetails.bottleBrandOther ? (' - ' + getBottleInfo().bottleDetails.bottleBrandOther) : '' }}</span>
                </div>
                <div class="info-item" *ngIf="getBottleInfo().bottleDetails.feedDuration">
                  <strong>Feed Duration:</strong>
                  <span>{{ getBottleInfo().bottleDetails.feedDuration }}</span>
                </div>
                <div class="info-item" *ngIf="getBottleInfo().bottleDetails.usesPacedBottleFeeding !== undefined">
                  <strong>Uses Paced Bottle Feeding:</strong>
                  <span>{{ formatBoolean(getBottleInfo().bottleDetails.usesPacedBottleFeeding) }}</span>
                </div>
                <div class="info-item" *ngIf="getBottleInfo().bottleDetails.bottleContents">
                  <strong>Bottle Contents:</strong>
                  <span>{{ getBottleInfo().bottleDetails.bottleContents }}</span>
                </div>
              </div>
              
              <!-- Pumping Details -->
              <div class="pumping-details" *ngIf="getPumpInfo().pumpingDetails && getPumpInfo().usesPump">
                <h4>Pumping Details</h4>
                <div class="info-item" *ngIf="getPumpInfo().pumpingDetails.pumpBrand">
                  <strong>Pump Brand:</strong>
                  <span>{{ getPumpInfo().pumpingDetails.pumpBrand }}{{ getPumpInfo().pumpingDetails.pumpBrandOther ? (' - ' + getPumpInfo().pumpingDetails.pumpBrandOther) : '' }}</span>
                </div>
                <div class="info-item" *ngIf="getPumpInfo().pumpingDetails.pumpType">
                  <strong>Pump Type:</strong>
                  <span>{{ formatValue(getPumpInfo().pumpingDetails.pumpType) }}</span>
                </div>
                <div class="info-item" *ngIf="getPumpInfo().pumpingDetails.pumpsBothBreasts !== undefined">
                  <strong>Pumps Both Breasts:</strong>
                  <span>{{ formatBoolean(getPumpInfo().pumpingDetails.pumpsBothBreasts) }}</span>
                </div>
                <div class="info-item" *ngIf="getPumpInfo().pumpingDetails.sessionsPerDay">
                  <strong>Sessions Per Day:</strong>
                  <span>{{ getPumpInfo().pumpingDetails.sessionsPerDay }}</span>
                </div>
                <div class="info-item" *ngIf="getPumpInfo().pumpingDetails.minutesPerSession">
                  <strong>Minutes Per Session:</strong>
                  <span>{{ getPumpInfo().pumpingDetails.minutesPerSession }}</span>
                </div>
                <div class="info-item" *ngIf="getPumpInfo().pumpingDetails.averageOutputMl">
                  <strong>Average Output Per Session:</strong>
                  <span>{{ getPumpInfo().pumpingDetails.averageOutputMl }}ml</span>
                </div>
                <div class="info-item" *ngIf="getPumpInfo().pumpingDetails.totalDailyOutput">
                  <strong>Total Daily Output:</strong>
                  <span>{{ getPumpInfo().pumpingDetails.totalDailyOutput }}ml</span>
                </div>
              </div>
            </div>
          </ion-card-content>
        </ion-card>

        <!-- Challenges & Expectations -->
        <ion-card>
          <ion-card-header>
            <ion-card-title>
              <ion-icon name="help-circle"></ion-icon>
              Current Challenges & Expectations
            </ion-card-title>
          </ion-card-header>
          <ion-card-content>
            <div class="info-grid">
              <div class="info-item" *ngIf="getPreferencesInfo().currentChallenges?.length">
                <strong>Current Challenges:</strong>
                <span>{{ formatValue(getPreferencesInfo().currentChallenges) }}</span>
              </div>
              <div class="info-item" *ngIf="getPreferencesInfo().expectationsFromProgram">
                <strong>Expectations from NariCare Program:</strong>
                <span>{{ getPreferencesInfo().expectationsFromProgram }}</span>
              </div>
            </div>
          </ion-card-content>
        </ion-card>

        <!-- Support Information -->
        <ion-card>
          <ion-card-header>
            <ion-card-title>
              <ion-icon name="people"></ion-icon>
              Support & Demographics
            </ion-card-title>
          </ion-card-header>
          <ion-card-content>
            <div class="info-grid">
              <div class="info-item">
                <strong>Current Support System:</strong>
                <span>{{ getSupportInfo().currentSupportSystem }}</span>
              </div>
              <div class="info-item">
                <strong>Family Structure:</strong>
                <span>{{ formatValue(getSupportInfo().familyStructure, 'family_structure') }}</span>
              </div>
              <div class="info-item">
                <strong>Education Level:</strong>
                <span>{{ formatValue(getSupportInfo().educationLevel, 'education_level') }}</span>
              </div>
              <div class="info-item">
                <strong>Household Income:</strong>
                <span>{{ getSupportInfo().householdIncome ? formatValue(getSupportInfo().householdIncome, 'household_income') : 'Not specified' }}</span>
              </div>
            </div>
          </ion-card-content>
        </ion-card>
        
        <!-- Preferences & Goals -->
        <ion-card>
          <ion-card-header>
            <ion-card-title>
              <ion-icon name="settings"></ion-icon>
              Goals & Preferences
            </ion-card-title>
          </ion-card-header>
          <ion-card-content>
            <div class="info-grid">
              <div class="info-item">
                <strong>Current Challenges:</strong>
                <span>{{ getPreferencesInfo().currentChallenges?.length ? formatValue(getPreferencesInfo().currentChallenges) : 'Not specified' }}</span>
              </div>
              <div class="info-item">
                <strong>Program Expectations:</strong>
                <span>{{ getPreferencesInfo().expectationsFromProgram && getPreferencesInfo().expectationsFromProgram.trim() ? getPreferencesInfo().expectationsFromProgram : 'Not specified' }}</span>
              </div>
            </div>
          </ion-card-content>
        </ion-card>
      </div>

      <ng-template #noOnboardingData>
        <div class="no-data-message">
          <ion-icon name="document-text-outline" size="large"></ion-icon>
          <h3>No Onboarding Data Available</h3>
          <p>The patient has not completed their onboarding assessment yet.</p>
        </div>
      </ng-template>
    </div>

    <!-- Consultation Report Tab -->
    <div class="tab-content" *ngIf="selectedTab === 'report'">
      <div class="consultation-report">
        
        <!-- Basic Consultation Info -->
        <ion-card>
          <ion-card-header>
            <ion-card-title>
              <ion-icon name="information-circle"></ion-icon>
              Consultation Summary
            </ion-card-title>
          </ion-card-header>
          <ion-card-content>
            <div class="info-grid">
              <div class="info-item">
                <strong>Topic:</strong>
                <span>{{ consultation.topic }}</span>
              </div>
              <div class="info-item">
                <strong>Status:</strong>
                <ion-chip [color]="getConsultationStatusColor()">
                  <ion-label>{{ getConsultationStatusText() }}</ion-label>
                </ion-chip>
                <!-- Status Action Buttons for Experts Only -->
                <div *ngIf="currentUser?.role === 'expert'" class="status-actions">
                  <!-- Start Consultation Button -->
                  <ion-button 
                    *ngIf="consultation.status === 'scheduled'" 
                    fill="solid" 
                    size="small" 
                    (click)="startConsultation()"
                    color="primary"
                    class="status-action-button">
                    <ion-icon name="play" slot="start"></ion-icon>
                    Start Consultation
                  </ion-button>
                  
                  <!-- Complete Consultation Button -->
                  <ion-button 
                    *ngIf="consultation.status === 'in-progress'" 
                    fill="solid" 
                    size="small" 
                    (click)="showCompleteModal()"
                    color="success"
                    class="status-action-button">
                    <ion-icon name="checkmark" slot="start"></ion-icon>
                    Complete Consultation
                  </ion-button>
                </div>
              </div>
              <div class="info-item">
                <strong>Scheduled:</strong>
                <span>{{ formatDate(consultation.scheduled_at) }}</span>
              </div>
              <div class="info-item" *ngIf="consultation.actual_start_time">
                <strong>Started:</strong>
                <span>{{ formatDate(consultation.actual_start_time) }}</span>
              </div>
              <div class="info-item" *ngIf="consultation.actual_end_time">
                <strong>Ended:</strong>
                <span>{{ formatDate(consultation.actual_end_time) }}</span>
              </div>
              <div class="info-item" *ngIf="consultation.follow_up_required !== undefined">
                <strong>Follow-up Required:</strong>
                <span>{{ consultation.follow_up_required ? 'Yes' : 'No' }}</span>
              </div>
            </div>
          </ion-card-content>
        </ion-card>

        <!-- Expert Notes -->
        <ion-card *ngIf="hasExpertNotes() || currentUser?.role === 'expert'; else noExpertNotes">
          <ion-card-header>
            <ion-card-title>
              <ion-icon name="clipboard"></ion-icon>
              Expert Assessment & Notes
            </ion-card-title>
            <ion-card-subtitle *ngIf="getExpertNotesDate()">
              Updated on {{ getExpertNotesDate() }} by {{ getExpertNotesAuthor() }}
            </ion-card-subtitle>
          </ion-card-header>
          <ion-card-content>
            <!-- Read-only view for users and experts not editing -->
            <div class="expert-notes-content" *ngIf="!isEditingExpertNotes && hasExpertNotes()">
              <p [innerHTML]="getFormattedExpertNotes()"></p>
            </div>
            
            <!-- Editable view for experts -->
            <div class="expert-notes-editor" *ngIf="isEditingExpertNotes && currentUser?.role === 'expert'">
              <ion-textarea
                [(ngModel)]="expertNotesContent"
                placeholder="Enter your assessment, recommendations, and notes for this consultation..."
                rows="8"
                fill="outline"
                [disabled]="expertNotesSaving">
              </ion-textarea>
            </div>
            
            <!-- No notes placeholder for experts -->
            <div class="no-notes-placeholder" *ngIf="!hasExpertNotes() && !isEditingExpertNotes && currentUser?.role === 'expert'">
              <p class="placeholder-text">No expert notes have been added yet.</p>
            </div>
            
            <!-- Action buttons for experts -->
            <div class="expert-notes-actions" *ngIf="currentUser?.role === 'expert'">
              <!-- Editing mode buttons -->
              <div class="editing-actions" *ngIf="isEditingExpertNotes">
                <ion-button fill="clear" size="small" (click)="openQuickNotesModal()">
                  <ion-icon name="bookmark" slot="start"></ion-icon>
                  Quick Notes
                </ion-button>
                <ion-button fill="clear" size="small" (click)="toggleExpertNotesEdit()">
                  <ion-icon name="close" slot="start"></ion-icon>
                  Cancel
                </ion-button>
                <ion-button fill="solid" size="small" (click)="saveExpertNotes()" [disabled]="expertNotesSaving">
                  <ion-spinner *ngIf="expertNotesSaving" name="dots"></ion-spinner>
                  <ion-icon *ngIf="!expertNotesSaving" name="checkmark" slot="start"></ion-icon>
                  {{ expertNotesSaving ? 'Saving...' : 'Save' }}
                </ion-button>
              </div>
              
              <!-- View mode buttons -->
              <div class="view-actions" *ngIf="!isEditingExpertNotes">
                <ion-button fill="outline" size="small" (click)="startEditingExpertNotes()">
                  <ion-icon name="create" slot="start"></ion-icon>
                  {{ hasExpertNotes() ? 'Edit Notes' : 'Add Notes' }}
                </ion-button>
              </div>
            </div>
          </ion-card-content>
        </ion-card>

        <ng-template #noExpertNotes>
          <div class="no-data-message">
            <ion-icon name="clipboard-outline" size="large"></ion-icon>
            <h3>No Expert Notes Available</h3>
            <p *ngIf="isScheduled()">
              Expert notes will be available after the consultation is completed.
            </p>
            <p *ngIf="isCompleted()">
              No notes were added by the expert for this consultation.
            </p>
            <p *ngIf="isCancelled()">
              This consultation was cancelled.
            </p>
          </div>
        </ng-template>

        <!-- User Feedback (if consultation is completed) -->
        <ion-card *ngIf="hasUserFeedback()">
          <ion-card-header>
            <ion-card-title>
              <ion-icon name="star"></ion-icon>
              Your Feedback
            </ion-card-title>
          </ion-card-header>
          <ion-card-content>
            <div class="feedback-content">
              <div *ngIf="consultation.user_rating" class="rating">
                <strong>Rating: </strong>
                <span class="stars">
                  <ion-icon 
                    *ngFor="let star of [1,2,3,4,5]" 
                    [name]="star <= consultation.user_rating ? 'star' : 'star-outline'"
                    [color]="star <= consultation.user_rating ? 'warning' : 'medium'">
                  </ion-icon>
                </span>
                <span>({{ consultation.user_rating }}/5)</span>
              </div>
              <div *ngIf="consultation.user_feedback" class="feedback">
                <strong>Feedback:</strong>
                <p>{{ consultation.user_feedback }}</p>
              </div>
            </div>
          </ion-card-content>
        </ion-card>
      </div>
    </div>
  </div>

  <!-- Loading State -->
  <div class="loading-container" *ngIf="!consultation">
    <ion-spinner name="circles"></ion-spinner>
    <p>Loading consultation details...</p>
  </div>
</ion-content>