<ion-header [translucent]="true">
  <ion-toolbar>
    <ion-buttons slot="start">
      <ion-button (click)="goBack()">
        <ion-icon name="arrow-back"></ion-icon>
      </ion-button>
    </ion-buttons>
    <ion-title>Consultation Details</ion-title>
  </ion-toolbar>
</ion-header>

<ion-content [fullscreen]="true">
  <ion-header collapse="condense">
    <ion-toolbar>
      <ion-title size="large">Consultation Details</ion-title>
    </ion-toolbar>
  </ion-header>

  <div class="consultation-content" *ngIf="consultation">
    <!-- Consultation Summary Header -->
    <div class="consultation-header">
      <div class="consultation-info">
        <h2>{{ consultation.topic }}</h2>
        <div class="consultation-meta">
          <ion-chip [color]="getConsultationStatusColor()">
            <ion-label>{{ getConsultationStatusText() }}</ion-label>
          </ion-chip>
          <p class="consultation-date">{{ formatDate(consultation.scheduled_at) }}</p>
        </div>
        
        <div class="participants">
          <div class="participant">
            <ion-icon name="person-circle" color="primary"></ion-icon>
            <span>{{ currentUser?.role === 'expert' ? getUserName() : 'You' }}</span>
          </div>
          <div class="participant">
            <ion-icon name="medical" color="secondary"></ion-icon>
            <span>{{ currentUser?.role === 'expert' ? 'You' : getExpertName() }}</span>
            <span class="credentials" *ngIf="consultation.expert_credentials">
              {{ consultation.expert_credentials }}
            </span>
          </div>
        </div>
      </div>
    </div>

    <!-- Tab Navigation -->
    <div class="tab-navigation">
      <ion-segment [(ngModel)]="selectedTab" (ionChange)="onSegmentChange($event)">
        <ion-segment-button value="onboarding">
          <ion-label>Patient Information</ion-label>
          <ion-icon name="document-text"></ion-icon>
        </ion-segment-button>
        <ion-segment-button value="report">
          <ion-label>Consultation Report</ion-label>
          <ion-icon name="clipboard"></ion-icon>
        </ion-segment-button>
      </ion-segment>
    </div>

    <!-- Onboarding Data Tab -->
    <div class="tab-content" *ngIf="selectedTab === 'onboarding'">
      <div class="onboarding-data" *ngIf="onboardingData; else noOnboardingData">
        
        <!-- Personal Information -->
        <ion-card>
          <ion-card-header>
            <ion-card-title>
              <ion-icon name="person"></ion-icon>
              Personal Information
            </ion-card-title>
          </ion-card-header>
          <ion-card-content>
            <div class="info-grid">
              <div class="info-item">
                <strong>Name:</strong>
                <span>{{ getPersonalInfo().fullName }}</span>
              </div>
              <div class="info-item">
                <strong>Employment:</strong>
                <span>{{ formatValue(getPersonalInfo().employmentStatus, 'work_status') }}</span>
              </div>
              <div class="info-item" *ngIf="getPersonalInfo().languagesSpoken?.length">
                <strong>Languages:</strong>
                <span>{{ formatValue(getPersonalInfo().languagesSpoken) }}</span>
              </div>
            </div>
          </ion-card-content>
        </ion-card>

        <!-- Pregnancy & Baby Information -->
        <ion-card>
          <ion-card-header>
            <ion-card-title>
              <ion-icon name="heart"></ion-icon>
              Birth Information
            </ion-card-title>
          </ion-card-header>
          <ion-card-content>
            <div class="info-grid">
              <div class="info-item">
                <strong>Mother Type:</strong>
                <span>{{ formatValue(getPregnancyInfo().motherType) }}</span>
              </div>
              <div class="info-item" *ngIf="getPregnancyInfo().dueDate">
                <strong>Due Date:</strong>
                <span>{{ formatDate(getPregnancyInfo().dueDate) }}</span>
              </div>
              <div class="info-item">
                <strong>First Child:</strong>
                <span>{{ formatBoolean(getPregnancyInfo().isFirstChild) }}</span>
              </div>
              
              <!-- Baby Information -->
              <div class="baby-info-section" *ngIf="getPregnancyInfo().babyInfo">
                <h4>Baby Information</h4>
                <div class="info-item">
                  <strong>Name:</strong>
                  <span>{{ getPregnancyInfo().babyInfo.name }}</span>
                </div>
                <div class="info-item">
                  <strong>Date of Birth:</strong>
                  <span>{{ formatDate(getPregnancyInfo().babyInfo.dateOfBirth) }}</span>
                </div>
                <div class="info-item">
                  <strong>Gender:</strong>
                  <span>{{ formatValue(getPregnancyInfo().babyInfo.gender) }}</span>
                </div>
                <div class="info-item">
                  <strong>Birth Weight:</strong>
                  <span>{{ getPregnancyInfo().babyInfo.birthWeight }} kg</span>
                </div>
                <div class="info-item">
                  <strong>Birth Height:</strong>
                  <span>{{ getPregnancyInfo().babyInfo.birthHeight }} cm</span>
                </div>
                <div class="info-item">
                  <strong>Delivery Type:</strong>
                  <span>{{ formatValue(getPregnancyInfo().babyInfo.deliveryType, 'birth_type') }}</span>
                </div>
                <div class="info-item">
                  <strong>Gestational Age:</strong>
                  <span>{{ getPregnancyInfo().babyInfo.gestationalAge }} weeks</span>
                </div>
                <div class="info-item" *ngIf="getPregnancyInfo().babyInfo.currentWeight">
                  <strong>Current Weight:</strong>
                  <span>{{ getPregnancyInfo().babyInfo.currentWeight }} kg</span>
                </div>
              </div>
            </div>
          </ion-card-content>
        </ion-card>

        <!-- Breastfeeding Information -->
        <ion-card>
          <ion-card-header>
            <ion-card-title>
              <ion-icon name="nutrition"></ion-icon>
              Breastfeeding Information
            </ion-card-title>
          </ion-card-header>
          <ion-card-content>
            <div class="info-grid">
              <div class="info-item">
                <strong>Experience Level:</strong>
                <span>{{ formatValue(getBreastfeedingInfo().experienceLevel) }}</span>
              </div>
              <div class="info-item">
                <strong>Currently Breastfeeding:</strong>
                <span>{{ formatBoolean(getBreastfeedingInfo().currentlyBreastfeeding) }}</span>
              </div>
              
              <!-- Breastfeeding Details -->
              <div class="breastfeeding-details" *ngIf="getBreastfeedingInfo().breastfeedingDetails">
                <h4>Breastfeeding Details</h4>
                <div class="info-item">
                  <strong>Direct Feeds Per Day:</strong>
                  <span>{{ getBreastfeedingInfo().breastfeedingDetails.directFeedsPerDay }}</span>
                </div>
                <div class="info-item">
                  <strong>Latch Quality:</strong>
                  <span>{{ formatValue(getBreastfeedingInfo().breastfeedingDetails.latchQuality) }}</span>
                </div>
                <div class="info-item">
                  <strong>Offers Both Breasts:</strong>
                  <span>{{ formatBoolean(getBreastfeedingInfo().breastfeedingDetails.offersBothBreasts) }}</span>
                </div>
                <div class="info-item">
                  <strong>Time Per Breast:</strong>
                  <span>{{ formatValue(getBreastfeedingInfo().breastfeedingDetails.timePerBreast) }}</span>
                </div>
                <div class="info-item">
                  <strong>Duration Goal:</strong>
                  <span>{{ getBreastfeedingInfo().breastfeedingDetails.breastfeedingDuration }}</span>
                </div>
              </div>
              
              <!-- Baby Output -->
              <div class="baby-output" *ngIf="getBreastfeedingInfo().babyOutput">
                <h4>Baby Output (24h)</h4>
                <div class="info-item">
                  <strong>Pee Count:</strong>
                  <span>{{ getBreastfeedingInfo().babyOutput.peeCount24h }}</span>
                </div>
                <div class="info-item">
                  <strong>Poop Count:</strong>
                  <span>{{ getBreastfeedingInfo().babyOutput.poopCount24h }}</span>
                </div>
              </div>
            </div>
          </ion-card-content>
        </ion-card>

        <!-- Medical Information -->
        <ion-card>
          <ion-card-header>
            <ion-card-title>
              <ion-icon name="medical"></ion-icon>
              Medical Information
            </ion-card-title>
          </ion-card-header>
          <ion-card-content>
            <div class="info-grid">
              <div class="info-item" *ngIf="getMedicalInfo().motherMedicalConditions?.length">
                <strong>Mother's Medical Conditions:</strong>
                <span>{{ formatValue(getMedicalInfo().motherMedicalConditions) }}</span>
              </div>
              <div class="info-item" *ngIf="getMedicalInfo().allergies">
                <strong>Allergies:</strong>
                <span>{{ getMedicalInfo().allergies }}</span>
              </div>
              <div class="info-item" *ngIf="getMedicalInfo().motherMedicalConditionsOther">
                <strong>Other Medical Conditions:</strong>
                <span>{{ getMedicalInfo().motherMedicalConditionsOther }}</span>
              </div>
              <div class="info-item">
                <strong>Nipple Anatomical Issues:</strong>
                <span>{{ formatBoolean(getMedicalInfo().nippleAnatomicalIssues) }}</span>
              </div>
              <div class="info-item" *ngIf="getMedicalInfo().nippleIssuesDescription">
                <strong>Nipple Issues Description:</strong>
                <span>{{ getMedicalInfo().nippleIssuesDescription }}</span>
              </div>
              <div class="info-item" *ngIf="getMedicalInfo().babyMedicalConditions">
                <strong>Baby's Medical Conditions:</strong>
                <span>{{ getMedicalInfo().babyMedicalConditions }}</span>
              </div>
              <div class="info-item">
                <strong>Baby Hospitalized:</strong>
                <span>{{ formatBoolean(getMedicalInfo().babyHospitalized) }}</span>
              </div>
              <div class="info-item" *ngIf="getMedicalInfo().babyHospitalizationReason">
                <strong>Hospitalization Reason:</strong>
                <span>{{ getMedicalInfo().babyHospitalizationReason }}</span>
              </div>
            </div>
          </ion-card-content>
        </ion-card>

        <!-- Feeding Information -->
        <ion-card>
          <ion-card-header>
            <ion-card-title>
              <ion-icon name="restaurant"></ion-icon>
              Current Feeding Information
            </ion-card-title>
          </ion-card-header>
          <ion-card-content>
            <div class="info-grid">
              <div class="info-item">
                <strong>Uses Formula:</strong>
                <span>{{ formatBoolean(getFeedingInfo().usesFormula) }}</span>
              </div>
              <div class="info-item">
                <strong>Uses Bottle:</strong>
                <span>{{ formatBoolean(getFeedingInfo().usesBottle) }}</span>
              </div>
              <div class="info-item">
                <strong>Owns Pump:</strong>
                <span>{{ formatBoolean(getFeedingInfo().ownsPump) }}</span>
              </div>
              <div class="info-item">
                <strong>Uses Breastmilk Supplements:</strong>
                <span>{{ formatBoolean(getFeedingInfo().usesBreastmilkSupplements) }}</span>
              </div>
              
              <!-- Formula Details -->
              <div class="formula-details" *ngIf="getFeedingInfo().formulaDetails">
                <h4>Formula Details</h4>
                <div class="info-item">
                  <strong>Formula Type:</strong>
                  <span>{{ getFeedingInfo().formulaDetails.formulaType }}</span>
                </div>
                <div class="info-item">
                  <strong>Amount Per Feed:</strong>
                  <span>{{ getFeedingInfo().formulaDetails.amountPerFeed }} ml</span>
                </div>
                <div class="info-item">
                  <strong>Feeds Per Day:</strong>
                  <span>{{ getFeedingInfo().formulaDetails.feedsPerDay }}</span>
                </div>
                <div class="info-item">
                  <strong>Reason for Formula:</strong>
                  <span>{{ getFeedingInfo().formulaDetails.reasonForFormula }}</span>
                </div>
              </div>
              
              <!-- Bottle Details -->
              <div class="bottle-details" *ngIf="getFeedingInfo().bottleDetails">
                <h4>Bottle Details</h4>
                <div class="info-item">
                  <strong>Bottle Type:</strong>
                  <span>{{ getFeedingInfo().bottleDetails.bottleType }}</span>
                </div>
                <div class="info-item">
                  <strong>Amount Per Feed:</strong>
                  <span>{{ getFeedingInfo().bottleDetails.amountPerFeed }} ml</span>
                </div>
                <div class="info-item">
                  <strong>Feeds Per Day:</strong>
                  <span>{{ getFeedingInfo().bottleDetails.feedsPerDay }}</span>
                </div>
                <div class="info-item">
                  <strong>Content Type:</strong>
                  <span>{{ formatValue(getFeedingInfo().bottleDetails.contentType) }}</span>
                </div>
              </div>
              
              <!-- Pumping Details -->
              <div class="pumping-details" *ngIf="getFeedingInfo().pumpingDetails">
                <h4>Pumping Details</h4>
                <div class="info-item">
                  <strong>Pump Type:</strong>
                  <span>{{ formatValue(getFeedingInfo().pumpingDetails.pumpType) }}</span>
                </div>
                <div class="info-item">
                  <strong>Sessions Per Day:</strong>
                  <span>{{ getFeedingInfo().pumpingDetails.sessionsPerDay }}</span>
                </div>
                <div class="info-item">
                  <strong>Average Output:</strong>
                  <span>{{ getFeedingInfo().pumpingDetails.averageOutput }} ml</span>
                </div>
                <div class="info-item">
                  <strong>Duration:</strong>
                  <span>{{ getFeedingInfo().pumpingDetails.pumpingDuration }} minutes</span>
                </div>
                <div class="info-item">
                  <strong>Storage Method:</strong>
                  <span>{{ formatValue(getFeedingInfo().pumpingDetails.storageMethod) }}</span>
                </div>
              </div>
              
              <div class="info-item" *ngIf="getFeedingInfo().supplementsDetails">
                <strong>Supplements Details:</strong>
                <span>{{ getFeedingInfo().supplementsDetails }}</span>
              </div>
            </div>
          </ion-card-content>
        </ion-card>

        <!-- Support Information -->
        <ion-card>
          <ion-card-header>
            <ion-card-title>
              <ion-icon name="people"></ion-icon>
              Support & Demographics
            </ion-card-title>
          </ion-card-header>
          <ion-card-content>
            <div class="info-grid">
              <div class="info-item">
                <strong>Current Support System:</strong>
                <span>{{ getSupportInfo().currentSupportSystem }}</span>
              </div>
              <div class="info-item">
                <strong>Family Structure:</strong>
                <span>{{ formatValue(getSupportInfo().familyStructure) }}</span>
              </div>
              <div class="info-item">
                <strong>Education Level:</strong>
                <span>{{ formatValue(getSupportInfo().educationLevel, 'education_level') }}</span>
              </div>
              <div class="info-item" *ngIf="getSupportInfo().householdIncome">
                <strong>Household Income:</strong>
                <span>{{ formatValue(getSupportInfo().householdIncome) }}</span>
              </div>
            </div>
          </ion-card-content>
        </ion-card>
        
        <!-- Preferences & Goals -->
        <ion-card>
          <ion-card-header>
            <ion-card-title>
              <ion-icon name="settings"></ion-icon>
              Goals & Preferences
            </ion-card-title>
          </ion-card-header>
          <ion-card-content>
            <div class="info-grid">
              <div class="info-item" *ngIf="getPreferencesInfo().currentChallenges?.length">
                <strong>Current Challenges:</strong>
                <span>{{ formatValue(getPreferencesInfo().currentChallenges) }}</span>
              </div>
              <div class="info-item" *ngIf="getPreferencesInfo().expectationsFromProgram">
                <strong>Program Expectations:</strong>
                <span>{{ getPreferencesInfo().expectationsFromProgram }}</span>
              </div>
              <div class="info-item" *ngIf="getPreferencesInfo().milkSupplyGoals">
                <strong>Milk Supply Goals:</strong>
                <span>{{ getPreferencesInfo().milkSupplyGoals }}</span>
              </div>
              <div class="info-item" *ngIf="getPreferencesInfo().topicsOfInterest?.length">
                <strong>Topics of Interest:</strong>
                <span>{{ formatValue(getPreferencesInfo().topicsOfInterest) }}</span>
              </div>
            </div>
          </ion-card-content>
        </ion-card>
      </div>

      <ng-template #noOnboardingData>
        <div class="no-data-message">
          <ion-icon name="document-text-outline" size="large"></ion-icon>
          <h3>No Onboarding Data Available</h3>
          <p>The patient has not completed their onboarding assessment yet.</p>
        </div>
      </ng-template>
    </div>

    <!-- Consultation Report Tab -->
    <div class="tab-content" *ngIf="selectedTab === 'report'">
      <div class="consultation-report">
        
        <!-- Basic Consultation Info -->
        <ion-card>
          <ion-card-header>
            <ion-card-title>
              <ion-icon name="information-circle"></ion-icon>
              Consultation Summary
            </ion-card-title>
          </ion-card-header>
          <ion-card-content>
            <div class="info-grid">
              <div class="info-item">
                <strong>Topic:</strong>
                <span>{{ consultation.topic }}</span>
              </div>
              <div class="info-item">
                <strong>Status:</strong>
                <ion-chip [color]="getConsultationStatusColor()">
                  <ion-label>{{ getConsultationStatusText() }}</ion-label>
                </ion-chip>
              </div>
              <div class="info-item">
                <strong>Scheduled:</strong>
                <span>{{ formatDate(consultation.scheduled_at) }}</span>
              </div>
              <div class="info-item" *ngIf="consultation.actual_start_time">
                <strong>Started:</strong>
                <span>{{ formatDate(consultation.actual_start_time) }}</span>
              </div>
              <div class="info-item" *ngIf="consultation.actual_end_time">
                <strong>Ended:</strong>
                <span>{{ formatDate(consultation.actual_end_time) }}</span>
              </div>
              <div class="info-item" *ngIf="consultation.follow_up_required !== undefined">
                <strong>Follow-up Required:</strong>
                <span>{{ consultation.follow_up_required ? 'Yes' : 'No' }}</span>
              </div>
            </div>
          </ion-card-content>
        </ion-card>

        <!-- Expert Notes -->
        <ion-card *ngIf="hasExpertNotes() || currentUser?.role === 'expert'; else noExpertNotes">
          <ion-card-header>
            <ion-card-title>
              <ion-icon name="clipboard"></ion-icon>
              Expert Assessment & Notes
            </ion-card-title>
            <ion-card-subtitle *ngIf="getExpertNotesDate()">
              Updated on {{ getExpertNotesDate() }} by {{ getExpertNotesAuthor() }}
            </ion-card-subtitle>
          </ion-card-header>
          <ion-card-content>
            <!-- Read-only view for users and experts not editing -->
            <div class="expert-notes-content" *ngIf="!isEditingExpertNotes && hasExpertNotes()">
              <p [innerHTML]="getFormattedExpertNotes()"></p>
            </div>
            
            <!-- Editable view for experts -->
            <div class="expert-notes-editor" *ngIf="isEditingExpertNotes && currentUser?.role === 'expert'">
              <ion-textarea
                [(ngModel)]="expertNotesContent"
                placeholder="Enter your assessment, recommendations, and notes for this consultation..."
                rows="8"
                fill="outline"
                [disabled]="expertNotesSaving">
              </ion-textarea>
            </div>
            
            <!-- No notes placeholder for experts -->
            <div class="no-notes-placeholder" *ngIf="!hasExpertNotes() && !isEditingExpertNotes && currentUser?.role === 'expert'">
              <p class="placeholder-text">No expert notes have been added yet.</p>
            </div>
            
            <!-- Action buttons for experts -->
            <div class="expert-notes-actions" *ngIf="currentUser?.role === 'expert'">
              <!-- Editing mode buttons -->
              <div class="editing-actions" *ngIf="isEditingExpertNotes">
                <ion-button fill="clear" size="small" (click)="openQuickNotesModal()">
                  <ion-icon name="bookmark" slot="start"></ion-icon>
                  Quick Notes
                </ion-button>
                <ion-button fill="clear" size="small" (click)="toggleExpertNotesEdit()">
                  <ion-icon name="close" slot="start"></ion-icon>
                  Cancel
                </ion-button>
                <ion-button fill="solid" size="small" (click)="saveExpertNotes()" [disabled]="expertNotesSaving">
                  <ion-spinner *ngIf="expertNotesSaving" name="dots"></ion-spinner>
                  <ion-icon *ngIf="!expertNotesSaving" name="checkmark" slot="start"></ion-icon>
                  {{ expertNotesSaving ? 'Saving...' : 'Save' }}
                </ion-button>
              </div>
              
              <!-- View mode buttons -->
              <div class="view-actions" *ngIf="!isEditingExpertNotes">
                <ion-button fill="outline" size="small" (click)="startEditingExpertNotes()">
                  <ion-icon name="create" slot="start"></ion-icon>
                  {{ hasExpertNotes() ? 'Edit Notes' : 'Add Notes' }}
                </ion-button>
              </div>
            </div>
          </ion-card-content>
        </ion-card>

        <ng-template #noExpertNotes>
          <div class="no-data-message">
            <ion-icon name="clipboard-outline" size="large"></ion-icon>
            <h3>No Expert Notes Available</h3>
            <p *ngIf="isScheduled()">
              Expert notes will be available after the consultation is completed.
            </p>
            <p *ngIf="isCompleted()">
              No notes were added by the expert for this consultation.
            </p>
            <p *ngIf="isCancelled()">
              This consultation was cancelled.
            </p>
          </div>
        </ng-template>

        <!-- User Feedback (if consultation is completed) -->
        <ion-card *ngIf="hasUserFeedback()">
          <ion-card-header>
            <ion-card-title>
              <ion-icon name="star"></ion-icon>
              Your Feedback
            </ion-card-title>
          </ion-card-header>
          <ion-card-content>
            <div class="feedback-content">
              <div *ngIf="consultation.user_rating" class="rating">
                <strong>Rating: </strong>
                <span class="stars">
                  <ion-icon 
                    *ngFor="let star of [1,2,3,4,5]" 
                    [name]="star <= consultation.user_rating ? 'star' : 'star-outline'"
                    [color]="star <= consultation.user_rating ? 'warning' : 'medium'">
                  </ion-icon>
                </span>
                <span>({{ consultation.user_rating }}/5)</span>
              </div>
              <div *ngIf="consultation.user_feedback" class="feedback">
                <strong>Feedback:</strong>
                <p>{{ consultation.user_feedback }}</p>
              </div>
            </div>
          </ion-card-content>
        </ion-card>
      </div>
    </div>
  </div>

  <!-- Loading State -->
  <div class="loading-container" *ngIf="!consultation">
    <ion-spinner name="circles"></ion-spinner>
    <p>Loading consultation details...</p>
  </div>
</ion-content>