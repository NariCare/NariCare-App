<ion-header>
  <ion-toolbar>
    <ion-title>{{ isEditMode ? 'Edit Consultation' : 'Book Expert Consultation' }}</ion-title>
    <ion-buttons slot="end">
      <ion-button fill="clear" (click)="closeModal()">
        <ion-icon name="close" slot="icon-only"></ion-icon>
      </ion-button>
    </ion-buttons>
  </ion-toolbar>
</ion-header>

<ion-content>
  <div class="booking-container">
    
    <!-- Progress indicator -->
    <div class="progress-container">
      <div class="progress-bar">
        <div class="progress-fill" [style.width.%]="(currentStep / totalSteps) * 100"></div>
      </div>
      <p class="progress-text">Step {{ currentStep }} of {{ totalSteps }}</p>
    </div>

    <form [formGroup]="bookingForm" class="booking-form">
      
      <!-- Step 1: Select Expert -->
      <div class="form-step" *ngIf="currentStep === 1">
        <h2 class="step-title">Choose Your Expert</h2>
        <p class="step-description">Select a lactation consultant who specializes in your needs</p>
        
        <!-- Loading state -->
        <div *ngIf="expertsLoading" class="loading-container">
          <ion-spinner name="circles"></ion-spinner>
          <p>Loading experts...</p>
        </div>

        <!-- Error state -->
        <div *ngIf="expertsError && !expertsLoading" class="error-container">
          <ion-icon name="warning-outline" class="error-icon"></ion-icon>
          <p class="error-message">{{ expertsError }}</p>
          <ion-button fill="outline" size="small" (click)="retryLoadExperts()">
            <ion-icon name="refresh" slot="start"></ion-icon>
            Retry
          </ion-button>
        </div>

        <!-- Empty state -->
        <div *ngIf="!expertsLoading && !expertsError && !hasExperts" class="empty-container">
          <ion-icon name="people-outline" class="empty-icon"></ion-icon>
          <p class="empty-message">No experts available at the moment.</p>
          <ion-button fill="outline" size="small" (click)="retryLoadExperts()">
            <ion-icon name="refresh" slot="start"></ion-icon>
            Refresh
          </ion-button>
        </div>

        <!-- Experts list -->
        <div *ngIf="!expertsLoading && !expertsError && hasExperts" class="experts-list">
          <div 
            *ngFor="let expert of experts$ | async"
            class="expert-card"
            [class.selected]="selectedExpert?.id === expert.id"
            (click)="selectExpert(expert)">
            
            <div class="expert-avatar">
              <img [src]="getExpertImage(expert)" [alt]="getExpertName(expert)" *ngIf="getExpertImage(expert)">
              <ion-icon name="person" *ngIf="!getExpertImage(expert)"></ion-icon>
            </div>
            
            <div class="expert-info">
              <h3>{{ getExpertName(expert) }}</h3>
              <p class="credentials">{{ getExpertCredentials(expert) }}</p>
              
              <div class="rating">
                <ion-icon 
                  *ngFor="let star of getExpertRatingStars(expert.rating)" 
                  [name]="star" 
                  class="star-icon">
                </ion-icon>
                <span class="rating-text">({{ expert.rating }}/5)</span>
              </div>
              
              <div class="specialties">
                <ion-chip 
                  *ngFor="let specialty of expert.specialties" 
                  color="light" 
                  size="small">
                  {{ specialty }}
                </ion-chip>
              </div>
              
              <p class="bio">{{ expert.bio }}</p>
              
              <div class="consultation-count">
                <ion-icon name="people"></ion-icon>
                <span>{{ getExpertConsultations(expert) }} consultations completed</span>
              </div>
            </div>
            
            <ion-icon name="checkmark-circle" class="selected-icon" *ngIf="selectedExpert?.id === expert.id"></ion-icon>
          </div>
        </div>

        <ion-button 
          expand="block" 
          (click)="nextStep()" 
          [disabled]="!selectedExpert"
          class="next-button">
          Continue
        </ion-button>
      </div>

      <!-- Step 2: Select Date & Time -->
      <div class="form-step" *ngIf="currentStep === 2">
        <h2 class="step-title">Choose Date & Time</h2>
        <p class="step-description">Select when you'd like to have your consultation</p>
        
        <div class="selected-expert-summary" *ngIf="selectedExpert">
          <div class="expert-summary-avatar">
            <img [src]="getExpertImage(selectedExpert)" [alt]="getExpertName(selectedExpert)" *ngIf="getExpertImage(selectedExpert)">
            <ion-icon name="person" *ngIf="!getExpertImage(selectedExpert)"></ion-icon>
          </div>
          <div class="expert-summary-info">
            <h4>{{ getExpertName(selectedExpert) }}</h4>
            <p>{{ getExpertCredentials(selectedExpert) }}</p>
          </div>
        </div>

        <div class="form-group">
          <label class="field-label">üìÖ Consultation Date</label>
          <ion-item lines="none" class="input-item">
            <ion-icon name="calendar-outline" slot="start" class="input-icon"></ion-icon>
            <ion-datetime-button datetime="consultationDate">
              <ion-label>Select Date</ion-label>
            </ion-datetime-button>
          </ion-item>
          <ion-modal [keepContentsMounted]="true">
            <ng-template>
              <ion-datetime 
                id="consultationDate" 
                formControlName="scheduledDate"
                presentation="date"
                [min]="minDate"
                [max]="maxDate">
              </ion-datetime>
            </ng-template>
          </ion-modal>
          <div class="error-message" *ngIf="bookingForm.get('scheduledDate')?.invalid && bookingForm.get('scheduledDate')?.touched">
            {{ getErrorMessage('scheduledDate') }}
          </div>
        </div>

        <div class="form-group">
          <label class="field-label">‚è∞ Consultation Time</label>
          <ion-item lines="none" class="input-item">
            <ion-icon name="time-outline" slot="start" class="input-icon"></ion-icon>
            <ion-select 
              formControlName="scheduledTime"
              placeholder="Select Time"
              interface="popover">
              <ion-select-option 
                *ngFor="let time of getAvailableTimeSlots()" 
                [value]="time">
                {{ time }}
              </ion-select-option>
            </ion-select>
          </ion-item>
          <div class="error-message" *ngIf="bookingForm.get('scheduledTime')?.invalid && bookingForm.get('scheduledTime')?.touched">
            {{ getErrorMessage('scheduledTime') }}
          </div>
        </div>

        <div class="button-row">
          <ion-button fill="outline" (click)="previousStep()" class="back-button">
            Back
          </ion-button>
          <ion-button (click)="nextStep()" class="next-button">
            Continue
          </ion-button>
        </div>
      </div>

      <!-- Step 3: Topic & Notes -->
      <div class="form-step" *ngIf="currentStep === 3">
        <h2 class="step-title">Consultation Details</h2>
        <p class="step-description">Tell us what you'd like to discuss</p>
        
        <div class="consultation-summary" *ngIf="selectedExpert">
          <div class="summary-header">
            <ion-icon name="calendar"></ion-icon>
            <h4>Consultation Summary</h4>
          </div>
          <div class="summary-details">
            <p><strong>Expert:</strong> {{ getExpertName(selectedExpert) }}</p>
            <p><strong>Date:</strong> {{ bookingForm.get('scheduledDate')?.value | date:'fullDate' }}</p>
            <p><strong>Time:</strong> {{ bookingForm.get('scheduledTime')?.value }}</p>
            <p><strong>Duration:</strong> 30 minutes</p>
            <p *ngIf="selectedBabies.length > 0"><strong>Babies:</strong> 
              <span *ngFor="let baby of selectedBabies; let last = last">
                {{ baby.name }} ({{ getBabyAge(baby) }})<span *ngIf="!last">, </span>
              </span>
            </p>
          </div>
        </div>

        <!-- Baby Selection -->
        <div class="form-group" *ngIf="babies && babies.length > 0">
          <label class="field-label">üë∂ Select Baby(s) for Consultation</label>
          <p class="field-description">Which baby(s) is this consultation about? You can select multiple babies.</p>
          
          <!-- Single baby - auto-selected -->
          <div *ngIf="babies.length === 1" class="single-baby-info">
            <div class="baby-card selected">
              <img [src]="getBabyIcon(babies[0])" [alt]="babies[0].name" class="baby-avatar">
              <div class="baby-info">
                <h4>{{ babies[0].name }}</h4>
                <p>{{ getBabyAge(babies[0]) }}</p>
              </div>
              <ion-icon name="checkmark-circle" class="selected-icon"></ion-icon>
            </div>
          </div>

          <!-- Multiple babies - horizontal selection -->
          <div *ngIf="babies.length > 1" class="babies-horizontal-selection">
            <div 
              *ngFor="let baby of babies"
              class="baby-card"
              [class.selected]="isBabySelected(baby)"
              (click)="selectBaby(baby)">
              <img [src]="getBabyIcon(baby)" [alt]="baby.name" class="baby-avatar">
              <div class="baby-info">
                <h4>{{ baby.name }}</h4>
                <p>{{ getBabyAge(baby) }}</p>
              </div>
              <ion-icon name="checkmark-circle" class="selected-icon" *ngIf="isBabySelected(baby)"></ion-icon>
            </div>
          </div>
          
          <div class="error-message" *ngIf="bookingForm.get('babyIds')?.invalid && bookingForm.get('babyIds')?.touched">
            Please select at least one baby for this consultation
          </div>
        </div>

        <!-- No babies warning -->
        <div *ngIf="!babies || babies.length === 0" class="no-babies-warning">
          <ion-icon name="warning-outline"></ion-icon>
          <p>You need to add at least one baby to book a consultation. Please add your baby's information in the Growth section first.</p>
        </div>

        <div class="form-group">
          <label class="field-label">üí¨ Main Topic</label>
          <ion-item lines="none" class="input-item">
            <ion-select 
              formControlName="topic"
              placeholder="What would you like to discuss?"
              interface="popover">
              <ion-select-option value="latching-issues">Latching Issues</ion-select-option>
              <ion-select-option value="milk-supply">Milk Supply Concerns</ion-select-option>
              <ion-select-option value="pumping-help">Pumping Help</ion-select-option>
              <ion-select-option value="feeding-schedule">Feeding Schedule</ion-select-option>
              <ion-select-option value="weaning-guidance">Weaning Guidance</ion-select-option>
              <ion-select-option value="return-to-work">Return to Work</ion-select-option>
              <ion-select-option value="baby-weight">Baby Weight Concerns</ion-select-option>
              <ion-select-option value="general-support">General Support</ion-select-option>
              <ion-select-option value="other">Other</ion-select-option>
            </ion-select>
          </ion-item>
          <div class="error-message" *ngIf="bookingForm.get('topic')?.invalid && bookingForm.get('topic')?.touched">
            {{ getErrorMessage('topic') }}
          </div>
        </div>

        <div class="form-group">
          <label class="field-label">üìù Additional Notes (Optional)</label>
          <ion-item lines="none" class="input-item">
            <ion-textarea
              formControlName="notes"
              placeholder="Share any specific concerns or questions you'd like to discuss..."
              rows="4"
              autoGrow="true">
            </ion-textarea>
          </ion-item>
        </div>

        <div class="consultation-info">
          <div class="info-card">
            <ion-icon name="videocam"></ion-icon>
            <div class="info-content">
              <h5>Video Consultation</h5>
              <p>You'll receive a secure video link before your appointment</p>
            </div>
          </div>
          
          <div class="info-card">
            <ion-icon name="shield-checkmark"></ion-icon>
            <div class="info-content">
              <h5>Private & Secure</h5>
              <p>All consultations are confidential and HIPAA compliant</p>
            </div>
          </div>
        </div>

        <div class="button-row">
          <ion-button fill="outline" (click)="previousStep()" class="back-button">
            Back
          </ion-button>
          <ion-button 
            (click)="bookConsultation()" 
            [disabled]="!bookingForm.valid || selectedBabies.length === 0 || (babies && babies.length === 0)"
            class="book-button">
            <ion-icon name="calendar" slot="start"></ion-icon>
            {{ isEditMode ? 'Update Consultation' : 'Book Consultation' }}
          </ion-button>
        </div>
      </div>
    </form>

  </div>
</ion-content>