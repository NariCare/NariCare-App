<ion-header>
  <ion-toolbar>
    <ion-title>üíï Emotion Check-In</ion-title>
    <ion-buttons slot="end">
      <ion-button fill="clear" (click)="closeModal()">
        <ion-icon name="close" slot="icon-only"></ion-icon>
      </ion-button>
    </ion-buttons>
  </ion-toolbar>
</ion-header>

<ion-content>
  <div class="emotion-checkin-container">
    
    <!-- Progress indicator -->
    <div class="progress-container">
      <div class="progress-bar">
        <div class="progress-fill" [style.width.%]="getProgressPercentage()"></div>
      </div>
      <p class="progress-text">Step {{ currentStep }} of {{ totalSteps }}</p>
    </div>

    <form [formGroup]="emotionForm" class="emotion-form">
      
      <!-- Step 1: Emotional Struggles -->
      <div class="form-step" *ngIf="currentStep === 1">
        <h2 class="step-title">üíô How are you feeling today?</h2>
        <p class="step-description">Select any struggles you're experiencing. It's okay to feel this way - you're not alone.</p>
        
        <div class="selection-section">
          <div class="selection-grid struggles-grid">
            <div 
              *ngFor="let struggle of emotionalStruggles"
              class="selection-option struggle-option"
              [class.selected]="isStruggleSelected(struggle)"
              (click)="toggleStruggle(struggle)">
              <div class="option-emoji">{{ struggle.emoji }}</div>
              <div class="option-content">
                <span class="option-text">{{ struggle.text }}</span>
              </div>
              <ion-icon name="checkmark-circle" class="selection-indicator" *ngIf="isStruggleSelected(struggle)"></ion-icon>
            </div>
          </div>
          
          <div class="selection-summary" *ngIf="getSelectedCount('struggles') > 0">
            <p>{{ getSelectedCount('struggles') }} struggle{{ getSelectedCount('struggles') !== 1 ? 's' : '' }} selected</p>
          </div>
        </div>

        <ion-button 
          expand="block" 
          (click)="nextStep()" 
          class="next-button">
          Continue
        </ion-button>
      </div>

      <!-- Step 2: Positive Moments -->
      <div class="form-step" *ngIf="currentStep === 2">
        <h2 class="step-title">‚ú® What went well today?</h2>
        <p class="step-description">Celebrate the positive moments, no matter how small. You're doing amazing!</p>
        
        <div class="selection-section">
          <div class="selection-grid positive-grid">
            <div 
              *ngFor="let moment of positiveMoments"
              class="selection-option positive-option"
              [class.selected]="isPositiveMomentSelected(moment)"
              (click)="togglePositiveMoment(moment)">
              <div class="option-emoji">{{ moment.emoji }}</div>
              <div class="option-content">
                <span class="option-text">{{ moment.text }}</span>
              </div>
              <ion-icon name="checkmark-circle" class="selection-indicator" *ngIf="isPositiveMomentSelected(moment)"></ion-icon>
            </div>
          </div>
          
          <div class="selection-summary" *ngIf="getSelectedCount('positive') > 0">
            <p>{{ getSelectedCount('positive') }} positive moment{{ getSelectedCount('positive') !== 1 ? 's' : '' }} selected</p>
          </div>
        </div>

        <div class="button-row">
          <ion-button fill="outline" (click)="previousStep()" class="back-button">
            Back
          </ion-button>
          <ion-button (click)="nextStep()" class="next-button">
            Continue
          </ion-button>
        </div>
      </div>

      <!-- Step 3: Concerning Thoughts -->
      <div class="form-step" *ngIf="currentStep === 3">
        <h2 class="step-title">ü§ó Checking in on difficult thoughts</h2>
        <p class="step-description">These thoughts can be part of the postpartum experience. If any apply, please know that help is available.</p>
        
        <div class="selection-section concerning-section">
          <div class="selection-grid concerning-grid">
            <div 
              *ngFor="let thought of concerningThoughts"
              class="selection-option concerning-option"
              [class.selected]="isConcerningThoughtSelected(thought)"
              [class.critical]="thought.severity === 'critical'"
              (click)="toggleConcerningThought(thought)">
              <div class="option-emoji">{{ thought.emoji }}</div>
              <div class="option-content">
                <span class="option-text">{{ thought.text }}</span>
              </div>
              <ion-icon name="checkmark-circle" class="selection-indicator" *ngIf="isConcerningThoughtSelected(thought)"></ion-icon>
            </div>
          </div>
          
          <div class="selection-summary concerning-summary" *ngIf="getSelectedCount('concerning') > 0">
            <div class="crisis-warning" *ngIf="hasCriticalThoughts()">
              <ion-icon name="warning"></ion-icon>
              <p>Immediate support is recommended. Please reach out for help.</p>
            </div>
            <p *ngIf="!hasCriticalThoughts()">{{ getSelectedCount('concerning') }} concerning thought{{ getSelectedCount('concerning') !== 1 ? 's' : '' }} selected</p>
          </div>
        </div>

        <div class="button-row">
          <ion-button fill="outline" (click)="previousStep()" class="back-button">
            Back
          </ion-button>
          <ion-button (click)="nextStep()" class="next-button">
            Continue
          </ion-button>
        </div>
      </div>

      <!-- Step 4: Journaling & Notes -->
      <div class="form-step" *ngIf="currentStep === 4">
        <h2 class="step-title">üìù Reflect & Journal</h2>
        <p class="step-description">Take a moment to reflect on your day. Writing can be therapeutic and help process your feelings.</p>
        
        <div class="journaling-section">
          <div class="form-group">
            <label class="field-label">üôè What are you grateful for today?</label>
            <ion-item lines="none" class="input-item journaling-input">
              <ion-textarea
                formControlName="gratefulFor"
                placeholder="Even small things count... a smile, a moment of peace, support from someone..."
                rows="3"
                autoGrow="true">
              </ion-textarea>
            </ion-item>
          </div>

          <div class="form-group">
            <label class="field-label">üåü What are you proud of today?</label>
            <ion-item lines="none" class="input-item journaling-input">
              <ion-textarea
                formControlName="proudOfToday"
                placeholder="Celebrate your wins, big or small... feeding your baby, asking for help, taking a shower..."
                rows="3"
                autoGrow="true">
              </ion-textarea>
            </ion-item>
          </div>

          <div class="form-group">
            <label class="field-label">üéØ What's one small goal for tomorrow?</label>
            <ion-item lines="none" class="input-item journaling-input">
              <ion-textarea
                formControlName="tomorrowGoal"
                placeholder="Something achievable... rest when baby sleeps, call a friend, try a new feeding position..."
                rows="3"
                autoGrow="true">
              </ion-textarea>
            </ion-item>
          </div>

          <div class="form-group">
            <label class="field-label">üí≠ Additional thoughts or notes</label>
            <ion-item lines="none" class="input-item journaling-input">
              <ion-textarea
                formControlName="additionalNotes"
                placeholder="Anything else you'd like to remember about today..."
                rows="4"
                autoGrow="true">
              </ion-textarea>
            </ion-item>
          </div>
        </div>

        <div class="button-row">
          <ion-button fill="outline" (click)="previousStep()" class="back-button">
            Back
          </ion-button>
          <ion-button 
            (click)="saveEmotionCheckin()" 
            [disabled]="!canSave()"
            class="save-button">
            <ion-icon name="heart" slot="start"></ion-icon>
            Save Check-in
          </ion-button>
        </div>
      </div>
    </form>

  </div>
</ion-content>