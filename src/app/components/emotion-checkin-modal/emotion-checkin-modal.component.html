<ion-header>
  <ion-toolbar>
    <ion-title>{{ isInSettingsMode() ? '‚öôÔ∏è Check-in Settings' : 'üíï Emotion Check-In' }}</ion-title>
    <ion-buttons slot="end">
      <ion-button fill="clear" (click)="goToSettings()" *ngIf="!isInSettingsMode()">
        <ion-icon name="settings-outline" slot="icon-only"></ion-icon>
      </ion-button>
      <ion-button fill="clear" (click)="closeModal()">
        <ion-icon name="close" slot="icon-only"></ion-icon>
      </ion-button>
    </ion-buttons>
  </ion-toolbar>
</ion-header>

<ion-content>
  <div class="feed-log-container">
    
    <!-- Progress indicator -->
    <div class="progress-container" *ngIf="!isInSettingsMode()">
      <div class="progress-bar">
        <div class="progress-fill" [style.width.%]="getProgressPercentage()"></div>
      </div>
      <p class="progress-text">Step {{ getCurrentStepNumber() }} of {{ getEnabledStepsCount() }}</p>
    </div>
    
    <!-- Settings indicator -->
    <div class="settings-indicator" *ngIf="isInSettingsMode()">
      <p class="settings-text">Customize your check-in experience</p>
    </div>

    <form [formGroup]="emotionForm" class="feed-form single-form">
      
      <!-- Step 1: Emotional Struggles -->
      <div class="form-section" *ngIf="shouldShowStep(1)">
        <h2 class="section-title">üíô How are you feeling today?</h2>
        <p class="section-description">Select any struggles you're experiencing. It's okay to feel this way - you're not alone.</p>
        
        <div class="feed-type-grid">
          <div 
            *ngFor="let struggle of emotionalStruggles"
            class="feed-type-option"
            [class.selected]="isStruggleSelected(struggle)"
            (click)="toggleStruggle(struggle)">
            <div class="feed-type-icon">
              <span class="emoji-icon">{{ struggle.emoji }}</span>
            </div>
            <div class="feed-type-content">
              <h4>{{ struggle.text }}</h4>
            </div>
            <ion-icon name="checkmark-circle" class="selection-indicator" *ngIf="isStruggleSelected(struggle)"></ion-icon>
          </div>
        </div>
        
        <div class="selection-summary" *ngIf="getSelectedCount('struggles') > 0">
          <p>{{ getSelectedCount('struggles') }} struggle{{ getSelectedCount('struggles') !== 1 ? 's' : '' }} selected</p>
        </div>

        <div class="save-section">
          <ion-button 
            expand="block" 
            (click)="nextStep()" 
            class="save-button">
            Continue
          </ion-button>
        </div>
      </div>

      <!-- Step 2: Positive Moments -->
      <div class="form-section" *ngIf="shouldShowStep(2)">
        <h2 class="section-title">‚ú® What went well today?</h2>
        <p class="section-description">Celebrate the positive moments, no matter how small. You're doing amazing!</p>
        
        <div class="feed-type-grid">
          <div 
            *ngFor="let moment of positiveMoments"
            class="feed-type-option"
            [class.selected]="isPositiveMomentSelected(moment)"
            (click)="togglePositiveMoment(moment)">
            <div class="feed-type-icon">
              <span class="emoji-icon">{{ moment.emoji }}</span>
            </div>
            <div class="feed-type-content">
              <h4>{{ moment.text }}</h4>
            </div>
            <ion-icon name="checkmark-circle" class="selection-indicator" *ngIf="isPositiveMomentSelected(moment)"></ion-icon>
          </div>
        </div>
        
        <div class="selection-summary" *ngIf="getSelectedCount('positive') > 0">
          <p>{{ getSelectedCount('positive') }} positive moment{{ getSelectedCount('positive') !== 1 ? 's' : '' }} selected</p>
        </div>

        <div class="button-row">
          <ion-button fill="outline" (click)="previousStep()" class="back-button">
            Back
          </ion-button>
          <ion-button (click)="nextStep()" class="save-button">
            Continue
          </ion-button>
        </div>
      </div>

      <!-- Step 3: Concerning Thoughts -->
      <div class="form-section concerning-section" *ngIf="shouldShowStep(3)">
        <h2 class="section-title">ü§ó Checking in on difficult thoughts</h2>
        <p class="section-description">These thoughts can be part of the postpartum experience. If any apply, please know that help is available.</p>
        
        <div class="feed-type-grid">
          <div 
            *ngFor="let thought of concerningThoughts"
            class="feed-type-option concerning-option"
            [class.selected]="isConcerningThoughtSelected(thought)"
            [class.critical]="thought.severity === 'critical'"
            (click)="toggleConcerningThought(thought)">
            <div class="feed-type-icon">
              <span class="emoji-icon">{{ thought.emoji }}</span>
            </div>
            <div class="feed-type-content">
              <h4>{{ thought.text }}</h4>
            </div>
            <ion-icon name="checkmark-circle" class="selection-indicator" *ngIf="isConcerningThoughtSelected(thought)"></ion-icon>
          </div>
        </div>
        
        <div class="selection-summary concerning-summary" *ngIf="getSelectedCount('concerning') > 0">
          <div class="crisis-warning" *ngIf="hasCriticalThoughts()">
            <ion-icon name="warning"></ion-icon>
            <p>Immediate support is recommended. Please reach out for help.</p>
          </div>
          <p *ngIf="!hasCriticalThoughts()">{{ getSelectedCount('concerning') }} concerning thought{{ getSelectedCount('concerning') !== 1 ? 's' : '' }} selected</p>
        </div>

        <div class="button-row">
          <ion-button fill="outline" (click)="previousStep()" class="back-button">
            Back
          </ion-button>
          <ion-button (click)="nextStep()" class="save-button">
            Continue
          </ion-button>
        </div>
      </div>

      <!-- Step 4: Journaling & Notes -->
      <div class="form-section notes-section" *ngIf="shouldShowStep(4)">
        <h2 class="section-title">üìù Reflect & Journal</h2>
        <p class="section-description">Take a moment to reflect on your day. Writing can be therapeutic and help process your feelings.</p>
        
        <div class="form-group">
          <label class="field-label">üôè What are you grateful for today?</label>
          <ion-item lines="none" class="input-item notes-input">
            <ion-textarea
              formControlName="gratefulFor"
              placeholder="Even small things count... a smile, a moment of peace, support from someone..."
              rows="3"
              autoGrow="true">
            </ion-textarea>
          </ion-item>
        </div>

        <div class="form-group">
          <label class="field-label">üåü What are you proud of today?</label>
          <ion-item lines="none" class="input-item notes-input">
            <ion-textarea
              formControlName="proudOfToday"
              placeholder="Celebrate your wins, big or small... feeding your baby, asking for help, taking a shower..."
              rows="3"
              autoGrow="true">
            </ion-textarea>
          </ion-item>
        </div>

        <div class="form-group">
          <label class="field-label">üéØ What's one small goal for tomorrow?</label>
          <ion-item lines="none" class="input-item notes-input">
            <ion-textarea
              formControlName="tomorrowGoal"
              placeholder="Something achievable... rest when baby sleeps, call a friend, try a new feeding position..."
              rows="3"
              autoGrow="true">
            </ion-textarea>
          </ion-item>
        </div>

        <div class="form-group">
          <label class="field-label">üí≠ Additional thoughts or notes</label>
          <ion-item lines="none" class="input-item notes-input">
            <ion-textarea
              formControlName="additionalNotes"
              placeholder="Anything else you'd like to remember about today..."
              rows="4"
              autoGrow="true">
            </ion-textarea>
          </ion-item>
        </div>

        <div class="button-row">
          <ion-button fill="outline" (click)="previousStep()" class="back-button">
            Back
          </ion-button>
          <ion-button 
            (click)="saveEmotionCheckin()" 
            [disabled]="!canSave()"
            class="save-button">
            <ion-icon name="heart" slot="start"></ion-icon>
            Save Check-in
          </ion-button>
        </div>
      </div>

      <!-- Settings Step -->
      <div class="form-section" *ngIf="isInSettingsMode()">
        <h2 class="step-title">‚öôÔ∏è Customize Your Check-in</h2>
        <p class="step-description">Enable or disable steps to personalize your emotional check-in experience.</p>
        
        <div class="settings-section" *ngIf="preferencesLoaded">
          <div class="setting-item">
            <div class="setting-info">
              <span class="setting-emoji">üíô</span>
              <div class="setting-text">
                <strong>Emotional Struggles</strong>
                <p>Share how you're feeling and any struggles you're experiencing</p>
              </div>
            </div>
            <ion-toggle 
              [checked]="stepPreferences.step1_struggles"
              (ionChange)="stepPreferences.step1_struggles = $event.detail.checked"
              color="primary">
            </ion-toggle>
          </div>
          
          <div class="setting-item">
            <div class="setting-info">
              <span class="setting-emoji">‚ú®</span>
              <div class="setting-text">
                <strong>Positive Moments</strong>
                <p>Reflect on the good moments and positive experiences</p>
              </div>
            </div>
            <ion-toggle 
              [checked]="stepPreferences.step2_positive"
              (ionChange)="stepPreferences.step2_positive = $event.detail.checked"
              color="primary">
            </ion-toggle>
          </div>
          
          <div class="setting-item">
            <div class="setting-info">
              <span class="setting-emoji">üö®</span>
              <div class="setting-text">
                <strong>Concerning Thoughts</strong>
                <p>Share any concerning thoughts (important for your safety)</p>
              </div>
            </div>
            <ion-toggle 
              [checked]="stepPreferences.step3_concerning"
              (ionChange)="stepPreferences.step3_concerning = $event.detail.checked"
              color="primary">
            </ion-toggle>
          </div>
          
          <div class="setting-item">
            <div class="setting-info">
              <span class="setting-emoji">üìù</span>
              <div class="setting-text">
                <strong>Personal Reflection</strong>
                <p>Journal your thoughts, goals, and what you're grateful for</p>
              </div>
            </div>
            <ion-toggle 
              [checked]="stepPreferences.step4_reflection"
              (ionChange)="stepPreferences.step4_reflection = $event.detail.checked"
              color="primary">
            </ion-toggle>
          </div>
        </div>
        
        <!-- Loading indicator while preferences are being loaded -->
        <div class="loading-preferences" *ngIf="!preferencesLoaded">
          <ion-spinner name="crescent"></ion-spinner>
          <p>Loading settings...</p>
        </div>
        
        <ion-note class="settings-note">
          <ion-icon name="information-circle-outline"></ion-icon>
          At least one step must remain enabled.
        </ion-note>

        <div class="button-row">
          <ion-button fill="outline" (click)="exitSettings()" class="back-button">
            <ion-icon name="arrow-back" slot="start"></ion-icon>
            Back to Check-in
          </ion-button>
          <ion-button (click)="saveSettings()" color="primary" class="save-button">
            <ion-icon name="checkmark" slot="start"></ion-icon>
            Save & Continue
          </ion-button>
        </div>
      </div>
    </form>

  </div>
</ion-content>