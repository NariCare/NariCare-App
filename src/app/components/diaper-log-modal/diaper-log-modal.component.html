<ion-header>
  <ion-toolbar>
    <ion-title>Diaper Change Log</ion-title>
    <ion-buttons slot="end">
      <ion-button fill="clear" (click)="closeModal()">
        <ion-icon name="close" slot="icon-only"></ion-icon>
      </ion-button>
    </ion-buttons>
  </ion-toolbar>
</ion-header>

<ion-content>
  <div class="feed-log-container">
    <form [formGroup]="diaperForm" class="feed-form single-form">
      
      <!-- Selected Baby Info (when baby is pre-selected) -->
      <div class="form-section selected-baby-info" *ngIf="selectedBabyLocal && !shouldShowBabySelection()">
        <div class="selected-baby-display">
          <div class="baby-avatar">
            <app-custom-icon [babyGender]="selectedBabyLocal?.gender || 'male'" size="32px"></app-custom-icon>
          </div>
          <div class="baby-info">
            <h3>{{ selectedBabyLocal.name }}</h3>
            <p>{{ calculateBabyAge(selectedBabyLocal) }}</p>
          </div>
          <ion-icon name="checkmark-circle" class="selected-icon"></ion-icon>
        </div>
      </div>
      
      <!-- Baby Selection (only if multiple babies and no baby pre-selected) -->
      <div class="form-section baby-selection" *ngIf="shouldShowBabySelection()">
        <h2 class="section-title">Select Baby</h2>
        <p class="section-description">Which baby are you logging this diaper change for?</p>
        
        <div class="baby-selection-grid">
          <div 
            *ngFor="let baby of user.babies"
            class="baby-option"
            [class.selected]="selectedBabyLocal?.id === baby.id"
            (click)="selectBaby(baby)">
            <div class="baby-avatar">
              <app-custom-icon [babyGender]="baby.gender" size="32px"></app-custom-icon>
            </div>
            <div class="baby-info">
              <h3>{{ baby.name }}</h3>
              <p>{{ calculateBabyAge(baby) }}</p>
            </div>
            <ion-icon name="checkmark-circle" class="selected-icon" *ngIf="selectedBabyLocal?.id === baby.id"></ion-icon>
          </div>
        </div>
      </div>

      <!-- Main Diaper Change Card -->
      <div class="form-section main-diaper-card">
        
        <!-- Date Selection -->
        <div class="section-group">
          <h2 class="section-title">Date</h2>
          <p class="section-description">When did this diaper change occur?</p>
          
          <div class="date-selection-container">
            <div class="date-options-grid">
              <ion-button 
                *ngFor="let option of dateOptions"
                fill="outline" 
                size="small"
                (click)="selectDateOption(option.value)"
                [class.selected]="selectedDateOption === option.value"
                class="date-option-button">
                {{ option.label }}
              </ion-button>
            </div>
            
            <!-- Custom Date Picker - Only shown when "Other" is selected -->
            <div class="custom-date-picker" *ngIf="showDatePicker && selectedDateOption === 'other'">
              <ion-item lines="none" class="input-item date-input">
                <ion-label position="stacked">Select Date</ion-label>
                <ion-datetime
                  formControlName="date"
                  presentation="date"
                  [max]="getCurrentDate()"
                  (ionChange)="onDateChange($event)">
                </ion-datetime>
              </ion-item>
            </div>
          </div>
        </div>

        <!-- Change Type Selection -->
        <div class="section-group">
          <h2 class="section-title">Change Type</h2>
          <p class="section-description">What type of diaper change was it?</p>
          
          <div class="feed-type-grid">
            <div 
              *ngFor="let changeType of changeTypeOptions"
              class="feed-type-option"
              [class.selected]="selectedChangeType === changeType.value"
              (click)="selectChangeType(changeType.value)">
              <div class="feed-type-icon">
                <span class="emoji-icon">{{ changeType.icon }}</span>
              </div>
              <div class="feed-type-content">
                <h4>{{ changeType.label }}</h4>
                <!-- <p>{{ changeType.description }}</p> -->
              </div>
              <ion-icon name="checkmark-circle" class="selection-indicator" *ngIf="selectedChangeType === changeType.value"></ion-icon>
            </div>
          </div>
        </div>

        <!-- Wetness Level (only for pee or both) -->
        <div class="section-group" *ngIf="shouldShowWetnessStep() && selectedChangeType">
          <h2 class="section-title">Wetness Level</h2>
          <p class="section-description">How wet was the diaper?</p>
          
          <div class="selection-grid wetness-level-grid">
            <div 
              *ngFor="let wetness of wetnessOptions"
              class="selection-option"
              [class.selected]="selectedWetness === wetness.value"
              (click)="selectWetness(wetness.value)">
              <div class="option-icon">
                <ion-icon name="water" [class]="'wetness-' + wetness.value"></ion-icon>
              </div>
              <span class="option-label">{{ wetness.label }}</span>
            </div>
          </div>
        </div>

      </div>

      <!-- Notes Section - Separate Card -->
      <div class="form-section notes-section">
        <h2 class="section-title">Notes</h2>
        <p class="section-description">Add any additional details about the diaper change (optional)</p>

        <div class="form-group">
          <label class="field-label">Your Notes</label>
          <ion-item lines="none" class="input-item notes-input">
            <ion-textarea
              formControlName="notes"
              placeholder="Write any additional details about the diaper change..."
              rows="4"
              autoGrow="true">
            </ion-textarea>
          </ion-item>
        </div>
        
        <!-- Quick Notes Section -->
        <div class="quick-notes-section">
          <div class="predefined-notes-grid">
            <ion-chip 
              *ngFor="let note of predefinedNotes"
              [class.note-red]="note.indicator === 'red'"
              [class.note-yellow]="note.indicator === 'yellow'"
              [class.selected]="isPredefinedNoteSelected(note)"
              (click)="appendPredefinedNote(note)"
              class="predefined-note-chip">
              <ion-icon name="checkmark-circle" class="note-selected-icon" *ngIf="isPredefinedNoteSelected(note)"></ion-icon>
              {{ note.text }}
            </ion-chip>
          </div>
        </div>
      </div>

      <!-- Save Button -->
      <div class="form-section save-section">
        <ion-button 
          expand="block"
          (click)="saveDiaperLog()" 
          [disabled]="!canSave() || isSubmitting"
          class="save-button">
          <ion-spinner slot="start" *ngIf="isSubmitting"></ion-spinner>
          <ion-icon name="save" slot="start" *ngIf="!isSubmitting"></ion-icon>
          {{ isSubmitting ? 'Saving...' : 'Save Diaper Change' }}
        </ion-button>
      </div>
    </form>
  </div>
</ion-content>