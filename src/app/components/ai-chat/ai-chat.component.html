<div class="ai-chat-container">
  <!-- AI Header -->
  <div class="ai-header">
    <div class="ai-avatar">
      <ion-icon name="chatbot"></ion-icon>
    </div>
    <div class="ai-info">
      <h3>AI Lactation Assistant</h3>
      <p>Get instant help with breastfeeding questions</p>
    </div>
  </div>

  <!-- Medical Disclaimer -->
  <div class="medical-disclaimer" *ngIf="showDisclaimer">
    <ion-icon name="warning" color="warning"></ion-icon>
    <div class="disclaimer-text">
      <strong>Medical Disclaimer:</strong> This AI provides educational information only. Always consult with a lactation consultant, pediatrician, or healthcare provider for personalized medical advice and concerns.
    </div>
    <ion-button 
      fill="clear" 
      size="small"
      (click)="hideDisclaimer()"
      class="close-disclaimer-button">
      <ion-icon name="close" slot="icon-only"></ion-icon>
    </ion-button>
  </div>


  <!-- Messages Container -->
  <div class="messages-container" #messagesContainer>
    <!-- Loading State -->
    <div class="loading-state" *ngIf="isInitializing">
      <div class="loading-avatar">
        <ion-icon name="chatbot"></ion-icon>
      </div>
      <div class="loading-content">
        <div class="loading-bubble">
          <div class="loading-dots">
            <span></span>
            <span></span>
            <span></span>
          </div>
        </div>
        <span class="loading-text">Initializing AI Assistant...</span>
      </div>
    </div>

    <!-- Messages -->
    <div 
      *ngFor="let message of chatbotMessages$ | async"
      class="message"
      [class.user-message]="message.sender === 'user'"
      [class.bot-message]="message.sender === 'bot'"
      [class.typing]="message.isTyping"
      [class.duplicate-hidden]="message.isTyping && hasMultipleTypingMessages()">
      
      <div class="message-avatar" *ngIf="message.sender === 'bot'">
        <ion-icon name="chatbot"></ion-icon>
      </div>
      
      <div class="message-content">

        <div class="message-bubble">
          <div *ngIf="!message.isTyping" class="message-text">
            <div *ngIf="message.formattedContent?.formatting?.sections; else simpleContent">
              <div *ngFor="let section of message.formattedContent.formatting.sections" class="content-section">
                <h4 *ngIf="section.title" class="section-title">{{ section.title }}</h4>
                <div [ngSwitch]="section.type">
                  <p *ngSwitchCase="'text'" [innerHTML]="formatText(section.content)"></p>
                  <ul *ngSwitchCase="'list'" class="message-list">
                    <li *ngFor="let item of parseListItems(section.content)" [innerHTML]="formatText(item)"></li>
                  </ul>
                  <div *ngSwitchCase="'callout'" class="message-callout" [innerHTML]="formatText(section.content)"></div>
                </div>
              </div>
            </div>
            <ng-template #simpleContent>
              <div [innerHTML]="formatText(message.content)"></div>
            </ng-template>
          </div>
          <div class="typing-indicator" *ngIf="message.isTyping">
            <span></span>
            <span></span>
            <span></span>
          </div>
        </div>
        
        <!-- Follow-up Options -->
        <div *ngIf="message.followUpOptions && message.followUpOptions.length > 0" class="follow-up-options">
          <ion-button 
            *ngFor="let option of message.followUpOptions"
            fill="outline" 
            size="small"
            (click)="handleFollowUpAction(option.action, option.text)"
            class="follow-up-button">
            {{ option.text }}
          </ion-button>
        </div>
        
        <!-- Message Attachments -->
        <div class="message-attachments" *ngIf="message.attachments && message.attachments.length > 0">
          <div *ngFor="let attachment of message.attachments" class="attachment-item">
            
            <!-- Image Attachment -->
            <div *ngIf="attachment.type === 'image'" class="image-attachment">
              <img [src]="attachment.url" [alt]="attachment.title || 'Shared image'" class="attachment-image">
              <p *ngIf="attachment.title" class="attachment-title">{{ attachment.title }}</p>
            </div>
            
            <!-- Video Attachment -->
            <div *ngIf="attachment.type === 'video'" class="video-attachment" (click)="openVideoModal(attachment)">
              <div class="video-thumbnail">
                <img [src]="getYouTubeThumbnail(attachment.url)" [alt]="attachment.title || 'Video thumbnail'" *ngIf="getYouTubeThumbnail(attachment.url)">
                <div class="video-placeholder" *ngIf="!getYouTubeThumbnail(attachment.url)">
                  <ion-icon name="videocam"></ion-icon>
                </div>
                <div class="play-overlay">
                  <ion-icon name="play"></ion-icon>
                </div>
              </div>
              <div class="video-info">
                <h5 *ngIf="attachment.title">{{ attachment.title }}</h5>
                <p *ngIf="attachment.description">{{ attachment.description }}</p>
                <span class="video-url">{{ attachment.url }}</span>
              </div>
            </div>
            
          </div>
        </div>
        
        <span class="message-time">{{ getMessageTime(message.timestamp) }}</span>
      </div>
      
      <div class="message-avatar user-avatar" *ngIf="message.sender === 'user'">
        <ion-icon name="person"></ion-icon>
      </div>
    </div>

    <!-- Expert Help Banner -->
    <div class="expert-help-banner" *ngIf="shouldShowExpertBanner()">
      <div class="banner-content">
        <ion-icon name="people"></ion-icon>
        <div class="banner-text">
          <h4>Need personalized help?</h4>
        </div>
      </div>
      <div class="banner-actions">
        <ion-button 
          fill="clear" 
          size="small" 
          (click)="dismissExpertBanner()"
          class="dismiss-button">
          <ion-icon name="close" slot="icon-only"></ion-icon>
        </ion-button>
        <ion-button fill="outline" size="small" (click)="requestExpertHelp()">
          Get Expert Help
        </ion-button>
      </div>
    </div>
  </div>

  <!-- Expert Quick Access Panel -->
  <div class="expert-quick-access-panel" *ngIf="isExpert() && showQuickAccess">
    <div class="panel-header">
      <h4>Quick Access</h4>
      <ion-button fill="clear" size="small" (click)="showQuickAccess = false">
        <ion-icon name="close" slot="icon-only"></ion-icon>
      </ion-button>
    </div>
    
    <div class="panel-content">
      <!-- Quick Notes -->
      <div class="quick-section" *ngIf="quickAccessNotes.length > 0">
        <h5>üìù Quick Notes</h5>
        <div class="quick-items">
          <div 
            *ngFor="let note of quickAccessNotes" 
            class="quick-item note-quick-item"
            (click)="insertNoteIntoMessage(note)">
            <div class="item-header">
              <ion-icon [name]="getCategoryIcon(note.category, 'note')" [color]="getCategoryColor(note.category, 'note')"></ion-icon>
              <span class="item-title">{{ note.title }}</span>
              <ion-icon *ngIf="note.is_favorite" name="star" color="warning" class="favorite-icon"></ion-icon>
            </div>
            <div class="item-preview">{{ note.content | slice:0:60 }}{{ note.content.length > 60 ? '...' : '' }}</div>
            <div class="item-category">{{ getCategoryLabel(note.category, 'note') }}</div>
          </div>
        </div>
      </div>

      <!-- Quick Links -->
      <div class="quick-section" *ngIf="quickAccessLinks.length > 0">
        <h5>üîó Quick Links</h5>
        <div class="quick-items">
          <div 
            *ngFor="let link of quickAccessLinks" 
            class="quick-item link-quick-item"
            (click)="insertLinkIntoMessage(link)">
            <div class="item-header">
              <ion-icon [name]="getCategoryIcon(link.category, 'link')" [color]="getCategoryColor(link.category, 'link')"></ion-icon>
              <span class="item-title">{{ link.title }}</span>
              <ion-icon *ngIf="link.is_favorite" name="star" color="warning" class="favorite-icon"></ion-icon>
            </div>
            <div class="item-preview" *ngIf="link.description">{{ link.description | slice:0:60 }}{{ link.description && link.description.length > 60 ? '...' : '' }}</div>
            <div class="item-category">{{ getCategoryLabel(link.category, 'link') }}</div>
          </div>
        </div>
      </div>

      <div class="panel-footer" *ngIf="quickAccessNotes.length === 0 && quickAccessLinks.length === 0">
        <p>No quick access items available. Create notes and links in your dashboard.</p>
      </div>
    </div>
  </div>

  <!-- Message Input -->
  <div class="message-input-container fixed-bottom" #messageInputContainer>
    <div class="message-input">
      <ion-button 
        fill="clear" 
        size="small"
        (click)="openAttachmentMenu()"
        class="attachment-button">
        <ion-icon name="attach" slot="icon-only"></ion-icon>
      </ion-button>
      <ion-button 
        *ngIf="isExpert()"
        fill="clear" 
        size="small"
        (click)="toggleQuickAccess()"
        [class.active]="showQuickAccess"
        class="expert-notes-button">
        <ion-icon name="library" slot="icon-only"></ion-icon>
      </ion-button>
      <ion-textarea
        [(ngModel)]="messageText"
        placeholder="Ask about breastfeeding, baby care, or any concerns..."
        rows="1"
        autoGrow="true"
        maxlength="500"
        (keydown)="onKeyDown($event)"
        class="message-textarea">
      </ion-textarea>
      <ion-button 
        fill="clear" 
        (click)="sendMessage()"
        [disabled]="!messageText?.trim()"
        class="send-button">
        <ion-icon name="send" slot="icon-only"></ion-icon>
      </ion-button>
    </div>
  </div>
</div>